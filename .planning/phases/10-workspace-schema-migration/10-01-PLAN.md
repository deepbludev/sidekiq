---
phase: 10-workspace-schema-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/shared/db/schema.ts
autonomous: true

must_haves:
  truths:
    - "Schema defines workspace, workspace_member, workspace_invite tables (not team tables)"
    - "workspaceTypeEnum exists with 'personal' and 'team' values"
    - "workspaceRoleEnum exists with 'owner', 'admin', 'member' values"
    - "threads table has a workspaceId column with NOT NULL FK to workspace"
    - "sidekiqs table has workspaceId column (renamed from teamId)"
    - "Partial unique index enforces one personal workspace per user"
  artifacts:
    - path: "sidekiq-webapp/src/shared/db/schema.ts"
      provides: "All workspace table definitions, enums, relations, indexes"
      contains: "workspaces"
  key_links:
    - from: "sidekiq-webapp/src/shared/db/schema.ts"
      to: "workspaces table"
      via: "pgTable definition"
      pattern: 'pgTable\\("workspace"'
    - from: "sidekiq-webapp/src/shared/db/schema.ts"
      to: "threads.workspaceId"
      via: "FK column"
      pattern: "workspaceId.*references.*workspaces"
---

<objective>
Update the Drizzle ORM schema from the team model to the workspace model.

Purpose: This is the foundation for the entire Phase 10 migration. Every other plan depends on these schema changes being correct. The schema defines the workspace data model that will replace teams.

Output: Updated `schema.ts` with renamed tables, new enums, new columns, updated relations, and new indexes.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-workspace-schema-migration/10-CONTEXT.md
@.planning/phases/10-workspace-schema-migration/10-RESEARCH.md
@sidekiq-webapp/src/shared/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename team tables, enums, and columns to workspace equivalents</name>
  <files>sidekiq-webapp/src/shared/db/schema.ts</files>
  <action>
  Update `sidekiq-webapp/src/shared/db/schema.ts` with ALL of the following changes. Do them in a single file edit -- this is the complete schema transformation.

  **Enum renames:**
  - `teamRoleEnum` variable name -> `workspaceRoleEnum`, but keep pgEnum name change: `pgEnum("workspace_role", ["owner", "admin", "member"])` (values unchanged)
  - Add new: `export const workspaceTypeEnum = pgEnum("workspace_type", ["personal", "team"]);`

  **Table renames (Drizzle variable name AND pgTable string):**
  - `teams` -> `workspaces`, pgTable("team") -> pgTable("workspace")
  - `teamMembers` -> `workspaceMembers`, pgTable("team_member") -> pgTable("workspace_member")
  - `teamInvites` -> `workspaceInvites`, pgTable("team_invite") -> pgTable("workspace_invite")

  **New columns on workspaces table:**
  - `type: workspaceTypeEnum("type").notNull()` -- the personal/team discriminator
  - `description: varchar("description", { length: 500 })` -- nullable, optional workspace description
  - Keep all existing columns: id, name, ownerId, avatar, memberLimit, stripeCustomerId (if exists), stripeSubscriptionId (if exists), createdAt, updatedAt

  **New column on threads table:**
  - `workspaceId: text("workspace_id").notNull().references(() => workspaces.id, { onDelete: "cascade" })` -- every thread belongs to a workspace

  **Column renames in child tables:**
  - `sidekiqs.teamId` -> `sidekiqs.workspaceId` with column name `"workspace_id"`, FK pointing to `workspaces.id` (keep onDelete: "set null")
  - `workspaceMembers.teamId` -> `workspaceMembers.workspaceId` with column name `"workspace_id"`
  - `workspaceInvites.teamId` -> `workspaceInvites.workspaceId` with column name `"workspace_id"`

  **Index updates on workspaces table:**
  - Rename `team_owner_idx` -> `workspace_owner_idx` on `ownerId`
  - Add `workspace_type_idx` on `type`
  - Add partial unique index: `uniqueIndex("workspace_personal_unique").on(t.ownerId).where(sql\`"type" = 'personal'\`)` -- enforces exactly one personal workspace per user

  **Index updates on workspaceMembers table:**
  - `team_member_team_idx` -> `workspace_member_workspace_idx` on `workspaceId`
  - `team_member_user_idx` -> `workspace_member_user_idx` on `userId`
  - `team_member_unique` -> `workspace_member_unique` on `(workspaceId, userId)`
  - Role reference: `teamRoleEnum` -> `workspaceRoleEnum`

  **Index updates on workspaceInvites table:**
  - `team_invite_team_idx` -> `workspace_invite_workspace_idx` on `workspaceId`
  - `team_invite_email_idx` -> `workspace_invite_email_idx` on `email`
  - `team_invite_token_idx` -> `workspace_invite_token_idx` on `token`
  - Role reference: `teamRoleEnum` -> `workspaceRoleEnum`

  **Index updates on sidekiqs table:**
  - `sidekiq_team_idx` -> `sidekiq_workspace_idx` on `workspaceId`

  **New index on threads table:**
  - `thread_workspace_idx` on `workspaceId`

  **Relation updates:**
  - `teamRelations` -> `workspaceRelations`: `relations(workspaces, ({ one, many }) => ({ owner: one(user, ...), members: many(workspaceMembers), invites: many(workspaceInvites), sidekiqs: many(sidekiqs), threads: many(threads) }))`
  - `teamMemberRelations` -> `workspaceMemberRelations`: update to reference `workspaceMembers.workspaceId` -> `workspaces.id`, field name: `workspace` (not `team`)
  - `teamInviteRelations` -> `workspaceInviteRelations`: update to reference `workspaceInvites.workspaceId` -> `workspaces.id`, field name: `workspace` (not `team`)
  - `sidekiqRelations`: change `team: one(teams, ...)` -> `workspace: one(workspaces, { fields: [sidekiqs.workspaceId], references: [workspaces.id] })`
  - `threadRelations`: add `workspace: one(workspaces, { fields: [threads.workspaceId], references: [workspaces.id] })`
  - `userRelations`: `ownedTeams: many(teams)` -> `ownedWorkspaces: many(workspaces)`, `teamMemberships: many(teamMembers)` -> `workspaceMemberships: many(workspaceMembers)`

  **JSDoc updates:**
  - Update all JSDoc comments from "Teams" to "Workspaces", "Team Members" to "Workspace Members", etc.

  **IMPORTANT:** Do NOT touch the `user`, `session`, `account`, `verification`, or `messages` tables. Only modify team-related tables + add workspaceId to threads + add workspaceId to sidekiqs (rename from teamId).
  </action>
  <verify>
  Run `cd sidekiq-webapp && npx tsc --noEmit 2>&1 | head -50` to check for TypeScript errors in the schema file itself. Expect MANY errors from files that still reference old names (router, validations, etc.) -- that's expected and will be fixed in Plans 02-05. The key check: the schema file itself has no syntax errors.

  Verify by grep:
  - `grep -c "team" src/shared/db/schema.ts` should return 0 (no remaining team references except in the workspaceTypeEnum value "team")
  - `grep "pgTable" src/shared/db/schema.ts` should show workspace, workspace_member, workspace_invite (not team, team_member, team_invite)
  - `grep "workspaceTypeEnum" src/shared/db/schema.ts` should match
  - `grep "workspace_personal_unique" src/shared/db/schema.ts` should match
  </verify>
  <done>
  schema.ts contains:
  1. workspaceTypeEnum with "personal" and "team" values
  2. workspaceRoleEnum (renamed from teamRoleEnum)
  3. workspaces table (renamed from teams) with type and description columns
  4. workspaceMembers table (renamed from teamMembers) with workspaceId
  5. workspaceInvites table (renamed from teamInvites) with workspaceId
  6. sidekiqs.workspaceId (renamed from teamId)
  7. threads.workspaceId (new, NOT NULL, FK to workspace)
  8. Partial unique index workspace_personal_unique on (ownerId) WHERE type='personal'
  9. All relations updated to reference workspace tables
  10. No remaining "team" references in table/column names (only "team" as an enum value in workspaceTypeEnum)
  </done>
</task>

</tasks>

<verification>
- schema.ts compiles without syntax errors (TypeScript errors from downstream files are expected)
- All Drizzle table definitions use "workspace" naming
- workspaceTypeEnum exists with personal/team values
- threads table has workspaceId NOT NULL FK
- Partial unique index for personal workspace enforcement exists
</verification>

<success_criteria>
The schema file is the single source of truth for the database model. After this plan:
- The Drizzle schema defines workspaces (not teams) as the organizational unit
- Every content table (threads, sidekiqs) has a workspaceId foreign key
- The personal workspace uniqueness constraint exists at the database level
- All relations are updated for the new workspace model
</success_criteria>

<output>
After completion, create `.planning/phases/10-workspace-schema-migration/10-01-SUMMARY.md`
</output>
