---
phase: 10-workspace-schema-migration
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - sidekiq-webapp/src/features/workspace/api/router.ts
  - sidekiq-webapp/src/features/workspace/validations.ts
  - sidekiq-webapp/src/features/workspace/lib/permissions.ts
  - sidekiq-webapp/src/features/workspace/api/emails.ts
autonomous: true

must_haves:
  truths:
    - "workspaceRouter is exported (not teamRouter)"
    - "All validation schemas use Workspace naming (createWorkspaceSchema, etc.)"
    - "WorkspaceRole type exported from permissions module"
    - "sendWorkspaceInviteEmail function exported from emails module"
    - "Router references workspaces, workspaceMembers, workspaceInvites schema tables"
  artifacts:
    - path: "sidekiq-webapp/src/features/workspace/api/router.ts"
      provides: "Workspace CRUD router with all 13 procedures"
      exports: ["workspaceRouter"]
    - path: "sidekiq-webapp/src/features/workspace/validations.ts"
      provides: "Zod validation schemas for workspace operations"
      exports: ["createWorkspaceSchema"]
    - path: "sidekiq-webapp/src/features/workspace/lib/permissions.ts"
      provides: "Workspace role permissions"
      exports: ["WorkspaceRole"]
    - path: "sidekiq-webapp/src/features/workspace/api/emails.ts"
      provides: "Workspace invite email sender"
      exports: ["sendWorkspaceInviteEmail"]
  key_links:
    - from: "sidekiq-webapp/src/features/workspace/api/router.ts"
      to: "sidekiq-webapp/src/shared/db/schema.ts"
      via: "import { workspaces, workspaceMembers, workspaceInvites }"
      pattern: "workspaces.*workspaceMembers.*workspaceInvites"
    - from: "sidekiq-webapp/src/features/workspace/api/router.ts"
      to: "sidekiq-webapp/src/features/workspace/validations.ts"
      via: "import validation schemas"
      pattern: "createWorkspaceSchema"
---

<objective>
Rename the entire server-side API layer from team to workspace naming.

Purpose: The router, validations, permissions, and email utility form the server API surface. All tRPC procedures must use workspace naming so the client can call `api.workspace.*` instead of `api.team.*`.

Output: Renamed router (workspaceRouter), validation schemas (createWorkspaceSchema, etc.), permissions (WorkspaceRole), and email utility (sendWorkspaceInviteEmail).
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-workspace-schema-migration/10-CONTEXT.md
@.planning/phases/10-workspace-schema-migration/10-RESEARCH.md
@.planning/phases/10-workspace-schema-migration/10-01-SUMMARY.md
@sidekiq-webapp/src/features/workspace/api/router.ts
@sidekiq-webapp/src/features/workspace/validations.ts
@sidekiq-webapp/src/features/workspace/lib/permissions.ts
@sidekiq-webapp/src/features/workspace/api/emails.ts
@sidekiq-webapp/src/shared/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename workspace router from team to workspace</name>
  <files>sidekiq-webapp/src/features/workspace/api/router.ts</files>
  <action>
  Perform a comprehensive team->workspace rename in `sidekiq-webapp/src/features/workspace/api/router.ts`:

  **Import renames:**
  - `createTeamSchema` -> `createWorkspaceSchema`
  - `updateTeamSchema` -> `updateWorkspaceSchema`
  - `deleteTeamSchema` -> `deleteWorkspaceSchema`
  - `getTeamByIdSchema` -> `getWorkspaceByIdSchema`
  - `inviteMemberSchema` -- keep as-is (member operations are not team-specific)
  - `acceptInviteSchema` -- keep as-is
  - `revokeInviteSchema` -- keep as-is
  - `resendInviteSchema` -- keep as-is
  - `removeMemberSchema` -- keep as-is (rename teamId field to workspaceId inside)
  - `changeRoleSchema` -- keep as-is (rename teamId field to workspaceId inside)
  - `transferOwnershipSchema` -- keep as-is (rename teamId field to workspaceId inside)
  - `leaveTeamSchema` -> `leaveWorkspaceSchema`
  - `type TeamRole` -> `type WorkspaceRole`
  - `sendTeamInviteEmail` -> `sendWorkspaceInviteEmail`
  - Schema imports: `teams` -> `workspaces`, `teamMembers` -> `workspaceMembers`, `teamInvites` -> `workspaceInvites`

  **Constants:**
  - `MAX_PENDING_INVITES_PER_TEAM` -> `MAX_PENDING_INVITES_PER_WORKSPACE`

  **Helper function:**
  - `getUserTeamRole` -> `getUserWorkspaceRole`
  - Parameter `teamId` -> `workspaceId`
  - `db.query.teamMembers` -> `db.query.workspaceMembers`
  - `eq(teamMembers.teamId, ...)` -> `eq(workspaceMembers.workspaceId, ...)`
  - `eq(teamMembers.userId, ...)` -> `eq(workspaceMembers.userId, ...)`
  - Return type: `TeamRole | null` -> `WorkspaceRole | null`

  **Router export:**
  - `export const teamRouter = createTRPCRouter({` -> `export const workspaceRouter = createTRPCRouter({`

  **All procedures -- comprehensive find/replace within each:**
  - Every `teamId` variable/parameter -> `workspaceId`
  - Every `ctx.db.query.teamMembers` -> `ctx.db.query.workspaceMembers`
  - Every `ctx.db.query.teamInvites` -> `ctx.db.query.workspaceInvites`
  - Every `ctx.db.query.teams` -> `ctx.db.query.workspaces`
  - Every `eq(teamMembers.teamId, ...)` -> `eq(workspaceMembers.workspaceId, ...)`
  - Every `eq(teamInvites.teamId, ...)` -> `eq(workspaceInvites.workspaceId, ...)`
  - Every `eq(teams.id, ...)` -> `eq(workspaces.id, ...)`
  - Every `.insert(teamMembers)` -> `.insert(workspaceMembers)`
  - Every `.insert(teamInvites)` -> `.insert(workspaceInvites)`
  - Every `.insert(teams)` -> `.insert(workspaces)`
  - Every `.update(teams)` -> `.update(workspaces)`
  - Every `.update(teamMembers)` -> `.update(workspaceMembers)`
  - Every `.update(teamInvites)` -> `.update(workspaceInvites)`
  - Every `.delete(teams)` -> `.delete(workspaces)`
  - Every `.delete(teamMembers)` -> `.delete(workspaceMembers)`
  - Every `.delete(teamInvites)` -> `.delete(workspaceInvites)`
  - Every `.from(teamMembers)` -> `.from(workspaceMembers)`
  - Every `.from(teamInvites)` -> `.from(workspaceInvites)`
  - `{ team: true }` in with clauses -> `{ workspace: true }` (matches relation name from schema)
  - `invite.team` -> `invite.workspace`
  - `m.team` -> `m.workspace`

  **Error messages:**
  - "Team not found" -> "Workspace not found"
  - "Only owners and admins can update team settings" -> "Only owners and admins can update workspace settings"
  - "Only the team owner can delete the team" -> "Only the workspace owner can delete the workspace"
  - "This user is already a member of the team" -> "This user is already a member of the workspace"
  - "Team has reached the member limit" -> "Workspace has reached the member limit"
  - "You are not a member of this team" -> "You are not a member of this workspace"
  - "Owner cannot leave the team. Transfer ownership first." -> "Owner cannot leave the workspace. Transfer ownership first."
  - "User is not a member of this team" -> "User is not a member of this workspace"
  - "You are already a member of this team" -> "You are already a member of this workspace"
  - "This invite was sent to a different email address" -- keep as-is

  **JSDoc comments:** Update all from "team" to "workspace" terminology.

  **The create procedure** currently does NOT set `type`. Add `type: "team"` to the insert values (only team-type workspaces are created via UI; personal workspaces are created by databaseHooks):
  ```typescript
  .insert(workspaces)
  .values({
    id: workspaceId,
    name: input.name,
    type: "team",  // <-- ADD THIS
    ownerId: ctx.session.user.id,
    avatar: input.avatar,
  })
  ```

  **The list procedure's relation join:**
  The `with: { team: true }` must become `with: { workspace: true }` and the mapping `m.team` -> `m.workspace`. This matches the relation field name in workspaceMemberRelations.

  **SQL template literals:**
  - `teamMembers.role` -> `workspaceMembers.role` in CASE expressions
  </action>
  <verify>
  - `grep -c "team" sidekiq-webapp/src/features/workspace/api/router.ts` should be 0 or very small (only "team" as a string value in workspaceTypeEnum)
  - `grep "workspaceRouter" sidekiq-webapp/src/features/workspace/api/router.ts` matches
  - `grep "getUserWorkspaceRole" sidekiq-webapp/src/features/workspace/api/router.ts` matches
  - `grep 'type: "team"' sidekiq-webapp/src/features/workspace/api/router.ts` matches (in the create procedure)
  </verify>
  <done>
  Router exports `workspaceRouter` with all 13 procedures using workspace naming, workspace schema tables, and workspace error messages. The create procedure sets `type: "team"` for new workspaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rename validations, permissions, and email utility</name>
  <files>
    sidekiq-webapp/src/features/workspace/validations.ts
    sidekiq-webapp/src/features/workspace/lib/permissions.ts
    sidekiq-webapp/src/features/workspace/api/emails.ts
  </files>
  <action>
  **validations.ts -- full rename:**
  - `teamAvatarSchema` -> `workspaceAvatarSchema`
  - `TeamAvatar` type -> `WorkspaceAvatar`
  - `createTeamSchema` -> `createWorkspaceSchema` (update error messages: "Team name" -> "Workspace name")
  - `CreateTeamInput` -> `CreateWorkspaceInput`
  - `updateTeamSchema` -> `updateWorkspaceSchema` (update error messages: "Team ID" -> "Workspace ID")
  - `UpdateTeamInput` -> `UpdateWorkspaceInput`
  - `deleteTeamSchema` -> `deleteWorkspaceSchema`
  - `DeleteTeamInput` -> `DeleteWorkspaceInput`
  - `inviteMemberSchema` -- rename `teamId` field to `workspaceId`, update error message "Team ID" -> "Workspace ID"
  - `InviteMemberInput` -- keep name (generic)
  - `removeMemberSchema` -- rename `teamId` field to `workspaceId`
  - `RemoveMemberInput` -- keep name
  - `changeRoleSchema` -- rename `teamId` field to `workspaceId`
  - `ChangeRoleInput` -- keep name
  - `transferOwnershipSchema` -- rename `teamId` field to `workspaceId`
  - `TransferOwnershipInput` -- keep name
  - `leaveTeamSchema` -> `leaveWorkspaceSchema` -- rename `teamId` field to `workspaceId`
  - `LeaveTeamInput` -> `LeaveWorkspaceInput`
  - `getTeamByIdSchema` -> `getWorkspaceByIdSchema` -- update error message
  - `GetTeamByIdInput` -> `GetWorkspaceByIdInput`
  - All JSDoc: "team" -> "workspace"

  **permissions.ts -- rename type only:**
  - `TeamRole` -> `WorkspaceRole`
  - All function signatures: `TeamRole | null` -> `WorkspaceRole | null`
  - JSDoc: Update "team" references to "workspace" where appropriate. Keep function names as-is (canInvite, canRemoveMember, canChangeRole, canTransferOwnership, canDeleteTeam, canLeaveTeam, canRevokeInvite, canUpdateTeam -- rename canDeleteTeam -> canDeleteWorkspace, canLeaveTeam -> canLeaveWorkspace, canUpdateTeam -> canUpdateWorkspace)
  - `getRoleIcon` and `getRoleLabel` -- update JSDoc but keep function names

  **emails.ts -- rename function and types:**
  - `SendTeamInviteEmailParams` -> `SendWorkspaceInviteEmailParams`
  - `teamName` param -> `workspaceName`
  - `sendTeamInviteEmail` -> `sendWorkspaceInviteEmail`
  - Console logs: `[Team]` -> `[Workspace]`
  - Email subject: "join ${teamName}" -> "join ${workspaceName}"
  - Email body: "join their team" -> "join their workspace", "team on Sidekiq" -> "workspace on Sidekiq"
  - HTML content: Update "team" text to "workspace"
  - JSDoc: "Team invitation email" -> "Workspace invitation email"
  </action>
  <verify>
  - `grep "TeamRole" sidekiq-webapp/src/features/workspace/lib/permissions.ts` returns 0 (replaced by WorkspaceRole)
  - `grep "WorkspaceRole" sidekiq-webapp/src/features/workspace/lib/permissions.ts` returns matches
  - `grep "createTeamSchema" sidekiq-webapp/src/features/workspace/validations.ts` returns 0
  - `grep "createWorkspaceSchema" sidekiq-webapp/src/features/workspace/validations.ts` returns a match
  - `grep "sendTeamInviteEmail" sidekiq-webapp/src/features/workspace/api/emails.ts` returns 0
  - `grep "sendWorkspaceInviteEmail" sidekiq-webapp/src/features/workspace/api/emails.ts` returns a match
  - `grep "teamId" sidekiq-webapp/src/features/workspace/validations.ts` returns 0 (all renamed to workspaceId)
  </verify>
  <done>
  All three files use workspace naming:
  1. validations.ts exports createWorkspaceSchema and all other Workspace* schemas with workspaceId fields
  2. permissions.ts exports WorkspaceRole type and workspace-named permission functions
  3. emails.ts exports sendWorkspaceInviteEmail with workspace terminology in email content
  </done>
</task>

</tasks>

<verification>
- workspaceRouter exported from router.ts
- All validation schemas use Workspace naming
- WorkspaceRole type in permissions
- sendWorkspaceInviteEmail in emails
- No "team" references remain (except as workspace type enum value "team")
</verification>

<success_criteria>
The entire server-side API layer uses workspace naming. The tRPC router key will be changed from "team" to "workspace" in Plan 05 (root router), but the router itself is already renamed and ready.
</success_criteria>

<output>
After completion, create `.planning/phases/10-workspace-schema-migration/10-03-SUMMARY.md`
</output>
