---
phase: 10-workspace-schema-migration
plan: 05
type: execute
wave: 4
depends_on: ["10-02", "10-03", "10-04"]
files_modified:
  - sidekiq-webapp/src/features/workspace/index.ts
  - sidekiq-webapp/src/shared/trpc/root.ts
  - sidekiq-webapp/src/shared/lib/sidebar-utils.ts
  - sidekiq-webapp/src/app/(dashboard)/settings/workspaces/page.tsx
  - sidekiq-webapp/src/app/(dashboard)/invite/[token]/page.tsx
  - sidekiq-webapp/src/app/(dashboard)/chat/page.tsx
  - sidekiq-webapp/src/shared/layout/sidebar-icon-rail.tsx
  - sidekiq-webapp/src/shared/layout/sidebar-layout.tsx
autonomous: true

must_haves:
  truths:
    - "Root router registers workspace router under 'workspace' key (not 'team')"
    - "Barrel file exports all Workspace-named components, hooks, and types"
    - "Sidebar utils use 'workspaces' feature identifier"
    - "Settings page lives at /settings/workspaces path"
    - "TypeScript build succeeds with zero errors"
  artifacts:
    - path: "sidekiq-webapp/src/shared/trpc/root.ts"
      provides: "Root router with workspace key"
      contains: "workspace: workspaceRouter"
    - path: "sidekiq-webapp/src/features/workspace/index.ts"
      provides: "Barrel exports for workspace feature"
      exports: ["WorkspaceAvatar", "useActiveWorkspace", "WorkspaceRole"]
    - path: "sidekiq-webapp/src/shared/lib/sidebar-utils.ts"
      provides: "Sidebar feature detection with workspaces"
      contains: "workspaces"
  key_links:
    - from: "sidekiq-webapp/src/shared/trpc/root.ts"
      to: "sidekiq-webapp/src/features/workspace/api/router.ts"
      via: "import { workspaceRouter }"
      pattern: "workspace: workspaceRouter"
    - from: "sidekiq-webapp/src/features/workspace/index.ts"
      to: "all workspace components and hooks"
      via: "barrel re-exports"
      pattern: "export.*Workspace"
---

<objective>
Wire all the renamed modules together: update the barrel file, root router, sidebar utils, and page files. Then verify the full build succeeds.

Purpose: This is the integration layer that connects all the renamed pieces. The root router key change (`team` -> `workspace`) is the critical breaking change -- all tRPC calls across the app switch from `api.team.*` to `api.workspace.*`. The barrel file re-exports all renamed components. Pages are moved/updated.

Output: All wiring files updated, settings page moved, full TypeScript build passes.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-workspace-schema-migration/10-CONTEXT.md
@.planning/phases/10-workspace-schema-migration/10-01-SUMMARY.md
@.planning/phases/10-workspace-schema-migration/10-02-SUMMARY.md
@.planning/phases/10-workspace-schema-migration/10-03-SUMMARY.md
@.planning/phases/10-workspace-schema-migration/10-04-SUMMARY.md
@sidekiq-webapp/src/features/workspace/index.ts
@sidekiq-webapp/src/shared/trpc/root.ts
@sidekiq-webapp/src/shared/lib/sidebar-utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update barrel file, root router, and sidebar utils</name>
  <files>
    sidekiq-webapp/src/features/workspace/index.ts
    sidekiq-webapp/src/shared/trpc/root.ts
    sidekiq-webapp/src/shared/lib/sidebar-utils.ts
  </files>
  <action>
  **1. Barrel file (`sidekiq-webapp/src/features/workspace/index.ts`):**

  Rewrite the entire barrel file with workspace naming. All import paths and export names must match the renamed files from Plan 04:

  ```typescript
  /**
   * Workspace feature slice barrel export.
   *
   * Public API for the workspace feature. External modules should import
   * from `@sidekiq/workspace` or `@sidekiq/workspace/*` paths.
   *
   * @module workspace
   */

  // Components
  export { DeleteWorkspaceDialog } from "./components/delete-workspace-dialog";
  export { InviteAcceptCard } from "./components/invite-accept-card";
  export { InviteMemberDialog } from "./components/invite-member-dialog";
  export { RemoveMemberDialog } from "./components/remove-member-dialog";
  export { SidebarPanelWorkspaces } from "./components/sidebar-panel-workspaces";
  export { WorkspaceAvatar } from "./components/workspace-avatar";
  export { WorkspaceCreateDialog } from "./components/workspace-create-dialog";
  export { WorkspaceEmptyState } from "./components/workspace-empty-state";
  export { WorkspaceForm, type WorkspaceFormValues } from "./components/workspace-form";
  export { WorkspaceInvitesList } from "./components/workspace-invites-list";
  export { WorkspaceMemberList } from "./components/workspace-member-list";
  export { WorkspaceMemberRow } from "./components/workspace-member-row";
  export { WorkspaceSettingsSection } from "./components/workspace-settings-section";

  // Hooks
  export { useActiveWorkspace } from "./hooks/use-active-workspace";
  export { useMemberSearch, type WorkspaceMember } from "./hooks/use-member-search";

  // Lib - Client-safe utilities
  export {
    type WorkspaceRole,
    canInvite,
    canRemoveMember,
    canChangeRole,
    canTransferOwnership,
    canDeleteWorkspace,
    canLeaveWorkspace,
    canRevokeInvite,
    canUpdateWorkspace,
    getRoleIcon,
    getRoleLabel,
  } from "./lib/permissions";
  ```

  **IMPORTANT:** Verify the exact exported names match what Plan 03 and Plan 04 created. If permissions.ts kept `canDeleteTeam` instead of renaming to `canDeleteWorkspace`, use the actual exported name. Read each source file before writing the barrel.

  **2. Root router (`sidekiq-webapp/src/shared/trpc/root.ts`):**

  Change the import and router key:
  - `import { teamRouter } from "@sidekiq/workspace/api/router"` -> `import { workspaceRouter } from "@sidekiq/workspace/api/router"`
  - `team: teamRouter` -> `workspace: workspaceRouter` in the createTRPCRouter call

  This is the breaking change that makes all `api.team.*` calls become `api.workspace.*`.

  **3. Sidebar utils (`sidekiq-webapp/src/shared/lib/sidebar-utils.ts`):**

  - `SidebarFeature` type: `"teams"` -> `"workspaces"`
  - `getActiveFeature` function: `"/settings/teams"` -> `"/settings/workspaces"`, return `"workspaces"` instead of `"teams"`
  - Any other "team" references -> "workspace"
  </action>
  <verify>
  - `grep "teamRouter" sidekiq-webapp/src/shared/trpc/root.ts` returns 0
  - `grep "workspaceRouter" sidekiq-webapp/src/shared/trpc/root.ts` returns a match
  - `grep "workspace:" sidekiq-webapp/src/shared/trpc/root.ts` returns a match (the router key)
  - `grep "Team" sidekiq-webapp/src/features/workspace/index.ts` returns 0 (no Team exports)
  - `grep "Workspace" sidekiq-webapp/src/features/workspace/index.ts` returns multiple matches
  - `grep '"teams"' sidekiq-webapp/src/shared/lib/sidebar-utils.ts` returns 0
  - `grep '"workspaces"' sidekiq-webapp/src/shared/lib/sidebar-utils.ts` returns a match
  </verify>
  <done>
  Barrel file exports all workspace-named components, hooks, and types. Root router uses `workspace: workspaceRouter`. Sidebar utils use "workspaces" feature identifier.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update pages and remaining shared layout files</name>
  <files>
    sidekiq-webapp/src/app/(dashboard)/settings/workspaces/page.tsx
    sidekiq-webapp/src/app/(dashboard)/invite/[token]/page.tsx
    sidekiq-webapp/src/app/(dashboard)/chat/page.tsx
    sidekiq-webapp/src/shared/layout/sidebar-icon-rail.tsx
    sidekiq-webapp/src/shared/layout/sidebar-layout.tsx
  </files>
  <action>
  **1. Move settings page:**
  ```bash
  cd sidekiq-webapp/src/app/(dashboard)/settings
  git mv teams workspaces
  ```
  This moves the entire `teams/` directory (including `page.tsx`) to `workspaces/`.

  Then update the page content:
  - Any `TeamSettingsSection` -> `WorkspaceSettingsSection`
  - Any `Team` references in imports from workspace feature -> `Workspace`
  - Import paths from `@sidekiq/workspace` barrel should already work (barrel updated in Task 1)
  - UI text: "Team Settings" -> "Workspace Settings"
  - Page title/metadata: "Teams" -> "Workspaces"

  **2. Update invite page (`invite/[token]/page.tsx`):**
  - `InviteAcceptCard` import -- keep name (wasn't renamed, but check)
  - Any `api.team.*` -> `api.workspace.*`
  - Any `teamName` -> `workspaceName` in the page content
  - UI text: "join team" -> "join workspace"
  - Check for `TeamAvatar` -> `WorkspaceAvatar`

  **3. Update chat page (`chat/page.tsx`):**
  - Check for any team references. Per RESEARCH.md, this page may reference teams.
  - Any `api.team.*` -> `api.workspace.*`
  - Any `teamId` -> `workspaceId`
  - Any `useActiveTeam` -> `useActiveWorkspace`
  - Any `activeTeam` -> `activeWorkspace`

  **4. Update shared layout files:**
  Read `sidebar-icon-rail.tsx` and `sidebar-layout.tsx` for any "team"/"teams" references:
  - `SidebarPanelTeams` -> `SidebarPanelWorkspaces`
  - Import paths: `@sidekiq/workspace` barrel (should resolve to new exports)
  - `useActiveTeam` -> `useActiveWorkspace`
  - `"teams"` string -> `"workspaces"` (sidebar feature identifiers)
  - Icon rail tooltip: "Teams" -> "Workspaces"
  - Any `activeTeam` -> `activeWorkspace`, `teams` -> `workspaces`

  **5. Scan for any remaining "team" references across the entire codebase:**
  ```bash
  grep -rn "team" sidekiq-webapp/src/ --include="*.ts" --include="*.tsx" | grep -v node_modules | grep -v ".planning" | grep -vi "workspace_type.*team" | grep -vi '"team"'
  ```
  Fix any remaining references found. Common places to check:
  - Other shared layout components
  - The settings layout
  - Any page that imports from workspace feature

  **IMPORTANT:** Only the workspace type enum value "team" and the string "team" in workspace type contexts should remain. All naming/structural references to "team" must be "workspace".
  </action>
  <verify>
  - `ls sidekiq-webapp/src/app/\(dashboard\)/settings/workspaces/page.tsx` exists
  - `ls sidekiq-webapp/src/app/\(dashboard\)/settings/teams/` -> directory not found (moved)
  - Full codebase scan: `grep -rn "TeamAvatar\|TeamCreate\|TeamForm\|TeamSettings\|teamRouter\|teamMembers\|teamInvites\|useActiveTeam\|SidebarPanelTeams" sidekiq-webapp/src/ --include="*.ts" --include="*.tsx"` returns 0 matches
  - Run `cd sidekiq-webapp && npx tsc --noEmit` -- should have 0 TypeScript errors
  </verify>
  <done>
  1. Settings page moved to /settings/workspaces
  2. Invite page uses workspace naming
  3. Chat page uses workspace naming
  4. Sidebar layout files use workspace naming
  5. No "team" naming references remain anywhere in src/ (except workspace type enum value "team")
  6. TypeScript compilation succeeds with 0 errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Full build verification and database wipe & reseed</name>
  <files>(no new files -- verification only)</files>
  <action>
  Run the following verification steps in order:

  **1. TypeScript compilation:**
  ```bash
  cd sidekiq-webapp && npx tsc --noEmit
  ```
  Must pass with 0 errors. If errors exist, fix them before proceeding.

  **2. Next.js build:**
  ```bash
  cd sidekiq-webapp && pnpm build
  ```
  Must pass. If build fails, fix the issues.

  **3. Database wipe and reseed (if Docker Compose is running):**
  If the PostgreSQL database is accessible:
  ```bash
  cd sidekiq-webapp && pnpm db:push
  ```
  This pushes the schema directly (faster than running migrations for dev).

  If `db:push` fails due to existing data:
  ```bash
  cd sidekiq-webapp && pnpm db:push --force-reset
  ```
  Per CONTEXT.md: "Local dev databases wiped and re-seeded after migration."

  Then seed:
  ```bash
  cd sidekiq-webapp && pnpm db:seed
  ```

  **4. If database is not running:** Skip steps 3-4. The TypeScript build is the primary verification.

  **5. Unit tests:**
  ```bash
  cd sidekiq-webapp && pnpm test --run
  ```
  All existing tests should pass. If tests reference "team" naming, they need updating too -- fix any test failures.

  **6. Final comprehensive grep:**
  ```bash
  grep -rn "teamId\|teamMembers\|teamInvites\|teamRouter\|TeamRole\|TeamAvatar\|TeamCreate\|TeamForm\|TeamSettings\|TeamMember\|TeamInvite\|useActiveTeam\|SidebarPanelTeams\|sendTeamInvite\|canDeleteTeam\|canLeaveTeam\|canUpdateTeam\|teamRoleEnum" sidekiq-webapp/src/ --include="*.ts" --include="*.tsx" | grep -v "node_modules"
  ```
  Must return 0 results. If any remain, fix them.
  </action>
  <verify>
  - `npx tsc --noEmit` exits with code 0
  - `pnpm build` exits with code 0
  - Final grep returns 0 "team" naming references in src/
  - Unit tests pass (if applicable)
  </verify>
  <done>
  The entire codebase compiles and builds successfully with workspace naming. No team naming references remain. Database can be wiped and reseeded with workspace schema.
  </done>
</task>

</tasks>

<verification>
- Root router key is "workspace"
- Barrel exports all Workspace-named symbols
- Settings page at /settings/workspaces
- TypeScript build: 0 errors
- Next.js build: success
- No team naming in src/ (except workspace type enum value "team")
</verification>

<success_criteria>
The entire codebase is migrated from team to workspace naming. The build succeeds. The database schema supports the workspace model. All content tables have workspaceId. New signups get personal workspaces automatically.
</success_criteria>

<output>
After completion, create `.planning/phases/10-workspace-schema-migration/10-05-SUMMARY.md`
</output>
