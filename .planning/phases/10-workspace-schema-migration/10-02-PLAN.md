---
phase: 10-workspace-schema-migration
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - sidekiq-webapp/drizzle/0003_workspace_migration.sql
  - sidekiq-webapp/drizzle/meta/_journal.json
  - sidekiq-webapp/src/shared/db/reset-and-seed.ts
  - sidekiq-webapp/src/features/auth/api/config.ts
autonomous: true

must_haves:
  truths:
    - "Drizzle migration SQL exists that transforms team tables to workspace tables"
    - "Seed script creates personal workspace + workspace_member row for the test user"
    - "Seed script assigns all threads and sidekiqs to the user's personal workspace"
    - "Auth config creates personal workspace on new user signup via databaseHooks"
  artifacts:
    - path: "sidekiq-webapp/drizzle/0003_workspace_migration.sql"
      provides: "SQL migration from team to workspace schema"
      contains: "workspace"
    - path: "sidekiq-webapp/src/shared/db/reset-and-seed.ts"
      provides: "Updated seed with workspace references and personal workspace creation"
      contains: "workspaceMembers"
    - path: "sidekiq-webapp/src/features/auth/api/config.ts"
      provides: "databaseHooks for personal workspace creation on signup"
      contains: "databaseHooks"
  key_links:
    - from: "sidekiq-webapp/src/features/auth/api/config.ts"
      to: "workspace + workspace_member tables"
      via: "databaseHooks.user.create.after"
      pattern: "databaseHooks"
    - from: "sidekiq-webapp/src/shared/db/reset-and-seed.ts"
      to: "workspace tables"
      via: "schema.workspaces, schema.workspaceMembers"
      pattern: "schema\\.workspaces"
---

<objective>
Generate the Drizzle migration, update the seed script for workspace model, and add the auth hook for personal workspace creation.

Purpose: The migration SQL transforms the database from team to workspace model. The seed script ensures local dev has correct workspace data. The auth hook ensures every new signup gets a personal workspace automatically.

Output: Migration SQL file, updated seed script, updated auth config with databaseHooks.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-workspace-schema-migration/10-CONTEXT.md
@.planning/phases/10-workspace-schema-migration/10-RESEARCH.md
@.planning/phases/10-workspace-schema-migration/10-01-SUMMARY.md
@sidekiq-webapp/src/shared/db/schema.ts
@sidekiq-webapp/src/shared/db/reset-and-seed.ts
@sidekiq-webapp/src/features/auth/api/config.ts
@sidekiq-webapp/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate Drizzle migration for workspace schema</name>
  <files>sidekiq-webapp/drizzle/0003_workspace_migration.sql, sidekiq-webapp/drizzle/meta/_journal.json</files>
  <action>
  Run `cd sidekiq-webapp && npx drizzle-kit generate` to generate migration SQL from the updated schema.ts.

  drizzle-kit will interactively prompt for each rename. For every "Is X created or renamed?" prompt, answer **"renamed"** (not "created"). Expect prompts for:
  - team -> workspace table
  - team_member -> workspace_member table
  - team_invite -> workspace_invite table
  - team_id -> workspace_id columns
  - team_role -> workspace_role enum

  After generation, inspect the SQL file carefully. Per RESEARCH.md caveats:

  1. **Verify enum rename**: The SQL must contain `ALTER TYPE "team_role" RENAME TO "workspace_role"` separated by `statement-breakpoint` (cannot run in transaction).
  2. **Verify new enum**: `CREATE TYPE "workspace_type" AS ENUM ('personal', 'team')` must appear BEFORE any column that uses it.
  3. **Verify table renames**: `ALTER TABLE "team" RENAME TO "workspace"` etc.
  4. **Verify column renames**: `ALTER TABLE ... RENAME COLUMN "team_id" TO "workspace_id"` for sidekiqs, workspace_member, workspace_invite tables.
  5. **Verify new columns**: `ALTER TABLE "workspace" ADD COLUMN "type" "workspace_type" NOT NULL` and `ADD COLUMN "description" varchar(500)`.
  6. **Verify new column on threads**: `ALTER TABLE "thread" ADD COLUMN "workspace_id" text NOT NULL REFERENCES "workspace"("id") ON DELETE CASCADE`.
  7. **Verify partial unique index**: `CREATE UNIQUE INDEX "workspace_personal_unique" ON "workspace" ("owner_id") WHERE "type" = 'personal'`.
  8. **Verify new indexes**: `workspace_type_idx`, `thread_workspace_idx`.

  **If drizzle-kit misses any SQL** (known v0.30.x bug with combined renames): manually add the missing statements to the generated SQL file. Separate each statement with `-- statement-breakpoint`.

  **IMPORTANT:** The threads.workspace_id NOT NULL column requires that existing thread rows have a value. Since local dev databases will be wiped and re-seeded, add a DEFAULT or handle this in the migration:
  - Option A: If the DB is empty, NOT NULL is fine as-is.
  - Option B: If rows might exist, add the column as nullable first, backfill, then ALTER to NOT NULL.
  - Since CONTEXT.md says "Local dev databases wiped and re-seeded after migration", Option A is fine. But if drizzle-kit complains, use Option B.
  </action>
  <verify>
  - The file `sidekiq-webapp/drizzle/0003_*.sql` exists (name may vary slightly)
  - `grep "workspace" sidekiq-webapp/drizzle/0003_*.sql` returns matches
  - `grep "team_role.*RENAME" sidekiq-webapp/drizzle/0003_*.sql` or `grep "workspace_role" sidekiq-webapp/drizzle/0003_*.sql` confirms enum rename
  - `grep "workspace_type" sidekiq-webapp/drizzle/0003_*.sql` confirms new enum
  - `grep "workspace_personal_unique" sidekiq-webapp/drizzle/0003_*.sql` confirms partial unique index
  - The journal file `drizzle/meta/_journal.json` has a 4th entry
  </verify>
  <done>
  A valid Drizzle migration SQL file exists that:
  1. Renames team -> workspace, team_member -> workspace_member, team_invite -> workspace_invite
  2. Renames team_role enum -> workspace_role
  3. Creates workspace_type enum
  4. Adds type and description columns to workspace table
  5. Renames teamId columns to workspaceId in child tables
  6. Adds workspaceId to threads table
  7. Creates workspace_personal_unique partial unique index
  8. Creates workspace_type_idx and thread_workspace_idx indexes
  </done>
</task>

<task type="auto">
  <name>Task 2: Update seed script for workspace model</name>
  <files>sidekiq-webapp/src/shared/db/reset-and-seed.ts</files>
  <action>
  Update `sidekiq-webapp/src/shared/db/reset-and-seed.ts` with the following changes:

  **1. Seed IDs section -- add workspace IDs:**
  ```typescript
  const SEED_PERSONAL_WORKSPACE_ID = "seed-workspace-personal";
  ```

  **2. Update createSeedSidekiqs:**
  - Change `teamId: null` -> `workspaceId: SEED_PERSONAL_WORKSPACE_ID` for all 5 sidekiqs (personal sidekiqs belong to personal workspace per CONTEXT.md)

  **3. Update createSeedThreads:**
  - Add `workspaceId: SEED_PERSONAL_WORKSPACE_ID` to all 4 thread objects (per CONTEXT.md: "Existing threads assigned to user's personal workspace")

  **4. Update flushAppData function:**
  Replace all team table references:
  - `schema.teamInvites` -> `schema.workspaceInvites`
  - `schema.teamMembers` -> `schema.workspaceMembers`
  - `schema.teams` -> `schema.workspaces`
  - Update console.log messages: "team invites" -> "workspace invites", "team members" -> "workspace members", "teams" -> "workspaces"

  **5. Update seedData function -- add personal workspace creation:**
  Before seeding sidekiqs, add:
  ```typescript
  // Create personal workspace for the test user
  console.log("    - Seeding personal workspace...");
  await db.insert(schema.workspaces).values({
    id: SEED_PERSONAL_WORKSPACE_ID,
    name: "Personal",
    type: "personal",
    slug: "personal",
    ownerId: userId,
    memberLimit: 1,
    avatar: { type: "initials" as const, color: "#6366f1" },
  }).onConflictDoNothing();

  // Add workspace member row for the owner
  await db.insert(schema.workspaceMembers).values({
    workspaceId: SEED_PERSONAL_WORKSPACE_ID,
    userId: userId,
    role: "owner",
  }).onConflictDoNothing();
  ```

  **6. Update summary log:**
  Change the final console.log to include workspace count:
  `Seeded: 1 workspace, ${sidekiqs.length} sidekiqs, ${threads.length} threads, ${seedMessages.length} messages`

  **7. Update JSDoc comments:**
  - File-level JSDoc: "Flushes app data (messages, threads, sidekiqs, teams)" -> "Flushes app data (messages, threads, sidekiqs, workspaces)"
  - flushAppData JSDoc: "Tables deleted: messages, threads, sidekiqs, teamInvites, teamMembers, teams" -> "Tables deleted: messages, threads, sidekiqs, workspaceInvites, workspaceMembers, workspaces"

  **NOTE:** The `slug` column may not exist yet on the workspaces table (it existed on teams as a unique column). Check schema.ts from Plan 01 -- if slug column is present, include it. If not, omit it from the seed.
  </action>
  <verify>
  - `grep "teamId" sidekiq-webapp/src/shared/db/reset-and-seed.ts` returns 0 matches
  - `grep "workspaceId" sidekiq-webapp/src/shared/db/reset-and-seed.ts` returns matches
  - `grep "SEED_PERSONAL_WORKSPACE_ID" sidekiq-webapp/src/shared/db/reset-and-seed.ts` returns matches
  - `grep "schema.workspaces" sidekiq-webapp/src/shared/db/reset-and-seed.ts` returns matches
  </verify>
  <done>
  Seed script creates a personal workspace with workspace_member row, assigns all threads and sidekiqs to it, and flushes workspace tables (not team tables).
  </done>
</task>

<task type="auto">
  <name>Task 3: Add databaseHooks for personal workspace creation on signup</name>
  <files>sidekiq-webapp/src/features/auth/api/config.ts</files>
  <action>
  Update `sidekiq-webapp/src/features/auth/api/config.ts` to add a databaseHooks section in the betterAuth() configuration:

  **1. Add imports at the top:**
  ```typescript
  import { nanoid } from "nanoid";
  import { workspaces, workspaceMembers } from "@sidekiq/shared/db/schema";
  ```

  **2. Add databaseHooks to betterAuth config:**
  After `socialProviders: { ... }`, add:
  ```typescript
  databaseHooks: {
    user: {
      create: {
        after: async (user) => {
          const workspaceId = nanoid();

          // Create personal workspace for new user
          await db.insert(workspaces).values({
            id: workspaceId,
            name: "Personal",
            type: "personal",
            ownerId: user.id,
            memberLimit: 1,
            avatar: { type: "initials" as const, color: "#6366f1" },
          });

          // Create workspace_member row (unified query pattern)
          await db.insert(workspaceMembers).values({
            workspaceId,
            userId: user.id,
            role: "owner",
          });

          console.log(`[Auth] Personal workspace created for user ${user.id}`);
        },
      },
    },
  },
  ```

  **3. Verify db import exists:**
  The file already imports `db` from `@sidekiq/shared/db`. Verify this import is present. If not, add it.

  **IMPORTANT per CONTEXT.md:**
  - Named "Personal" for every user
  - Exactly one per user (enforced by DB constraint from Plan 01)
  - Permanent and non-deletable
  - memberLimit: 1 (only the owner)
  - No slug needed (personal workspace is accessed by user context, not slug)

  **NOTE:** If the schema.ts has a `slug` column that is required (NOT NULL), include `slug: "personal"` in the values. Check the schema from Plan 01 output.
  </action>
  <verify>
  - `grep "databaseHooks" sidekiq-webapp/src/features/auth/api/config.ts` returns a match
  - `grep "workspaces" sidekiq-webapp/src/features/auth/api/config.ts` returns a match
  - `grep "Personal" sidekiq-webapp/src/features/auth/api/config.ts` returns a match
  - `grep "nanoid" sidekiq-webapp/src/features/auth/api/config.ts` returns a match
  </verify>
  <done>
  Auth config has databaseHooks that create a personal workspace + workspace_member row for every new user signup.
  </done>
</task>

</tasks>

<verification>
- Migration SQL file exists in drizzle/ directory
- Seed script references workspace tables, creates personal workspace
- Auth config has databaseHooks for personal workspace creation
- No remaining "team" references in seed script or auth config (except as workspace type enum value "team")
</verification>

<success_criteria>
After this plan:
1. A valid Drizzle migration exists that transforms the DB from team to workspace model
2. The seed script creates a personal workspace, assigns all content to it, and uses workspace table references
3. New user signups automatically get a personal workspace via Better Auth databaseHooks
</success_criteria>

<output>
After completion, create `.planning/phases/10-workspace-schema-migration/10-02-SUMMARY.md`
</output>
