---
phase: 06-sidekiq-crud
plan: 06
type: execute
wave: 3
depends_on: ["06-04"]
files_modified:
  - sidekiq-webapp/src/components/sidekiq/avatar-picker.tsx
  - sidekiq-webapp/src/components/sidekiq/color-picker.tsx
  - sidekiq-webapp/src/components/sidekiq/emoji-picker-popover.tsx
  - sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can customize avatar color from preset palette"
    - "User can switch between initials and emoji avatar type"
    - "User can select emoji from picker for avatar"
    - "Avatar changes reflect immediately in preview"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidekiq/avatar-picker.tsx"
      provides: "Avatar customization UI with color and type selection"
      exports: ["AvatarPicker"]
    - path: "sidekiq-webapp/src/components/sidekiq/color-picker.tsx"
      provides: "Color palette picker"
      exports: ["ColorPicker"]
    - path: "sidekiq-webapp/src/components/sidekiq/emoji-picker-popover.tsx"
      provides: "Emoji picker in popover"
      exports: ["EmojiPickerPopover"]
  key_links:
    - from: "sidekiq-webapp/src/components/sidekiq/avatar-picker.tsx"
      to: "sidekiq-webapp/src/lib/utils/avatar.ts"
      via: "color palette"
      pattern: "AVATAR_COLORS"
    - from: "sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx"
      to: "sidekiq-webapp/src/components/sidekiq/avatar-picker.tsx"
      via: "form field integration"
      pattern: "AvatarPicker"
---

<objective>
Add avatar customization with color picker and emoji selection.

Purpose: Allows users to personalize their Sidekiq's visual identity with custom colors and optional emoji instead of initials.
Output: Avatar picker component with color palette, emoji picker integration, and form integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-sidekiq-crud/06-CONTEXT.md
@.planning/phases/06-sidekiq-crud/06-RESEARCH.md
@.planning/phases/06-sidekiq-crud/06-02-SUMMARY.md
@.planning/phases/06-sidekiq-crud/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create color picker component</name>
  <files>sidekiq-webapp/src/components/sidekiq/color-picker.tsx</files>
  <action>
Create the color picker with preset palette:

```typescript
"use client";

import { Check } from "lucide-react";

import { cn } from "@sidekiq/lib/utils";
import { AVATAR_COLORS, type AvatarColor } from "@sidekiq/lib/utils/avatar";

interface ColorPickerProps {
  value: string;
  onChange: (color: AvatarColor) => void;
}

/**
 * Color picker with preset palette.
 * Shows 12 colors in a grid, selected color has checkmark.
 */
export function ColorPicker({ value, onChange }: ColorPickerProps) {
  return (
    <div className="grid grid-cols-6 gap-2">
      {AVATAR_COLORS.map((color) => (
        <button
          key={color}
          type="button"
          onClick={() => onChange(color)}
          className={cn(
            "relative size-8 rounded-full transition-transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",
            value === color && "ring-2 ring-ring ring-offset-2"
          )}
          style={{ backgroundColor: color }}
          aria-label={`Select color ${color}`}
          aria-pressed={value === color}
        >
          {value === color && (
            <Check className="absolute inset-0 m-auto size-4 text-white" />
          )}
        </button>
      ))}
    </div>
  );
}
```
  </action>
  <verify>
```bash
cd sidekiq-webapp && pnpm tsc --noEmit
```
  </verify>
  <done>
ColorPicker component with 12 preset colors, checkmark on selected, keyboard accessible.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create emoji picker popover</name>
  <files>sidekiq-webapp/src/components/sidekiq/emoji-picker-popover.tsx</files>
  <action>
Create a simple emoji picker (without frimousse dependency for simplicity - can add later if needed):

```typescript
"use client";

import { useState } from "react";
import { Smile } from "lucide-react";

import { Button } from "@sidekiq/components/ui/button";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@sidekiq/components/ui/popover";
import { Input } from "@sidekiq/components/ui/input";
import { cn } from "@sidekiq/lib/utils";

// Common emoji categories for Sidekiqs
const EMOJI_CATEGORIES = {
  faces: ["ðŸ˜€", "ðŸ˜Š", "ðŸ¤”", "ðŸ˜Ž", "ðŸ¤–", "ðŸ‘»", "ðŸŽ­", "ðŸ¦Š"],
  objects: ["ðŸ’¡", "ðŸŽ¯", "ðŸ“š", "âœï¸", "ðŸ”§", "ðŸŽ¨", "ðŸŽµ", "ðŸ’»"],
  nature: ["ðŸŒŸ", "ðŸ”¥", "âš¡", "ðŸŒˆ", "ðŸŒŠ", "ðŸŒ¸", "ðŸ€", "ðŸŒ™"],
  symbols: ["â¤ï¸", "â­", "ðŸ’Ž", "ðŸ†", "ðŸŽª", "ðŸŽ²", "ðŸŽ", "ðŸš€"],
};

const ALL_EMOJIS = Object.values(EMOJI_CATEGORIES).flat();

interface EmojiPickerPopoverProps {
  value?: string;
  onChange: (emoji: string) => void;
  children?: React.ReactNode;
}

/**
 * Simple emoji picker in a popover.
 * Shows commonly used emojis for Sidekiq avatars.
 */
export function EmojiPickerPopover({
  value,
  onChange,
  children,
}: EmojiPickerPopoverProps) {
  const [open, setOpen] = useState(false);
  const [search, setSearch] = useState("");

  const filteredEmojis = search
    ? ALL_EMOJIS.filter((emoji) =>
        emoji.toLowerCase().includes(search.toLowerCase())
      )
    : ALL_EMOJIS;

  const handleSelect = (emoji: string) => {
    onChange(emoji);
    setOpen(false);
    setSearch("");
  };

  return (
    <Popover open={open} onOpenChange={setOpen}>
      <PopoverTrigger asChild>
        {children ?? (
          <Button
            type="button"
            variant="outline"
            size="sm"
            className="gap-2"
          >
            {value ? (
              <span className="text-lg">{value}</span>
            ) : (
              <>
                <Smile className="size-4" />
                Pick emoji
              </>
            )}
          </Button>
        )}
      </PopoverTrigger>
      <PopoverContent className="w-72 p-3" align="start">
        <div className="space-y-3">
          {/* Search */}
          <Input
            type="search"
            placeholder="Search emojis..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="h-8"
          />

          {/* Emoji grid */}
          <div className="grid grid-cols-8 gap-1">
            {filteredEmojis.map((emoji) => (
              <button
                key={emoji}
                type="button"
                onClick={() => handleSelect(emoji)}
                className={cn(
                  "flex size-8 items-center justify-center rounded-md text-xl transition-colors hover:bg-accent",
                  value === emoji && "bg-accent"
                )}
              >
                {emoji}
              </button>
            ))}
          </div>

          {filteredEmojis.length === 0 && (
            <p className="text-center text-sm text-muted-foreground py-2">
              No emojis found
            </p>
          )}

          {/* Category labels */}
          {!search && (
            <div className="text-xs text-muted-foreground">
              <span className="font-medium">Categories:</span> Faces, Objects,
              Nature, Symbols
            </div>
          )}
        </div>
      </PopoverContent>
    </Popover>
  );
}
```
  </action>
  <verify>
```bash
cd sidekiq-webapp && pnpm tsc --noEmit
```
  </verify>
  <done>
EmojiPickerPopover with curated emoji list for Sidekiq avatars, search functionality, and category organization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create avatar picker and integrate into form</name>
  <files>
sidekiq-webapp/src/components/sidekiq/avatar-picker.tsx
sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx
  </files>
  <action>
**1. Create `src/components/sidekiq/avatar-picker.tsx`:**

```typescript
"use client";

import { Type, Smile } from "lucide-react";

import { Button } from "@sidekiq/components/ui/button";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@sidekiq/components/ui/popover";
import {
  ToggleGroup,
  ToggleGroupItem,
} from "@sidekiq/components/ui/toggle-group";
import { Label } from "@sidekiq/components/ui/label";
import { SidekiqAvatar } from "./sidekiq-avatar";
import { ColorPicker } from "./color-picker";
import { EmojiPickerPopover } from "./emoji-picker-popover";
import type { AvatarColor } from "@sidekiq/lib/utils/avatar";

interface SidekiqAvatarValue {
  type: "initials" | "emoji";
  color: string;
  emoji?: string;
}

interface AvatarPickerProps {
  name: string;
  value: SidekiqAvatarValue;
  onChange: (value: SidekiqAvatarValue) => void;
}

/**
 * Avatar customization picker.
 * Allows switching between initials and emoji, and selecting colors.
 */
export function AvatarPicker({ name, value, onChange }: AvatarPickerProps) {
  const handleTypeChange = (type: string) => {
    if (type === "initials" || type === "emoji") {
      onChange({
        ...value,
        type,
        emoji: type === "emoji" ? (value.emoji || "ðŸ¤–") : undefined,
      });
    }
  };

  const handleColorChange = (color: AvatarColor) => {
    onChange({ ...value, color });
  };

  const handleEmojiChange = (emoji: string) => {
    onChange({ ...value, emoji, type: "emoji" });
  };

  return (
    <Popover>
      <PopoverTrigger asChild>
        <Button
          type="button"
          variant="outline"
          className="h-auto gap-3 p-3"
        >
          <SidekiqAvatar name={name} avatar={value} size="md" />
          <div className="text-left">
            <p className="text-sm font-medium">Customize avatar</p>
            <p className="text-xs text-muted-foreground">
              {value.type === "emoji" ? "Emoji" : "Initials"} on {value.color}
            </p>
          </div>
        </Button>
      </PopoverTrigger>
      <PopoverContent className="w-80 p-4" align="start">
        <div className="space-y-4">
          {/* Preview */}
          <div className="flex justify-center">
            <SidekiqAvatar name={name} avatar={value} size="lg" />
          </div>

          {/* Type toggle */}
          <div className="space-y-2">
            <Label>Avatar type</Label>
            <ToggleGroup
              type="single"
              value={value.type}
              onValueChange={handleTypeChange}
              className="justify-start"
            >
              <ToggleGroupItem value="initials" className="gap-2">
                <Type className="size-4" />
                Initials
              </ToggleGroupItem>
              <ToggleGroupItem value="emoji" className="gap-2">
                <Smile className="size-4" />
                Emoji
              </ToggleGroupItem>
            </ToggleGroup>
          </div>

          {/* Emoji picker (only when emoji type) */}
          {value.type === "emoji" && (
            <div className="space-y-2">
              <Label>Select emoji</Label>
              <EmojiPickerPopover
                value={value.emoji}
                onChange={handleEmojiChange}
              />
            </div>
          )}

          {/* Color picker */}
          <div className="space-y-2">
            <Label>Background color</Label>
            <ColorPicker value={value.color} onChange={handleColorChange} />
          </div>
        </div>
      </PopoverContent>
    </Popover>
  );
}
```

**2. Update `src/components/sidekiq/sidekiq-form.tsx`:**

Add avatar picker field after the name field:

```typescript
// Add import at top
import { AvatarPicker } from "./avatar-picker";

// Add avatar field after name field (before description):

{/* Avatar picker - add after name */}
<FormField
  control={form.control}
  name="avatar"
  render={({ field }) => (
    <FormItem>
      <FormLabel>Avatar</FormLabel>
      <FormControl>
        <AvatarPicker
          name={name || "Sidekiq"}
          value={field.value}
          onChange={field.onChange}
        />
      </FormControl>
      <FormDescription>
        Choose initials or emoji with a custom color
      </FormDescription>
      <FormMessage />
    </FormItem>
  )}
/>
```

**3. Remove the auto-generate avatar color useEffect:**

The auto-generation was in Plan 04, but now user has full control. Remove or modify the useEffect that auto-generates avatar color to only trigger on initial name entry (when avatar color is still default):

```typescript
// Keep the auto-generation but only for truly new names with default color
useEffect(() => {
  const currentAvatar = form.getValues("avatar");
  // Only auto-generate if:
  // 1. Name has content
  // 2. Using initials type
  // 3. Color is still the default (#6366f1)
  // 4. This is a new sidekiq (mode === "create")
  if (
    mode === "create" &&
    name.trim() &&
    currentAvatar.type === "initials" &&
    currentAvatar.color === "#6366f1" &&
    !form.formState.dirtyFields.avatar
  ) {
    const newAvatar = createDefaultAvatar(name);
    if (newAvatar.color !== currentAvatar.color) {
      form.setValue("avatar", newAvatar, { shouldDirty: false });
    }
  }
}, [name, mode, form]);
```
  </action>
  <verify>
1. Start dev server: `pnpm dev`
2. Navigate to /sidekiqs/new
3. Click avatar picker - popover opens
4. Switch between initials and emoji - type changes
5. Select color - avatar updates
6. Select emoji - avatar shows emoji
7. Preview reflects avatar changes
  </verify>
  <done>
AvatarPicker integrated with form. Users can customize avatar type (initials/emoji), color from palette, and select emoji. Preview updates in real-time.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /sidekiqs/new
2. Avatar picker button shows current avatar
3. Click to open - shows type toggle and color palette
4. Select "Emoji" - shows emoji picker
5. Pick emoji - avatar updates immediately
6. Pick color - background changes
7. Switch back to "Initials" - shows name initials
8. Preview panel shows updated avatar
9. Save Sidekiq - avatar saved correctly
10. Edit Sidekiq - avatar loads correctly
</verification>

<success_criteria>
- AvatarPicker shows current avatar with "Customize avatar" button
- Type toggle switches between initials and emoji
- Color picker shows 12 preset colors with checkmark on selected
- Emoji picker shows curated emoji list with search
- Avatar changes reflect immediately in form preview
- Avatar settings persist when Sidekiq is saved
</success_criteria>

<output>
After completion, create `.planning/phases/06-sidekiq-crud/06-06-SUMMARY.md`
</output>
