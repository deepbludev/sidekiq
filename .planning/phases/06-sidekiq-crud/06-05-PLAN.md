---
phase: 06-sidekiq-crud
plan: 05
type: execute
wave: 3
depends_on: ["06-04"]
files_modified:
  - sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx
  - sidekiq-webapp/src/components/sidekiq/conversation-starters.tsx
  - sidekiq-webapp/src/components/sidekiq/instructions-editor.tsx
autonomous: true

must_haves:
  truths:
    - "User can add and reorder conversation starters via drag-and-drop"
    - "Conversation starters are limited to 6 items, 200 chars each"
    - "Instructions field has markdown support with preview toggle"
    - "Drag handle is visible and keyboard accessible"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidekiq/conversation-starters.tsx"
      provides: "Drag-and-drop reorderable conversation starters"
      exports: ["ConversationStarters"]
    - path: "sidekiq-webapp/src/components/sidekiq/instructions-editor.tsx"
      provides: "Markdown editor with preview toggle"
      exports: ["InstructionsEditor"]
  key_links:
    - from: "sidekiq-webapp/src/components/sidekiq/conversation-starters.tsx"
      to: "@dnd-kit/sortable"
      via: "sortable context"
      pattern: "useSortable|SortableContext"
    - from: "sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx"
      to: "sidekiq-webapp/src/components/sidekiq/conversation-starters.tsx"
      via: "form field integration"
      pattern: "ConversationStarters"
---

<objective>
Add conversation starters with drag-and-drop and enhanced markdown instructions editor.

Purpose: Enables users to create engaging Sidekiqs with reorderable conversation prompts and rich markdown instructions.
Output: Drag-drop conversation starters list, markdown editor with preview toggle, integrated into form.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-sidekiq-crud/06-CONTEXT.md
@.planning/phases/06-sidekiq-crud/06-RESEARCH.md
@.planning/phases/06-sidekiq-crud/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create drag-and-drop conversation starters component</name>
  <files>sidekiq-webapp/src/components/sidekiq/conversation-starters.tsx</files>
  <action>
Create the sortable conversation starters component using @dnd-kit:

```typescript
"use client";

import { useState } from "react";
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  type DragEndEvent,
} from "@dnd-kit/core";
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { GripVertical, Plus, Trash2 } from "lucide-react";
import { nanoid } from "nanoid";

import { Button } from "@sidekiq/components/ui/button";
import { Input } from "@sidekiq/components/ui/input";
import { cn } from "@sidekiq/lib/utils";

interface StarterItem {
  id: string;
  text: string;
}

interface ConversationStartersProps {
  value: string[];
  onChange: (value: string[]) => void;
  maxItems?: number;
  maxLength?: number;
}

/**
 * Drag-and-drop reorderable conversation starters.
 * Uses @dnd-kit for accessible drag-and-drop with keyboard support.
 *
 * @param value - Array of starter strings
 * @param onChange - Callback when starters change
 * @param maxItems - Maximum number of starters (default 6)
 * @param maxLength - Maximum length per starter (default 200)
 */
export function ConversationStarters({
  value,
  onChange,
  maxItems = 6,
  maxLength = 200,
}: ConversationStartersProps) {
  // Convert strings to items with IDs for dnd-kit
  const [items, setItems] = useState<StarterItem[]>(() =>
    value.map((text) => ({ id: nanoid(), text }))
  );

  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Require 8px movement to start drag
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;

    if (over && active.id !== over.id) {
      const oldIndex = items.findIndex((item) => item.id === active.id);
      const newIndex = items.findIndex((item) => item.id === over.id);
      const newItems = arrayMove(items, oldIndex, newIndex);
      setItems(newItems);
      onChange(newItems.map((item) => item.text));
    }
  };

  const handleAdd = () => {
    if (items.length >= maxItems) return;
    const newItems = [...items, { id: nanoid(), text: "" }];
    setItems(newItems);
    onChange(newItems.map((item) => item.text));
  };

  const handleRemove = (id: string) => {
    const newItems = items.filter((item) => item.id !== id);
    setItems(newItems);
    onChange(newItems.map((item) => item.text));
  };

  const handleUpdate = (id: string, text: string) => {
    const newItems = items.map((item) =>
      item.id === id ? { ...item, text } : item
    );
    setItems(newItems);
    onChange(newItems.map((item) => item.text));
  };

  return (
    <div className="space-y-3">
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragEnd={handleDragEnd}
      >
        <SortableContext items={items} strategy={verticalListSortingStrategy}>
          <div className="space-y-2">
            {items.map((item) => (
              <SortableStarterItem
                key={item.id}
                item={item}
                maxLength={maxLength}
                onUpdate={handleUpdate}
                onRemove={handleRemove}
              />
            ))}
          </div>
        </SortableContext>
      </DndContext>

      {items.length < maxItems && (
        <Button
          type="button"
          variant="outline"
          size="sm"
          onClick={handleAdd}
          className="w-full"
        >
          <Plus className="mr-2 size-4" />
          Add starter ({items.length}/{maxItems})
        </Button>
      )}

      {items.length === 0 && (
        <p className="text-sm text-muted-foreground text-center py-2">
          Add conversation starters to help users begin chatting
        </p>
      )}
    </div>
  );
}

interface SortableStarterItemProps {
  item: StarterItem;
  maxLength: number;
  onUpdate: (id: string, text: string) => void;
  onRemove: (id: string) => void;
}

function SortableStarterItem({
  item,
  maxLength,
  onUpdate,
  onRemove,
}: SortableStarterItemProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: item.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        "flex items-center gap-2 rounded-md border bg-background p-2",
        isDragging && "opacity-50 shadow-lg"
      )}
    >
      {/* Drag handle */}
      <button
        type="button"
        className="cursor-grab touch-none text-muted-foreground hover:text-foreground focus:outline-none focus:ring-2 focus:ring-ring rounded"
        {...attributes}
        {...listeners}
      >
        <GripVertical className="size-4" />
      </button>

      {/* Input */}
      <Input
        value={item.text}
        onChange={(e) => onUpdate(item.id, e.target.value)}
        placeholder="e.g., Help me write a blog post about..."
        maxLength={maxLength}
        className="flex-1 border-0 bg-transparent p-0 focus-visible:ring-0"
      />

      {/* Character count */}
      <span
        className={cn(
          "text-xs tabular-nums shrink-0",
          item.text.length >= maxLength
            ? "text-destructive"
            : item.text.length >= maxLength * 0.8
              ? "text-amber-500"
              : "text-muted-foreground"
        )}
      >
        {item.text.length}/{maxLength}
      </span>

      {/* Remove button */}
      <Button
        type="button"
        variant="ghost"
        size="icon-sm"
        onClick={() => onRemove(item.id)}
        className="shrink-0 text-muted-foreground hover:text-destructive"
      >
        <Trash2 className="size-4" />
      </Button>
    </div>
  );
}
```
  </action>
  <verify>
```bash
cd sidekiq-webapp && pnpm tsc --noEmit
```
Component should compile without errors.
  </verify>
  <done>
ConversationStarters component created with @dnd-kit drag-and-drop, keyboard accessibility, add/remove buttons, and character limits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create markdown instructions editor</name>
  <files>sidekiq-webapp/src/components/sidekiq/instructions-editor.tsx</files>
  <action>
Create the markdown editor with preview toggle:

```typescript
"use client";

import { useState } from "react";
import dynamic from "next/dynamic";
import { Eye, EyeOff } from "lucide-react";

import { Button } from "@sidekiq/components/ui/button";
import { Textarea } from "@sidekiq/components/ui/textarea";
import { cn } from "@sidekiq/lib/utils";

// Dynamic import for markdown editor (avoid SSR issues)
const MDEditor = dynamic(() => import("@uiw/react-md-editor"), {
  ssr: false,
  loading: () => (
    <div className="h-[300px] animate-pulse rounded-md border bg-muted" />
  ),
});

// Import styles
import "@uiw/react-md-editor/markdown-editor.css";
import "@uiw/react-markdown-preview/markdown.css";

interface InstructionsEditorProps {
  value: string;
  onChange: (value: string) => void;
  maxLength?: number;
  placeholder?: string;
  error?: string;
}

/**
 * Markdown editor for Sidekiq instructions.
 * Provides toggle between edit and preview modes.
 * Uses @uiw/react-md-editor for markdown support.
 *
 * @param value - Current markdown content
 * @param onChange - Callback when content changes
 * @param maxLength - Maximum character limit (default 8000)
 * @param placeholder - Placeholder text
 * @param error - Error message to display
 */
export function InstructionsEditor({
  value,
  onChange,
  maxLength = 8000,
  placeholder = "Enter instructions for your Sidekiq...\n\nYou can use **markdown** formatting:\n- Lists\n- **Bold** and *italic* text\n- `code` snippets\n- And more...",
  error,
}: InstructionsEditorProps) {
  const [showPreview, setShowPreview] = useState(false);

  const charCountClass = (() => {
    if (value.length >= maxLength) return "text-destructive";
    if (value.length >= maxLength * 0.9) return "text-amber-500";
    return "text-muted-foreground";
  })();

  return (
    <div className="space-y-2">
      {/* Header with toggle */}
      <div className="flex items-center justify-between">
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={() => setShowPreview(!showPreview)}
          className="h-8 text-xs"
        >
          {showPreview ? (
            <>
              <EyeOff className="mr-1.5 size-3.5" />
              Hide Preview
            </>
          ) : (
            <>
              <Eye className="mr-1.5 size-3.5" />
              Show Preview
            </>
          )}
        </Button>
        <span className={cn("text-xs tabular-nums", charCountClass)}>
          {value.length.toLocaleString()}/{maxLength.toLocaleString()}
        </span>
      </div>

      {/* Editor or Preview */}
      <div
        className="rounded-md border"
        data-color-mode="dark"
      >
        {showPreview ? (
          <div className="min-h-[300px] p-4">
            <MDEditor.Markdown source={value || "*No instructions yet*"} />
          </div>
        ) : (
          <Textarea
            value={value}
            onChange={(e) => onChange(e.target.value)}
            placeholder={placeholder}
            maxLength={maxLength}
            className="min-h-[300px] resize-y border-0 font-mono text-sm focus-visible:ring-0 focus-visible:ring-offset-0"
          />
        )}
      </div>

      {/* Error message */}
      {error && <p className="text-sm text-destructive">{error}</p>}

      {/* Helper text */}
      <p className="text-xs text-muted-foreground">
        Use markdown for formatting. These instructions define your
        Sidekiq&apos;s personality and behavior.
      </p>
    </div>
  );
}
```

Note: Using plain Textarea for editing with MDEditor.Markdown for preview-only. This is simpler and avoids MDEditor's styling conflicts. The full MDEditor can be used if needed, but preview-only approach is cleaner.
  </action>
  <verify>
```bash
cd sidekiq-webapp && pnpm tsc --noEmit
```
Component should compile without errors.
  </verify>
  <done>
InstructionsEditor component created with textarea editing, markdown preview toggle using MDEditor.Markdown, character counter, and error display.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate new components into SidekiqForm</name>
  <files>sidekiq-webapp/src/components/sidekiq/sidekiq-form.tsx</files>
  <action>
Update the SidekiqForm to use the new components:

**1. Add imports at top:**

```typescript
import { ConversationStarters } from "./conversation-starters";
import { InstructionsEditor } from "./instructions-editor";
```

**2. Replace the instructions Textarea field with InstructionsEditor:**

Find the instructions FormField and replace the FormControl content:

```typescript
{/* Instructions field - replace existing */}
<FormField
  control={form.control}
  name="instructions"
  render={({ field, fieldState }) => (
    <FormItem>
      <FormLabel>Instructions *</FormLabel>
      <FormControl>
        <InstructionsEditor
          value={field.value}
          onChange={field.onChange}
          maxLength={8000}
          error={fieldState.error?.message}
        />
      </FormControl>
      {/* Remove the old FormDescription and char count - now in InstructionsEditor */}
      <FormMessage />
    </FormItem>
  )}
/>
```

**3. Add conversation starters field after instructions:**

```typescript
{/* Conversation Starters - add after instructions */}
<FormField
  control={form.control}
  name="conversationStarters"
  render={({ field }) => (
    <FormItem>
      <FormLabel>Conversation Starters</FormLabel>
      <FormControl>
        <ConversationStarters
          value={field.value}
          onChange={field.onChange}
          maxItems={6}
          maxLength={200}
        />
      </FormControl>
      <FormDescription>
        Suggested prompts to help users start conversations
      </FormDescription>
      <FormMessage />
    </FormItem>
  )}
/>
```

**4. Update the SidekiqPreview to show starters in real-time:**

The preview already supports conversationStarters from Plan 04. Verify the preview updates as starters are added/reordered.
  </action>
  <verify>
1. Start dev server: `pnpm dev`
2. Navigate to /sidekiqs/new
3. Instructions field shows preview toggle
4. Add conversation starters - they appear in list
5. Drag to reorder - order updates
6. Preview shows conversation starters
  </verify>
  <done>
SidekiqForm updated with InstructionsEditor and ConversationStarters. Form now supports markdown preview and drag-drop reordering.
  </done>
</task>

</tasks>

<verification>
1. Navigate to /sidekiqs/new
2. Instructions field has Show Preview toggle
3. Toggle preview - markdown renders correctly
4. Add conversation starters - up to 6 allowed
5. Drag handle visible on each starter
6. Drag to reorder - order persists
7. Character counts show for each starter
8. Remove starter - removed from list
9. Preview panel shows starters in real-time
10. Submit form - starters saved correctly
</verification>

<success_criteria>
- InstructionsEditor shows textarea by default, markdown preview on toggle
- ConversationStarters supports add, remove, reorder via drag-and-drop
- Maximum 6 starters, 200 chars each enforced
- Drag handle is keyboard accessible (Tab + Space/Enter)
- Preview updates in real-time as starters change
- Form saves conversation starters correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-sidekiq-crud/06-05-SUMMARY.md`
</output>
