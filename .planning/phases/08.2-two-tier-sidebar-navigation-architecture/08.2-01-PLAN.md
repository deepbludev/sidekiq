---
phase: 08.2-two-tier-sidebar-navigation-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/components/sidebar/sidebar-icon-rail.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx
  - sidekiq-webapp/src/lib/sidebar-utils.ts
autonomous: true

must_haves:
  truths:
    - "Icon rail renders with New Chat button at top, nav icons in middle, settings + user avatar at bottom"
    - "Panel container renders contextual content based on current URL pathname"
    - "SidebarLayout composes icon rail and panel as flex siblings with separator"
  artifacts:
    - path: "sidekiq-webapp/src/lib/sidebar-utils.ts"
      provides: "getActiveFeature() route-to-panel mapping and SidebarFeature type"
      exports: ["getActiveFeature", "SidebarFeature"]
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-icon-rail.tsx"
      provides: "Primary icon rail with tooltipped nav buttons"
      exports: ["SidebarIconRail"]
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx"
      provides: "Secondary panel container with route-based switching"
      exports: ["SidebarPanel"]
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx"
      provides: "Two-tier sidebar composition (rail + separator + panel)"
      exports: ["SidebarLayout"]
  key_links:
    - from: "sidebar-icon-rail.tsx"
      to: "sidebar-utils.ts"
      via: "getActiveFeature(pathname) for active icon highlighting"
      pattern: "getActiveFeature"
    - from: "sidebar-panel.tsx"
      to: "sidebar-utils.ts"
      via: "getActiveFeature(pathname) for panel content switching"
      pattern: "getActiveFeature"
    - from: "sidebar-layout.tsx"
      to: "sidebar-icon-rail.tsx + sidebar-panel.tsx"
      via: "flex siblings composition"
      pattern: "SidebarIconRail.*SidebarPanel"
---

<objective>
Create the core two-tier sidebar structure: icon rail, panel container, and layout composition.

Purpose: Establish the foundational layout components that replace the current single-panel sidebar. The icon rail provides persistent top-level navigation, the panel container handles route-based content switching, and the layout composes them as flex siblings.

Output: Three new components (SidebarIconRail, SidebarPanel, SidebarLayout) and a shared utility for route-to-feature mapping.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-RESEARCH.md
@.planning/phases/8.2-two-tier-sidebar-navigation/8.2-CONTEXT.md

# Key source files for reference
@sidekiq-webapp/src/components/sidebar/sidebar-collapsed.tsx
@sidekiq-webapp/src/components/sidebar/sidebar-header.tsx
@sidekiq-webapp/src/components/sidebar/sidebar-footer.tsx
@sidekiq-webapp/src/components/sidebar/sidebar.tsx
@sidekiq-webapp/src/hooks/use-sidebar-state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create route-to-feature utility and icon rail component</name>
  <files>
    sidekiq-webapp/src/lib/sidebar-utils.ts
    sidekiq-webapp/src/components/sidebar/sidebar-icon-rail.tsx
  </files>
  <action>
    **1. Create `sidekiq-webapp/src/lib/sidebar-utils.ts`:**

    Export a `SidebarFeature` type: `"chats" | "sidekiqs" | "teams"`.

    Export `getActiveFeature(pathname: string): SidebarFeature` function:
    - If `pathname.startsWith("/settings/teams")` -> return `"teams"` (MUST check before general /settings)
    - If `pathname.startsWith("/sidekiqs")` -> return `"sidekiqs"`
    - Default (including /chat, /chat/[id], /) -> return `"chats"`

    This is a pure function (no hooks). Both icon rail and panel import it to derive active state from URL.

    **2. Create `sidekiq-webapp/src/components/sidebar/sidebar-icon-rail.tsx`:**

    "use client" component. Import `usePathname` from next/navigation, `useRouter` from next/navigation, `getActiveFeature` from sidebar-utils.

    Layout: `flex flex-col items-center py-3` with `bg-sidebar w-12 shrink-0 h-full`.

    Structure from top to bottom:
    - **Top section:** New Chat button -- `Button` with `bg-sidebar-primary text-sidebar-primary-foreground size-8 rounded-md`. Icon: `PenSquare` size-4. Wrapped in Tooltip (side="right", label "New Chat"). onClick: `router.push("/chat")`.
    - **Spacer:** `mt-4`
    - **Middle section (nav):** `flex flex-col items-center gap-1`. Three `RailIcon` items:
      - Chats: icon=MessageSquare, label="Chats", href="/chat", isActive when feature === "chats"
      - Sidekiqs: icon=Sparkles, label="Sidekiqs", href="/sidekiqs", isActive when feature === "sidekiqs"
      - Teams: icon=Users, label="Teams", href="/settings/teams", isActive when feature === "teams"
    - **Flex spacer:** `<div className="flex-1" />`
    - **Bottom section:** `flex flex-col items-center gap-1`
      - Settings: RailIcon with icon=Settings, label="Settings", href="/settings", isActive when `pathname?.startsWith("/settings") && activeFeature !== "teams"` (avoid double-highlighting with Teams)
      - User avatar: Extract the avatar rendering from existing `sidebar-footer.tsx` -- use `authClient.useSession()`, show Avatar with initials fallback in a `size-8` circle. Wrap in DropdownMenu with: Settings link, Theme submenu (Light/Dark/System via `useTheme()`), Logout. The dropdown should open side="right" from bottom.

    **RailIcon sub-component** (internal, not exported):
    ```
    interface RailIconProps {
      icon: LucideIcon;
      label: string;
      href: string;
      isActive: boolean;
    }
    ```
    - Render Tooltip wrapping a Button (variant="ghost", size="icon", asChild) containing a Link.
    - className: `size-9 rounded-md text-sidebar-foreground/70 hover:text-sidebar-foreground`
    - Active state: `bg-sidebar-accent text-sidebar-foreground` (use cn() for conditional)
    - Tooltip side="right" with label text.

    Icons to import from lucide-react: PenSquare, MessageSquare, Sparkles, Users, Settings, LogOut, Moon, Sun, Monitor.
  </action>
  <verify>
    Run `npx tsc --noEmit` from sidekiq-webapp/ -- no type errors in new files.
    Check that sidebar-utils.ts exports are importable: `grep -r "getActiveFeature" sidekiq-webapp/src/`
  </verify>
  <done>
    sidebar-utils.ts exports SidebarFeature type and getActiveFeature pure function. sidebar-icon-rail.tsx renders icon rail with New Chat, 3 nav icons, Settings, and user avatar dropdown. Active state derived from usePathname() via getActiveFeature().
  </done>
</task>

<task type="auto">
  <name>Task 2: Create panel container and sidebar layout composition</name>
  <files>
    sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx
    sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx
  </files>
  <action>
    **1. Create `sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx`:**

    "use client" component. Import `usePathname`, `getActiveFeature` from sidebar-utils, `cn` from utils.

    For now, render placeholder panel content (the actual panel components are created in Plan 02). Use stub divs with feature name text so the layout is testable:

    ```tsx
    export function SidebarPanel() {
      const pathname = usePathname();
      const activeFeature = getActiveFeature(pathname ?? "/chat");

      return (
        <div className="flex h-full w-72 shrink-0 flex-col overflow-hidden bg-sidebar">
          {/* All panels stay mounted -- hidden/block preserves scroll position */}
          <div className={cn("flex h-full flex-col", activeFeature !== "chats" && "hidden")}>
            {/* SidebarPanelChats will be added in Plan 02 */}
            <div className="p-4 text-sidebar-foreground text-sm">Chats Panel (placeholder)</div>
          </div>
          <div className={cn("flex h-full flex-col", activeFeature !== "sidekiqs" && "hidden")}>
            {/* SidebarPanelSidekiqs will be added in Plan 02 */}
            <div className="p-4 text-sidebar-foreground text-sm">Sidekiqs Panel (placeholder)</div>
          </div>
          <div className={cn("flex h-full flex-col", activeFeature !== "teams" && "hidden")}>
            {/* SidebarPanelTeams will be added in Plan 02 */}
            <div className="p-4 text-sidebar-foreground text-sm">Teams Panel (placeholder)</div>
          </div>
        </div>
      );
    }
    ```

    IMPORTANT: Use `hidden` class (display:none) for inactive panels, NOT conditional rendering. This preserves component state (TanStack Virtual scroll position) when switching panels.

    **2. Create `sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx`:**

    "use client" component. Composes the two-tier sidebar:

    ```tsx
    export function SidebarLayout() {
      return (
        <aside className="border-sidebar-border flex h-full w-[336px] shrink-0 border-r">
          <SidebarIconRail />
          <Separator orientation="vertical" className="h-full" />
          <SidebarPanel />
        </aside>
      );
    }
    ```

    Total width: w-[336px] = 48px rail + 288px panel (matching the research spec). Use `shrink-0` so main content doesn't push the sidebar. Import Separator from Radix (already in project as `@sidekiq/components/ui/separator`).

    The border-r on the aside provides the outer sidebar border. The Separator provides a visual divider between rail and panel.
  </action>
  <verify>
    Run `npx tsc --noEmit` from sidekiq-webapp/ -- no type errors.
    Verify SidebarLayout is importable and composes SidebarIconRail + SidebarPanel.
  </verify>
  <done>
    SidebarPanel renders route-based panel content using hidden/block for state preservation. SidebarLayout composes icon rail + separator + panel in a 336px-wide flex container. All three new core components compile without errors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors in the new files
- sidebar-utils.ts getActiveFeature returns correct feature for: "/chat" -> "chats", "/sidekiqs" -> "sidekiqs", "/settings/teams" -> "teams", "/settings" -> "chats" (default)
- SidebarLayout renders a 336px sidebar with icon rail (48px) and panel (288px)
- Icon rail has correct vertical layout: New Chat at top, nav icons in middle, settings + avatar at bottom
</verification>

<success_criteria>
- Four new files created and type-checking
- Route-based panel switching logic centralized in sidebar-utils.ts
- Icon rail has all required icons with tooltip labels
- User avatar dropdown includes Settings, Theme toggle, and Logout
- Panel container uses hidden/block pattern (not conditional render)
- Layout composes rail + separator + panel at fixed 336px width
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-01-SUMMARY.md`
</output>
