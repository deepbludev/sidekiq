---
phase: 08.2-two-tier-sidebar-navigation-architecture
plan: 03
type: execute
wave: 2
depends_on: ["08.2-01", "08.2-02"]
files_modified:
  - sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx
  - sidekiq-webapp/src/app/(dashboard)/layout.tsx
  - sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx
  - sidekiq-webapp/src/app/(dashboard)/settings/layout.tsx
  - sidekiq-webapp/src/app/(dashboard)/sidekiqs/layout.tsx
  - sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts
autonomous: true

must_haves:
  truths:
    - "Two-tier sidebar is visible on all dashboard routes (chat, sidekiqs, settings)"
    - "Switching between /chat, /sidekiqs, and /settings/teams shows correct panel content"
    - "Cmd+B toggles panel visibility, Cmd+K focuses search, Cmd+N creates new chat"
    - "Panel collapses to show only icon rail when toggled via Cmd+B or re-clicking active icon"
    - "Settings pages render their content area alongside the sidebar (not full-page-only)"
  artifacts:
    - path: "sidekiq-webapp/src/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with two-tier sidebar for all routes"
      contains: "SidebarLayout"
    - path: "sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx"
      provides: "Chat layout without sidebar (sidebar now in parent layout)"
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx"
      provides: "Updated panel with real panel components (not placeholders)"
      contains: "SidebarPanelChats"
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx"
      provides: "Layout with panel collapsibility and keyboard shortcuts"
      contains: "useKeyboardShortcuts"
  key_links:
    - from: "(dashboard)/layout.tsx"
      to: "sidebar-layout.tsx"
      via: "renders SidebarLayout in flex container"
      pattern: "SidebarLayout"
    - from: "sidebar-layout.tsx"
      to: "use-keyboard-shortcuts.ts"
      via: "registers Cmd+B, Cmd+K, Cmd+N, Cmd+Shift+S shortcuts"
      pattern: "useKeyboardShortcuts"
    - from: "sidebar-panel.tsx"
      to: "sidebar-panel-chats.tsx + sidebar-panel-sidekiqs.tsx + sidebar-panel-teams.tsx"
      via: "renders panels with hidden/block visibility"
      pattern: "SidebarPanelChats|SidebarPanelSidekiqs|SidebarPanelTeams"
---

<objective>
Wire the two-tier sidebar into the dashboard layout, replace placeholder panels with real content, add panel collapsibility, and adapt keyboard shortcuts.

Purpose: This plan connects Plans 01 and 02, elevates the sidebar from chat-only to all dashboard routes, and implements the interactive behaviors (panel toggle, keyboard shortcuts, re-click-to-collapse).

Output: Fully functional two-tier sidebar visible across all dashboard routes with keyboard shortcuts and panel collapsibility.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-RESEARCH.md
@.planning/phases/8.2-two-tier-sidebar-navigation/8.2-CONTEXT.md
@.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-01-SUMMARY.md
@.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-02-SUMMARY.md

# Current layout files
@sidekiq-webapp/src/app/(dashboard)/layout.tsx
@sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx
@sidekiq-webapp/src/app/(dashboard)/settings/layout.tsx
@sidekiq-webapp/src/app/(dashboard)/sidekiqs/layout.tsx
@sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts
@sidekiq-webapp/src/hooks/use-sidebar-state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire panels into SidebarPanel and add collapsibility to SidebarLayout</name>
  <files>
    sidekiq-webapp/src/components/sidebar/sidebar-panel.tsx
    sidekiq-webapp/src/components/sidebar/sidebar-layout.tsx
    sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts
  </files>
  <action>
    **1. Update `sidebar-panel.tsx`:**

    Replace the placeholder divs with real panel components:
    - Import `SidebarPanelChats`, `SidebarPanelSidekiqs`, `SidebarPanelTeams` from their respective files.
    - Accept a `searchInputRef` prop and pass it to SidebarPanelChats.
    - Keep the hidden/block pattern for panel visibility:

    ```tsx
    interface SidebarPanelProps {
      searchInputRef?: React.RefObject<HTMLInputElement | null>;
    }

    export function SidebarPanel({ searchInputRef }: SidebarPanelProps) {
      const pathname = usePathname();
      const activeFeature = getActiveFeature(pathname ?? "/chat");

      return (
        <div className="flex h-full w-72 shrink-0 flex-col overflow-hidden bg-sidebar">
          <div className={cn("flex h-full flex-col", activeFeature !== "chats" && "hidden")}>
            <SidebarPanelChats searchInputRef={searchInputRef} />
          </div>
          <div className={cn("flex h-full flex-col", activeFeature !== "sidekiqs" && "hidden")}>
            <SidebarPanelSidekiqs />
          </div>
          <div className={cn("flex h-full flex-col", activeFeature !== "teams" && "hidden")}>
            <SidebarPanelTeams />
          </div>
        </div>
      );
    }
    ```

    **2. Update `sidebar-layout.tsx`:**

    Add panel collapsibility and keyboard shortcuts:

    - Add local state for panel collapsed: `const [isPanelCollapsed, setIsPanelCollapsed] = useState(false)`. Use localStorage key `"sidebar-panel-collapsed"` for persistence (same SSR-safe lazy initializer pattern as use-sidebar-state.ts).
    - Create a `useRef<HTMLInputElement>(null)` for search input and pass it through to SidebarPanel -> SidebarPanelChats.
    - Add state for `sidekiqPickerOpen` to support Cmd+Shift+S.
    - Register keyboard shortcuts via `useKeyboardShortcuts`:
      - `onNewChat: () => router.push("/chat")`
      - `onToggleSidebar: () => setIsPanelCollapsed(prev => !prev)` -- Cmd+B now toggles panel, not old sidebar collapse
      - `onFocusSearch: () => searchInputRef.current?.focus()` -- Cmd+K
      - `onOpenSidekiqPicker: () => setSidekiqPickerOpen(true)` -- Cmd+Shift+S

    - Render the SidekiqPicker dialog (import from `@sidekiq/components/sidekiq/sidekiq-picker`).

    - Layout with transition:
    ```tsx
    <aside className={cn(
      "border-sidebar-border flex h-full shrink-0 border-r transition-all duration-200 ease-out",
      isPanelCollapsed ? "w-12" : "w-[336px]"
    )}>
      <SidebarIconRail onIconReClick={() => setIsPanelCollapsed(prev => !prev)} />
      {!isPanelCollapsed && (
        <>
          <Separator orientation="vertical" className="h-full" />
          <SidebarPanel searchInputRef={searchInputRef} />
        </>
      )}
    </aside>
    ```

    - Pass `onIconReClick` prop to SidebarIconRail. When user clicks an already-active icon, it toggles the panel visibility. This provides a natural toggle mechanism.

    **3. Update `sidebar-icon-rail.tsx`:**

    Add `onIconReClick?: () => void` to props. In each RailIcon, if `isActive && onIconReClick`, call `onIconReClick()` instead of navigating. If not active, navigate normally via Link.

    **4. Update `use-keyboard-shortcuts.ts`:**

    No changes needed -- the hook already supports all required shortcuts (onNewChat, onToggleSidebar, onFocusSearch, onOpenSidekiqPicker). The sidebar-layout.tsx will wire different handlers than the old sidebar.tsx did.
  </action>
  <verify>
    Run `npx tsc --noEmit` from sidekiq-webapp/ -- no type errors.
    Verify SidebarLayout imports and renders real panel components.
    Verify panel collapse transition classes are applied.
  </verify>
  <done>
    SidebarPanel renders real panel content components with hidden/block switching. SidebarLayout supports panel collapse via Cmd+B and icon re-click with 200ms transition. Keyboard shortcuts wired to new layout. SidekiqPicker dialog integrated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Elevate sidebar to dashboard layout and update route layouts</name>
  <files>
    sidekiq-webapp/src/app/(dashboard)/layout.tsx
    sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx
    sidekiq-webapp/src/app/(dashboard)/settings/layout.tsx
    sidekiq-webapp/src/app/(dashboard)/sidekiqs/layout.tsx
  </files>
  <action>
    **1. Update `(dashboard)/layout.tsx`:**

    This is the KEY change. The sidebar currently lives in `chat/layout.tsx` and is only visible on chat pages. It needs to be in the dashboard layout so it's visible on ALL dashboard routes (/chat, /sidekiqs, /settings).

    ```tsx
    import { redirect } from "next/navigation";
    import { getSession } from "@sidekiq/server/better-auth/server";
    import { TooltipProvider } from "@sidekiq/components/ui/tooltip";
    import { SidebarLayout } from "@sidekiq/components/sidebar/sidebar-layout";

    export default async function DashboardLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      const session = await getSession();

      if (!session) {
        redirect("/sign-in");
      }

      return (
        <TooltipProvider>
          <div className="bg-background flex h-screen">
            {/* Desktop: Two-tier sidebar */}
            <div className="hidden md:flex">
              <SidebarLayout />
            </div>

            {/* Main content area */}
            <main className="flex-1 overflow-hidden">
              {children}
            </main>
          </div>
        </TooltipProvider>
      );
    }
    ```

    IMPORTANT: SidebarLayout is a "use client" component but the dashboard layout is a server component. This works because SidebarLayout is imported as a client component boundary -- React Server Components support this pattern. The TooltipProvider (also a client component) wraps everything.

    Note: The mobile tab bar is handled in Plan 04. For now, mobile falls back to no sidebar (acceptable intermediate state).

    **2. Update `chat/layout.tsx`:**

    Remove the sidebar, SidebarMobile, and TooltipProvider from chat layout. The sidebar is now in the parent dashboard layout. The chat layout becomes minimal:

    ```tsx
    export default function ChatLayout({
      children,
    }: {
      children: React.ReactNode;
    }) {
      return <>{children}</>;
    }
    ```

    The mobile header with hamburger menu is also removed -- it will be replaced by the mobile bottom tab bar in Plan 04.

    **3. Update `settings/layout.tsx`:**

    Remove the "Back to chat" arrow button from settings layout. The sidebar is now always visible, so users navigate via the icon rail -- no need for a back button. Keep the settings nav sidebar (Profile, Teams) and content layout. Remove the `container` wrapper and adjust max-width since the content now sits next to the sidebar:

    ```tsx
    export default function SettingsLayout({ children }: { children: ReactNode }) {
      const pathname = usePathname();

      return (
        <div className="mx-auto max-w-4xl p-8">
          <h1 className="text-2xl font-bold mb-6">Settings</h1>

          <div className="flex flex-col gap-8 md:flex-row">
            <nav className="w-full space-y-1 md:w-48">
              {settingsNav.map((item) => {
                // ... same nav rendering ...
              })}
            </nav>
            <div className="flex-1">{children}</div>
          </div>
        </div>
      );
    }
    ```

    **4. Update `sidekiqs/layout.tsx`:**

    No structural changes needed -- it just wraps children with metadata. Keep as-is.
  </action>
  <verify>
    Run `npx tsc --noEmit` from sidekiq-webapp/ -- no type errors.
    Run `npm run build` from sidekiq-webapp/ to verify the layout renders without SSR issues.
    Verify that navigating to /chat, /sidekiqs, and /settings all show the two-tier sidebar.
  </verify>
  <done>
    Sidebar elevated from chat-only to dashboard-wide. Chat layout simplified (sidebar removed). Settings layout updated (back button removed). Two-tier sidebar visible on all routes: /chat shows Chats panel, /sidekiqs shows Sidekiqs panel, /settings/teams shows Teams panel. Settings icon navigates to /settings full page.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds without hydration or layout errors
- Navigating to /chat shows icon rail with Chats active + Chats panel
- Navigating to /sidekiqs shows icon rail with Sidekiqs active + Sidekiqs panel
- Navigating to /settings/teams shows icon rail with Teams active + Teams panel
- Navigating to /settings shows Settings icon active, Chats panel (default)
- Cmd+B toggles panel visibility (collapse to icon-rail-only)
- Cmd+K focuses search input in Chats panel
- Cmd+N navigates to /chat (new chat)
- Cmd+Shift+S opens Sidekiq picker dialog
</verification>

<success_criteria>
- Two-tier sidebar renders on all dashboard routes (chat, sidekiqs, settings)
- Panel content switches based on URL pathname (not state)
- Panel collapse works with 200ms transition, persists to localStorage
- Re-clicking active icon toggles panel visibility
- All four keyboard shortcuts (Cmd+B/K/N/Shift+S) work correctly
- No hydration mismatches between server and client render
</success_criteria>

<output>
After completion, create `.planning/phases/08.2-two-tier-sidebar-navigation-architecture/08.2-03-SUMMARY.md`
</output>
