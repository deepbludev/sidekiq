---
phase: 09-vertical-slice-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/tsconfig.json
  - sidekiq-webapp/vitest.config.ts
  - sidekiq-webapp/drizzle.config.ts
  - sidekiq-webapp/next.config.js
  - sidekiq-webapp/src/shared/db/index.ts
  - sidekiq-webapp/src/shared/db/schema.ts
  - sidekiq-webapp/src/shared/db/reset-and-seed.ts
  - sidekiq-webapp/src/shared/trpc/trpc.ts
  - sidekiq-webapp/src/shared/trpc/root.ts
  - sidekiq-webapp/src/shared/trpc/react.tsx
  - sidekiq-webapp/src/shared/trpc/server.ts
  - sidekiq-webapp/src/shared/trpc/query-client.ts
  - sidekiq-webapp/src/shared/trpc/routers/health.ts
  - sidekiq-webapp/src/shared/lib/utils.ts
  - sidekiq-webapp/src/shared/lib/avatar.ts
  - sidekiq-webapp/src/shared/lib/date-grouping.ts
  - sidekiq-webapp/src/shared/lib/blob.ts
  - sidekiq-webapp/src/shared/lib/sidebar-utils.ts
  - sidekiq-webapp/src/shared/env.js
  - sidekiq-webapp/src/shared/constants/emoji-data.ts
autonomous: true

must_haves:
  truths:
    - "TypeScript compilation passes with new path aliases resolving correctly"
    - "Vitest alias configuration mirrors tsconfig paths"
    - "Drizzle config points to new schema location and generates no unexpected migrations"
    - "Next.js config loads env.js from new shared/ location"
    - "All shared server infrastructure (db, trpc, lib) lives under src/shared/"
  artifacts:
    - path: "sidekiq-webapp/tsconfig.json"
      provides: "Path aliases for all 7 features + shared + ui + fallback"
      contains: "@sidekiq/chats"
    - path: "sidekiq-webapp/vitest.config.ts"
      provides: "Mirrored path aliases for test resolution"
      contains: "@sidekiq/chats"
    - path: "sidekiq-webapp/drizzle.config.ts"
      provides: "Updated schema path"
      contains: "shared/db/schema"
    - path: "sidekiq-webapp/src/shared/db/schema.ts"
      provides: "Centralized Drizzle schema (moved from server/db/)"
    - path: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      provides: "tRPC procedures and context (moved from server/api/)"
    - path: "sidekiq-webapp/src/shared/env.js"
      provides: "Environment validation (moved from src/env.js)"
  key_links:
    - from: "sidekiq-webapp/drizzle.config.ts"
      to: "sidekiq-webapp/src/shared/db/schema.ts"
      via: "schema file path string"
      pattern: "schema.*shared/db/schema"
    - from: "sidekiq-webapp/next.config.js"
      to: "sidekiq-webapp/src/shared/env.js"
      via: "static import path"
      pattern: "import.*src/shared/env"
    - from: "sidekiq-webapp/tsconfig.json"
      to: "sidekiq-webapp/src/features/*/index.ts"
      via: "path alias mapping"
      pattern: "@sidekiq/chats.*features/chats"
---

<objective>
Set up the configuration foundation for the vertical slice architecture and move all shared server-side infrastructure to `src/shared/`.

Purpose: This is the foundational plan that all other plans depend on. Path aliases must be configured before any file moves, and shared infrastructure (db, trpc, lib) must move first because every feature imports from these.
Output: Updated config files (tsconfig, vitest, drizzle, next.config), directory skeleton for features/ and shared/, and all server-side shared code relocated with imports fixed.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-vertical-slice-architecture/09-CONTEXT.md
@.planning/phases/09-vertical-slice-architecture/09-RESEARCH.md
@sidekiq-webapp/tsconfig.json
@sidekiq-webapp/vitest.config.ts
@sidekiq-webapp/drizzle.config.ts
@sidekiq-webapp/next.config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create directory skeleton and update all config files</name>
  <files>
    sidekiq-webapp/tsconfig.json
    sidekiq-webapp/vitest.config.ts
    sidekiq-webapp/drizzle.config.ts
    sidekiq-webapp/next.config.js
  </files>
  <action>
1. Create the full directory skeleton under `sidekiq-webapp/src/`:
   ```
   features/chats/components/
   features/chats/hooks/
   features/chats/api/
   features/sidekiqs/components/
   features/sidekiqs/hooks/
   features/sidekiqs/api/
   features/sidekiqs/constants/
   features/auth/components/
   features/auth/api/
   features/user/api/
   features/user/hooks/
   features/ai/components/
   features/ai/hooks/
   features/ai/api/
   features/workspace/components/
   features/workspace/hooks/
   features/workspace/api/
   features/billing/
   shared/ui/
   shared/db/
   shared/trpc/routers/
   shared/lib/
   shared/icons/
   shared/theme/
   shared/layout/
   shared/constants/
   ```
   Use `mkdir -p` for each path.

2. Update `tsconfig.json` paths. Replace the single `@sidekiq/*` alias with the full set of aliases. CRITICAL: Specific aliases MUST come before the wildcard fallback so TypeScript resolves them first:
   ```json
   "paths": {
     "@sidekiq/chats": ["./src/features/chats/index.ts"],
     "@sidekiq/chats/*": ["./src/features/chats/*"],
     "@sidekiq/sidekiqs": ["./src/features/sidekiqs/index.ts"],
     "@sidekiq/sidekiqs/*": ["./src/features/sidekiqs/*"],
     "@sidekiq/auth": ["./src/features/auth/index.ts"],
     "@sidekiq/auth/*": ["./src/features/auth/*"],
     "@sidekiq/user": ["./src/features/user/index.ts"],
     "@sidekiq/user/*": ["./src/features/user/*"],
     "@sidekiq/ai": ["./src/features/ai/index.ts"],
     "@sidekiq/ai/*": ["./src/features/ai/*"],
     "@sidekiq/workspace": ["./src/features/workspace/index.ts"],
     "@sidekiq/workspace/*": ["./src/features/workspace/*"],
     "@sidekiq/billing": ["./src/features/billing/index.ts"],
     "@sidekiq/billing/*": ["./src/features/billing/*"],
     "@sidekiq/shared/*": ["./src/shared/*"],
     "@sidekiq/ui/*": ["./src/shared/ui/*"],
     "@sidekiq/*": ["./src/*"]
   }
   ```
   The last `@sidekiq/*` fallback keeps ALL existing imports working during the migration. As files move, their importers will be updated to use the new specific aliases.

3. Update `vitest.config.ts` resolve aliases to mirror tsconfig. Use `path.resolve(__dirname, ...)` for each alias. Add feature barrel aliases AND shared aliases. Keep the existing `@sidekiq` fallback pointing to `./src`. The alias resolution order matters -- list specific aliases first:
   ```typescript
   resolve: {
     alias: [
       { find: "@sidekiq/chats", replacement: path.resolve(__dirname, "./src/features/chats/index.ts") },
       { find: "@sidekiq/sidekiqs", replacement: path.resolve(__dirname, "./src/features/sidekiqs/index.ts") },
       { find: "@sidekiq/auth", replacement: path.resolve(__dirname, "./src/features/auth/index.ts") },
       { find: "@sidekiq/user", replacement: path.resolve(__dirname, "./src/features/user/index.ts") },
       { find: "@sidekiq/ai", replacement: path.resolve(__dirname, "./src/features/ai/index.ts") },
       { find: "@sidekiq/workspace", replacement: path.resolve(__dirname, "./src/features/workspace/index.ts") },
       { find: "@sidekiq/billing", replacement: path.resolve(__dirname, "./src/features/billing/index.ts") },
       { find: /^@sidekiq\/shared\/(.*)/, replacement: path.resolve(__dirname, "./src/shared/$1") },
       { find: /^@sidekiq\/ui\/(.*)/, replacement: path.resolve(__dirname, "./src/shared/ui/$1") },
       { find: /^@sidekiq\/(.*)/, replacement: path.resolve(__dirname, "./src/$1") },
     ],
   }
   ```
   Use the array form for aliases (not object form) to control resolution order. Use regex patterns for wildcard aliases.

4. Update `drizzle.config.ts`: Change schema path from `"./src/server/db/schema.ts"` to `"./src/shared/db/schema.ts"`. Do NOT change the import of env -- it still uses `@sidekiq/env` which resolves via fallback until env.js is moved.

5. Update `next.config.js`: Change the import from `"./src/env.js"` to `"./src/shared/env.js"`. This is a raw filesystem path (not a TypeScript alias), so it must be updated when env.js moves.
  </action>
  <verify>
Run `cd sidekiq-webapp && npx tsc --noEmit 2>&1 | head -20` -- should pass or show only pre-existing errors (not new alias resolution errors). The new aliases should resolve via fallback to the old locations for files not yet moved.
  </verify>
  <done>
tsconfig.json has all feature + shared aliases. vitest.config.ts mirrors them. drizzle.config.ts points to new schema path. next.config.js points to new env.js path. All directories created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move shared server infrastructure (db, trpc, lib, env) and fix all imports</name>
  <files>
    sidekiq-webapp/src/shared/db/index.ts
    sidekiq-webapp/src/shared/db/schema.ts
    sidekiq-webapp/src/shared/db/reset-and-seed.ts
    sidekiq-webapp/src/shared/trpc/trpc.ts
    sidekiq-webapp/src/shared/trpc/root.ts
    sidekiq-webapp/src/shared/trpc/react.tsx
    sidekiq-webapp/src/shared/trpc/server.ts
    sidekiq-webapp/src/shared/trpc/query-client.ts
    sidekiq-webapp/src/shared/trpc/routers/health.ts
    sidekiq-webapp/src/shared/lib/utils.ts
    sidekiq-webapp/src/shared/lib/avatar.ts
    sidekiq-webapp/src/shared/lib/date-grouping.ts
    sidekiq-webapp/src/shared/lib/blob.ts
    sidekiq-webapp/src/shared/lib/sidebar-utils.ts
    sidekiq-webapp/src/shared/env.js
    sidekiq-webapp/src/shared/constants/emoji-data.ts
  </files>
  <action>
Move files using `git mv` from their current locations to `src/shared/`. This is a mechanical operation -- file contents do NOT change (except import paths within the moved files).

**Move operations (all paths relative to sidekiq-webapp/src/):**

Database (3 files):
- `git mv server/db/index.ts shared/db/index.ts`
- `git mv server/db/schema.ts shared/db/schema.ts`
- `git mv server/db/reset-and-seed.ts shared/db/reset-and-seed.ts`

tRPC infrastructure (5 files from server/api/ + 3 from trpc/):
- `git mv server/api/trpc.ts shared/trpc/trpc.ts`
- `git mv server/api/root.ts shared/trpc/root.ts`
- `git mv server/api/routers/health.ts shared/trpc/routers/health.ts`
- `git mv trpc/react.tsx shared/trpc/react.tsx`
- `git mv trpc/server.ts shared/trpc/server.ts`
- `git mv trpc/query-client.ts shared/trpc/query-client.ts`

Library utilities (5 files):
- `git mv lib/utils.ts shared/lib/utils.ts`
- `git mv lib/utils/avatar.ts shared/lib/avatar.ts` (flatten utils/ subdirectory)
- `git mv lib/date-grouping.ts shared/lib/date-grouping.ts`
- `git mv lib/blob.ts shared/lib/blob.ts`
- `git mv lib/sidebar-utils.ts shared/lib/sidebar-utils.ts`

Environment:
- `git mv env.js shared/env.js`

Constants:
- `git mv lib/constants/emoji-data.ts shared/constants/emoji-data.ts`

**After moves, fix imports.** Use `tsc --noEmit` to find all broken imports. For each broken import:

Old import path -> New import path:
- `@sidekiq/server/db` -> `@sidekiq/shared/db`
- `@sidekiq/server/db/schema` -> `@sidekiq/shared/db/schema`
- `@sidekiq/server/api/trpc` -> `@sidekiq/shared/trpc/trpc`
- `@sidekiq/server/api/root` -> `@sidekiq/shared/trpc/root`
- `@sidekiq/trpc/react` -> `@sidekiq/shared/trpc/react`
- `@sidekiq/trpc/server` -> `@sidekiq/shared/trpc/server`
- `@sidekiq/trpc/query-client` -> `@sidekiq/shared/trpc/query-client`
- `@sidekiq/lib/utils` -> `@sidekiq/shared/lib/utils`
- `@sidekiq/lib/utils/avatar` -> `@sidekiq/shared/lib/avatar`
- `@sidekiq/lib/date-grouping` -> `@sidekiq/shared/lib/date-grouping`
- `@sidekiq/lib/blob` -> `@sidekiq/shared/lib/blob`
- `@sidekiq/lib/sidebar-utils` -> `@sidekiq/shared/lib/sidebar-utils`
- `@sidekiq/env` -> `@sidekiq/shared/env`
- `@sidekiq/lib/constants/emoji-data` -> `@sidekiq/shared/constants/emoji-data`

Also update relative imports within the moved files themselves. For example, `shared/db/index.ts` may import from `./schema` -- that relative import still works after the move since both files moved together. But if `shared/trpc/trpc.ts` imports from `@sidekiq/server/db`, that must change to `@sidekiq/shared/db`.

Also update imports in test files under `sidekiq-webapp/tests/` that reference moved paths:
- `@sidekiq/lib/date-grouping` -> `@sidekiq/shared/lib/date-grouping`
- `@sidekiq/lib/sidebar-utils` -> `@sidekiq/shared/lib/sidebar-utils`
- `@sidekiq/lib/team-permissions` -> leave as-is (not moved yet)
- `@sidekiq/lib/utils/avatar` -> `@sidekiq/shared/lib/avatar`
- `@sidekiq/lib/ai/*` -> leave as-is (not moved yet)
- `@sidekiq/middleware` -> leave as-is (middleware stays at src root)

**IMPORTANT:** Do NOT move the tRPC route handler (`src/app/api/trpc/[trpc]/route.ts`) -- it stays in `app/`. Only its imports change.

**IMPORTANT:** Do NOT move the feature routers (thread, sidekiq, team, user) yet -- those move in later plans. Only the health router moves now (it's cross-cutting, not feature-specific).

After fixing all imports, run `tsc --noEmit` again. Iterate until clean. Then run `vitest run` to verify tests pass.
  </action>
  <verify>
Run these commands in sequence from `sidekiq-webapp/`:
1. `npx tsc --noEmit` -- zero errors
2. `npx vitest run` -- all existing unit tests pass
3. Verify `src/server/db/` directory is empty (all files moved)
4. Verify `src/trpc/` directory is empty (all files moved)
5. Verify `src/env.js` no longer exists (moved to shared/)
  </verify>
  <done>
All shared server infrastructure lives under `src/shared/`. All imports across the codebase updated to use `@sidekiq/shared/*` paths. TypeScript compiles cleanly. All unit tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd sidekiq-webapp && npx tsc --noEmit` passes with zero errors
2. `cd sidekiq-webapp && npx vitest run` -- all unit tests pass
3. `ls sidekiq-webapp/src/shared/db/` shows index.ts, schema.ts, reset-and-seed.ts
4. `ls sidekiq-webapp/src/shared/trpc/` shows trpc.ts, root.ts, react.tsx, server.ts, query-client.ts
5. `ls sidekiq-webapp/src/shared/lib/` shows utils.ts, avatar.ts, date-grouping.ts, blob.ts, sidebar-utils.ts
6. `cat sidekiq-webapp/src/shared/env.js` exists
7. Old directories (`server/db/`, `trpc/`) should be empty or removed
</verification>

<success_criteria>
- All 4 config files updated with new alias paths
- 16 files moved from server/, trpc/, lib/, env.js to shared/
- All 368+ imports across the codebase updated where they reference moved files
- `tsc --noEmit` passes cleanly
- `vitest run` passes all existing tests
- Directory skeleton exists for all 7 features + shared subdirs
</success_criteria>

<output>
After completion, create `.planning/phases/09-vertical-slice-architecture/09-01-SUMMARY.md`
</output>
