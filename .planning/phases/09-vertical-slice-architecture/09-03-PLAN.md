---
phase: 09-vertical-slice-architecture
plan: 03
type: execute
wave: 3
depends_on: ["09-02"]
files_modified:
  - sidekiq-webapp/src/features/chats/components/ (12 chat + 5 thread + 3 sidebar)
  - sidekiq-webapp/src/features/chats/hooks/ (5 hooks)
  - sidekiq-webapp/src/features/chats/api/router.ts
  - sidekiq-webapp/src/features/chats/validations.ts
  - sidekiq-webapp/src/app/(dashboard)/chat/ (page imports)
  - sidekiq-webapp/tests/unit/components/chat/ (test imports)
  - sidekiq-webapp/tests/unit/components/thread/ (test imports)
autonomous: true

must_haves:
  truths:
    - "All chat and thread components are importable from src/features/chats/"
    - "Chat hooks resolve from features/chats/hooks/"
    - "Thread tRPC router lives at features/chats/api/router.ts"
    - "Chat validation schemas live at features/chats/validations.ts"
    - "Chat-related sidebar panels belong to the chats feature"
  artifacts:
    - path: "sidekiq-webapp/src/features/chats/components/chat-interface.tsx"
      provides: "Main chat UI component"
    - path: "sidekiq-webapp/src/features/chats/api/router.ts"
      provides: "Thread tRPC router (moved from server/api/routers/thread.ts)"
    - path: "sidekiq-webapp/src/features/chats/validations.ts"
      provides: "Merged chat + thread Zod validation schemas"
    - path: "sidekiq-webapp/src/features/chats/hooks/use-thread-actions.ts"
      provides: "Thread CRUD operations hook"
  key_links:
    - from: "sidekiq-webapp/src/features/chats/api/router.ts"
      to: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      via: "createTRPCRouter import"
      pattern: "from \"@sidekiq/shared/trpc/trpc\""
    - from: "sidekiq-webapp/src/features/chats/components/chat-interface.tsx"
      to: "sidekiq-webapp/src/features/chats/hooks/"
      via: "hook imports"
      pattern: "from \"\\.\\./hooks/"
---

<objective>
Move all chat and thread code into the `src/features/chats/` feature slice -- components, hooks, router, validations, and sidebar panels.

Purpose: The chats feature is the largest slice (~25 source files). Moving it establishes the feature slice pattern that remaining features follow. Chat and thread are a single domain (threads contain chat messages), so they belong in one slice.
Output: Complete chats feature slice with components, hooks, api/router.ts, and validations.ts.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-vertical-slice-architecture/09-CONTEXT.md
@.planning/phases/09-vertical-slice-architecture/09-RESEARCH.md
@.planning/phases/09-vertical-slice-architecture/09-01-SUMMARY.md
@.planning/phases/09-vertical-slice-architecture/09-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Move chat components, thread components, and sidebar panels to features/chats/</name>
  <files>
    sidekiq-webapp/src/features/chats/components/ (20 files)
    sidekiq-webapp/src/features/chats/hooks/ (5 files)
  </files>
  <action>
Move all chat-domain files into the chats feature slice. All paths relative to `sidekiq-webapp/src/`.

**Chat components (12 files):**
```bash
git mv components/chat/chat-header.tsx features/chats/components/chat-header.tsx
git mv components/chat/chat-input.tsx features/chats/components/chat-input.tsx
git mv components/chat/chat-interface.tsx features/chats/components/chat-interface.tsx
git mv components/chat/chat-scroll-anchor.tsx features/chats/components/chat-scroll-anchor.tsx
git mv components/chat/empty-state.tsx features/chats/components/empty-state.tsx
git mv components/chat/message-actions.tsx features/chats/components/message-actions.tsx
git mv components/chat/message-content.tsx features/chats/components/message-content.tsx
git mv components/chat/message-item.tsx features/chats/components/message-item.tsx
git mv components/chat/message-list.tsx features/chats/components/message-list.tsx
git mv components/chat/model-switch-hint.tsx features/chats/components/model-switch-hint.tsx
git mv components/chat/scroll-to-bottom.tsx features/chats/components/scroll-to-bottom.tsx
git mv components/chat/typing-indicator.tsx features/chats/components/typing-indicator.tsx
```

**Thread components (5 files):**
```bash
git mv components/thread/delete-thread-dialog.tsx features/chats/components/delete-thread-dialog.tsx
git mv components/thread/rename-thread-input.tsx features/chats/components/rename-thread-input.tsx
git mv components/thread/thread-context-menu.tsx features/chats/components/thread-context-menu.tsx
git mv components/thread/thread-item.tsx features/chats/components/thread-item.tsx
```
Also move/remove the thread barrel file (`components/thread/index.ts`) -- its exports will be handled by the chats feature barrel in Plan 06.

**Sidebar panels that belong to chats (3 files):**
```bash
git mv components/sidebar/sidebar-panel-chats.tsx features/chats/components/sidebar-panel-chats.tsx
git mv components/sidebar/sidebar-thread-list.tsx features/chats/components/sidebar-thread-list.tsx
git mv components/sidebar/sidebar-thread-group.tsx features/chats/components/sidebar-thread-group.tsx
```

**Hooks (5 files):**
```bash
git mv hooks/use-thread-actions.ts features/chats/hooks/use-thread-actions.ts
git mv hooks/use-auto-scroll.ts features/chats/hooks/use-auto-scroll.ts
git mv hooks/use-scroll-position.ts features/chats/hooks/use-scroll-position.ts
git mv hooks/use-keyboard-shortcuts.ts features/chats/hooks/use-keyboard-shortcuts.ts
git mv hooks/use-thread-search.tsx features/chats/hooks/use-thread-search.tsx
```

**After moves, fix imports within the moved files.** Each moved file may import:
- UI components: should already be `@sidekiq/ui/...` (fixed in Plan 02)
- Shared lib: should already be `@sidekiq/shared/lib/...` (fixed in Plan 01)
- Other chat/thread components: update from `@sidekiq/components/chat/...` or `@sidekiq/components/thread/...` to relative paths (e.g., `./message-item` or `../components/message-item`) since they are now siblings within the feature
- Hooks: update from `@sidekiq/hooks/use-thread-actions` to relative paths (`../hooks/use-thread-actions`)
- Server/tRPC: leave `@sidekiq/shared/trpc/...` as-is
- Sidebar components: some chat components may reference sidebar components and vice versa -- use relative paths within the feature

Also fix imports in files OUTSIDE the feature that reference the moved files:
- `src/app/(dashboard)/chat/page.tsx` and related pages: update imports from `@sidekiq/components/chat/...` to `@sidekiq/components/chat/...` (still valid via fallback) -- or better, update to direct path `@sidekiq/chats/components/...` for now (barrel file comes in Plan 06)
- `src/shared/layout/sidebar-layout.tsx`: may import `sidebar-panel-chats` -- update from `@sidekiq/components/sidebar/sidebar-panel-chats` to `@sidekiq/chats/components/sidebar-panel-chats`

Use `tsc --noEmit` to find all broken imports and fix iteratively.

Also update test imports:
- `@sidekiq/components/chat/chat-input` -> `@sidekiq/chats/components/chat-input` (or via the `@sidekiq/*` fallback which now maps to `src/*` but the old path `src/components/chat/` no longer exists -- so these MUST be updated)
- Same pattern for all chat/thread test files under `tests/unit/components/chat/` and `tests/unit/components/thread/`
  </action>
  <verify>
Run `cd sidekiq-webapp && npx tsc --noEmit 2>&1 | head -30` -- should show zero errors or only errors from files not yet moved (model-picker, sidekiq, team, auth imports). Chat/thread-related errors should be resolved.
  </verify>
  <done>
All 20 chat/thread components, 3 sidebar panels, and 5 hooks live in `src/features/chats/`. Internal imports use relative paths. External importers updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Move chat router and validations, fix remaining imports</name>
  <files>
    sidekiq-webapp/src/features/chats/api/router.ts
    sidekiq-webapp/src/features/chats/validations.ts
  </files>
  <action>
Move the thread tRPC router and validation schemas into the chats feature.

**Router:**
```bash
cd sidekiq-webapp/src
git mv server/api/routers/thread.ts features/chats/api/router.ts
```

Update imports within the moved router file:
- `from "@sidekiq/server/api/trpc"` or relative `from "../trpc"` -> `from "@sidekiq/shared/trpc/trpc"`
- `from "@sidekiq/server/db"` or relative `from "../../db"` -> `from "@sidekiq/shared/db"`
- `from "@sidekiq/server/db/schema"` -> `from "@sidekiq/shared/db/schema"`
- Validation imports: update to relative `from "../validations"`

**Validations -- merge chat.ts and thread.ts:**
The current codebase has two validation files:
- `lib/validations/chat.ts` -- chat request schemas
- `lib/validations/thread.ts` -- thread input schemas

Merge both into a single file at `features/chats/validations.ts`. Combine all exports from both files into one. Do NOT change any validation logic -- only combine and update import paths.

```bash
# Don't git mv -- we're merging two files into one
# Read both files, combine their contents, write to new location
# Then git rm the originals
```

Create `features/chats/validations.ts` by:
1. Reading `lib/validations/chat.ts` and `lib/validations/thread.ts`
2. Combining all imports, all schemas, and all type exports into one file
3. Removing duplicate imports (both files likely import from `zod`)
4. Keeping the exact same schema definitions and exports

Then remove originals:
```bash
git rm lib/validations/chat.ts
git rm lib/validations/thread.ts
```

Update all importers of the old validation files:
- `from "@sidekiq/lib/validations/chat"` -> `from "@sidekiq/chats/validations"` (or via `@sidekiq/chats/*` alias)
- `from "@sidekiq/lib/validations/thread"` -> `from "@sidekiq/chats/validations"`
- The router file (just moved) should import from relative `"../validations"`

Update the root tRPC router (`src/shared/trpc/root.ts`) to import the thread router from its new location:
- `from "./routers/thread"` or `from "@sidekiq/server/api/routers/thread"` -> `from "@sidekiq/chats/api/router"`

Update test imports:
- `tests/unit/validations/chat.test.ts`: `from "@sidekiq/lib/validations/chat"` -> `from "@sidekiq/chats/validations"`
- `tests/unit/validations/thread.test.ts`: `from "@sidekiq/lib/validations/thread"` -> `from "@sidekiq/chats/validations"`
- `tests/unit/api/chat.test.ts` and `tests/unit/api/thread.test.ts`: update any imports referencing moved files

Run `tsc --noEmit` and fix all remaining chat-related import errors.
Run `vitest run` to ensure all tests pass.
  </action>
  <verify>
Run from `sidekiq-webapp/`:
1. `npx tsc --noEmit` -- zero errors (or only from non-chat features not yet moved)
2. `npx vitest run` -- all tests pass
3. `ls src/features/chats/api/` shows `router.ts`
4. `ls src/features/chats/validations.ts` exists
5. `ls src/server/api/routers/thread.ts` does NOT exist (moved)
6. `ls src/lib/validations/chat.ts` does NOT exist (merged)
7. `ls src/lib/validations/thread.ts` does NOT exist (merged)
8. `grep -r "lib/validations/chat" src/ tests/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
9. `grep -r "lib/validations/thread" src/ tests/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
  </verify>
  <done>
Thread router at `features/chats/api/router.ts`. Chat + thread validations merged at `features/chats/validations.ts`. Root tRPC router updated to import from new location. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. `cd sidekiq-webapp && npx tsc --noEmit` passes
2. `cd sidekiq-webapp && npx vitest run` -- all tests pass
3. `ls src/features/chats/components/ | wc -l` returns ~20 (12 chat + 5 thread + 3 sidebar panels)
4. `ls src/features/chats/hooks/ | wc -l` returns 5
5. `ls src/features/chats/api/router.ts` exists
6. `ls src/features/chats/validations.ts` exists
7. `src/components/chat/` directory is empty or removed
8. `src/components/thread/` directory is empty or removed
</verification>

<success_criteria>
- All chat domain code (20 components, 5 hooks, 1 router, merged validations) in src/features/chats/
- Thread router importable from @sidekiq/chats/api/router
- All imports updated (source + tests)
- tsc --noEmit clean, vitest passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-vertical-slice-architecture/09-03-SUMMARY.md`
</output>
