---
phase: 09-vertical-slice-architecture
plan: 06
type: execute
wave: 4
depends_on: ["09-03", "09-04", "09-05"]
files_modified:
  - sidekiq-webapp/src/features/chats/index.ts
  - sidekiq-webapp/src/features/sidekiqs/index.ts
  - sidekiq-webapp/src/features/auth/index.ts
  - sidekiq-webapp/src/features/user/index.ts
  - sidekiq-webapp/src/features/ai/index.ts
  - sidekiq-webapp/src/features/workspace/index.ts
  - sidekiq-webapp/src/shared/trpc/root.ts
  - sidekiq-webapp/src/app/(dashboard)/layout.tsx
  - sidekiq-webapp/src/app/(dashboard)/chat/ (page files)
  - sidekiq-webapp/src/app/(dashboard)/sidekiqs/ (page files)
  - sidekiq-webapp/src/app/(dashboard)/settings/ (page files)
  - sidekiq-webapp/src/app/(auth)/ (page files)
  - sidekiq-webapp/src/app/invite/[token]/page.tsx
autonomous: true

must_haves:
  truths:
    - "Each feature has a barrel file exporting only client-safe public API"
    - "tRPC root router merges all feature routers from their new locations"
    - "All app/ pages import from feature barrels or direct feature paths"
    - "No imports reference old horizontal layer paths (components/, hooks/, server/, lib/)"
    - "Old empty directories are cleaned up"
    - "pnpm build succeeds (full Next.js production build)"
    - "All unit and E2E tests pass with zero behavior changes"
  artifacts:
    - path: "sidekiq-webapp/src/features/chats/index.ts"
      provides: "Chats feature public API barrel"
    - path: "sidekiq-webapp/src/features/sidekiqs/index.ts"
      provides: "Sidekiqs feature public API barrel"
    - path: "sidekiq-webapp/src/features/auth/index.ts"
      provides: "Auth feature public API barrel"
    - path: "sidekiq-webapp/src/features/ai/index.ts"
      provides: "AI feature public API barrel"
    - path: "sidekiq-webapp/src/features/workspace/index.ts"
      provides: "Workspace feature public API barrel"
    - path: "sidekiq-webapp/src/shared/trpc/root.ts"
      provides: "Root tRPC router merging all feature routers"
  key_links:
    - from: "sidekiq-webapp/src/shared/trpc/root.ts"
      to: "sidekiq-webapp/src/features/*/api/router.ts"
      via: "feature router imports"
      pattern: "from \"@sidekiq/(chats|sidekiqs|user|workspace)/api/router\""
    - from: "sidekiq-webapp/src/app/(dashboard)/layout.tsx"
      to: "sidekiq-webapp/src/shared/layout/"
      via: "sidebar layout import"
      pattern: "from \"@sidekiq/shared/layout/"
    - from: "sidekiq-webapp/src/features/*/index.ts"
      to: "sidekiq-webapp/src/features/*/components/"
      via: "component re-exports"
      pattern: "export .* from \"\\./"
---

<objective>
Create barrel files for all features, verify the root tRPC router wiring, update all app/ page imports to use feature paths, clean up empty directories, and run the final full build + test verification.

Purpose: This is the capstone plan that ties everything together. Feature barrel files define each feature's public API. The root router must merge all feature routers. App pages must import from the new feature structure. This plan verifies the entire restructure works end-to-end with a full `pnpm build` and all tests.
Output: Complete vertical slice architecture with barrel files, clean root router, updated app/ pages, and passing build + tests.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-vertical-slice-architecture/09-CONTEXT.md
@.planning/phases/09-vertical-slice-architecture/09-RESEARCH.md
@.planning/phases/09-vertical-slice-architecture/09-03-SUMMARY.md
@.planning/phases/09-vertical-slice-architecture/09-04-SUMMARY.md
@.planning/phases/09-vertical-slice-architecture/09-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature barrel files and verify root tRPC router</name>
  <files>
    sidekiq-webapp/src/features/chats/index.ts
    sidekiq-webapp/src/features/sidekiqs/index.ts
    sidekiq-webapp/src/features/auth/index.ts
    sidekiq-webapp/src/features/user/index.ts
    sidekiq-webapp/src/features/ai/index.ts
    sidekiq-webapp/src/features/workspace/index.ts
    sidekiq-webapp/src/shared/trpc/root.ts
  </files>
  <action>
Create barrel files (index.ts) for each feature. These export ONLY the public API -- client-safe components and hooks. Server-side code (routers, queries, services) is NOT exported from barrels. Server-side consumers import directly via `@sidekiq/chats/api/router`.

**CRITICAL RULE:** Barrel files must NOT import/export anything from the `api/` subdirectory. The api/ directory contains server-only code. If a barrel file transitively pulls in server code, Next.js client bundles will break.

**chats/index.ts:**
```typescript
// src/features/chats/index.ts
// Public API for the chats feature

// Components
export { ChatInterface } from "./components/chat-interface";
export { ChatHeader } from "./components/chat-header";
export { ChatInput } from "./components/chat-input";
export { EmptyState } from "./components/empty-state";
export { MessageList } from "./components/message-list";
export { MessageItem } from "./components/message-item";
export { MessageContent } from "./components/message-content";
export { MessageActions } from "./components/message-actions";
export { ChatScrollAnchor } from "./components/chat-scroll-anchor";
export { ScrollToBottom } from "./components/scroll-to-bottom";
export { TypingIndicator } from "./components/typing-indicator";
export { ModelSwitchHint } from "./components/model-switch-hint";
export { DeleteThreadDialog } from "./components/delete-thread-dialog";
export { RenameThreadInput } from "./components/rename-thread-input";
export { ThreadContextMenu } from "./components/thread-context-menu";
export { ThreadItem } from "./components/thread-item";
export { SidebarPanelChats } from "./components/sidebar-panel-chats";
export { SidebarThreadList } from "./components/sidebar-thread-list";
export { SidebarThreadGroup } from "./components/sidebar-thread-group";

// Hooks
export { useThreadActions } from "./hooks/use-thread-actions";
export { useAutoScroll } from "./hooks/use-auto-scroll";
export { useScrollPosition } from "./hooks/use-scroll-position";
export { useKeyboardShortcuts } from "./hooks/use-keyboard-shortcuts";
export { useThreadSearch } from "./hooks/use-thread-search";
```

Read each component/hook file to verify the exact export name (named vs default). Adjust the barrel file to match actual exports. If a component uses `export default`, the barrel file should use `export { default as ComponentName } from "..."`.

**sidekiqs/index.ts:**
Read each file in features/sidekiqs/components/ and hooks/ to identify exports. Create barrel exporting all public components and hooks. Do NOT export from api/ or validations.

**auth/index.ts:**
Export auth components (AuthCard, SignInForm, SignUpForm, OAuthButtons, ForgotPasswordForm, ResetPasswordForm). Also export the better-auth client instance IF it is used on the client side (check if `client.ts` is a client-side module). If `client.ts` exports the auth client used in components for login/logout, include it: `export { authClient } from "./api/client"` -- but ONLY if client.ts does NOT import server-only modules.

**user/index.ts:**
Export `useViewPreference` hook. User feature has minimal client-side API.

**ai/index.ts:**
Export model-picker components and `useModelSelection` hook. Do NOT export gateway.ts or models.ts (server-only).

**workspace/index.ts:**
Export team components, hooks (useActiveTeam, useMemberSearch), and sidebar panel.

**Verify root tRPC router:**
Read `src/shared/trpc/root.ts` and confirm it imports ALL feature routers from their new locations. It should look like:

```typescript
import { threadRouter } from "@sidekiq/chats/api/router";
import { sidekiqRouter } from "@sidekiq/sidekiqs/api/router";
import { teamRouter } from "@sidekiq/workspace/api/router";
import { userRouter } from "@sidekiq/user/api/router";
import { healthRouter } from "./routers/health";
```

If any import still references old paths (e.g., `@sidekiq/server/api/routers/...`), fix it. The router keys in `createTRPCRouter({...})` must remain exactly the same to preserve the API surface (e.g., `thread: threadRouter`, not `chat: threadRouter`).

Run `tsc --noEmit` to verify all barrel files compile correctly and no server/client boundary violations exist.
  </action>
  <verify>
1. `npx tsc --noEmit` -- zero errors
2. Each barrel file exists and exports only client-safe code:
   - `ls src/features/chats/index.ts` exists
   - `ls src/features/sidekiqs/index.ts` exists
   - `ls src/features/auth/index.ts` exists
   - `ls src/features/user/index.ts` exists
   - `ls src/features/ai/index.ts` exists
   - `ls src/features/workspace/index.ts` exists
3. No barrel file imports from `./api/router` or `./api/queries` (server-only)
4. Root tRPC router imports all feature routers from `@sidekiq/*/api/router` paths
  </verify>
  <done>
All 6 feature barrel files created with client-safe exports only. Root tRPC router imports all feature routers from new paths. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update app/ page imports, clean up empty directories, final build verification</name>
  <files>
    sidekiq-webapp/src/app/ (all page files referencing old paths)
    + empty directory cleanup
  </files>
  <action>
**1. Scan and fix ALL remaining old-path imports across the codebase.**

Run `tsc --noEmit` and fix every error. Then do a comprehensive grep scan for any remaining old paths that the compiler might not catch (e.g., dynamic imports, string references):

```bash
# Check for any remaining old horizontal-layer imports
grep -rn "@sidekiq/components/" src/ tests/ --include="*.ts" --include="*.tsx"
grep -rn "@sidekiq/hooks/" src/ tests/ --include="*.ts" --include="*.tsx"
grep -rn "@sidekiq/server/" src/ tests/ --include="*.ts" --include="*.tsx"
grep -rn "@sidekiq/lib/" src/ tests/ --include="*.ts" --include="*.tsx"
grep -rn "@sidekiq/trpc/" src/ tests/ --include="*.ts" --include="*.tsx"
```

For each remaining old-path import, determine the correct new path:
- `@sidekiq/components/chat/...` -> `@sidekiq/chats/components/...` or barrel `@sidekiq/chats`
- `@sidekiq/components/sidekiq/...` -> `@sidekiq/sidekiqs/components/...` or barrel
- `@sidekiq/components/auth/...` -> `@sidekiq/auth/components/...` or barrel
- `@sidekiq/components/team/...` -> `@sidekiq/workspace/components/...` or barrel
- `@sidekiq/components/model-picker/...` -> `@sidekiq/ai/components/...` or barrel
- `@sidekiq/components/sidebar/...` -> `@sidekiq/shared/layout/...` or feature barrel
- `@sidekiq/hooks/...` -> appropriate feature hook path
- `@sidekiq/server/...` -> `@sidekiq/shared/...` or feature api path
- `@sidekiq/lib/...` -> `@sidekiq/shared/lib/...` or feature-specific path
- `@sidekiq/trpc/...` -> `@sidekiq/shared/trpc/...`

Focus especially on app/ pages which are the primary consumers:
- `src/app/(dashboard)/chat/page.tsx` and `[threadId]/page.tsx`
- `src/app/(dashboard)/chat/layout.tsx`
- `src/app/(dashboard)/sidekiqs/page.tsx` and related pages
- `src/app/(dashboard)/settings/page.tsx` and `teams/page.tsx`
- `src/app/(auth)/*.tsx` pages
- `src/app/(dashboard)/layout.tsx`
- `src/app/layout.tsx`
- `src/app/invite/[token]/page.tsx`
- `src/app/api/chat/route.ts`
- `src/app/api/trpc/[trpc]/route.ts`
- `src/app/api/auth/[...all]/route.ts`

Where possible, use barrel imports (e.g., `import { ChatInterface } from "@sidekiq/chats"` instead of `import { ChatInterface } from "@sidekiq/chats/components/chat-interface"`). This is the benefit of barrel files -- cleaner imports in app/ pages.

**2. Clean up empty directories.**

After all files are moved, remove empty directories:
```bash
cd sidekiq-webapp/src
# Remove empty old directories (only if truly empty)
rmdir components/chat/ 2>/dev/null
rmdir components/thread/ 2>/dev/null
rmdir components/sidekiq/ 2>/dev/null
rmdir components/team/ 2>/dev/null
rmdir components/auth/ 2>/dev/null
rmdir components/model-picker/ 2>/dev/null
rmdir components/sidebar/ 2>/dev/null
rmdir components/ui/ 2>/dev/null
rmdir components/icons/ 2>/dev/null
rmdir components/theme/ 2>/dev/null
rmdir components/ 2>/dev/null
rmdir hooks/ 2>/dev/null
rmdir server/api/routers/ 2>/dev/null
rmdir server/api/ 2>/dev/null
rmdir server/better-auth/ 2>/dev/null
rmdir server/db/ 2>/dev/null
rmdir server/ 2>/dev/null
rmdir trpc/ 2>/dev/null
rmdir lib/validations/ 2>/dev/null
rmdir lib/emails/ 2>/dev/null
rmdir lib/ai/ 2>/dev/null
rmdir lib/utils/ 2>/dev/null
rmdir lib/constants/ 2>/dev/null
rmdir lib/ 2>/dev/null
```

If any directory is not empty (unexpected files remain), do NOT force-remove. Investigate what's left.

**3. Run full verification suite.**

```bash
cd sidekiq-webapp

# TypeScript compilation
npx tsc --noEmit

# Unit tests
npx vitest run

# Production build (catches server/client boundary violations, runtime issues)
pnpm build
```

The production build is the ultimate verification. It will catch:
- Server/client boundary violations in barrel files
- Missing `"use client"` directives
- Broken dynamic imports
- Missing environment variables at build time
- Any import resolution failures

If build fails, diagnose and fix. Common issues:
- Barrel file importing server code -> remove that export from barrel
- Missing `"use client"` directive in moved component -> add it back
- `next.config.js` env import path wrong -> fix the path

**4. Verify git status is clean and commit.**

```bash
git status
git add -A
git commit -m "refactor(09): complete vertical slice architecture migration"
```
  </action>
  <verify>
Run the full verification suite from `sidekiq-webapp/`:
1. `npx tsc --noEmit` -- zero errors
2. `npx vitest run` -- ALL unit tests pass
3. `pnpm build` -- production build succeeds
4. `grep -rn "@sidekiq/components/" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
5. `grep -rn "@sidekiq/hooks/" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
6. `grep -rn "@sidekiq/server/" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
7. `grep -rn "@sidekiq/lib/" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0 (except possibly `@sidekiq/shared/lib/`)
8. `grep -rn "@sidekiq/trpc/" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0 (except `@sidekiq/shared/trpc/`)
9. `ls src/components/ 2>/dev/null` returns error or empty (directory removed)
10. `ls src/hooks/ 2>/dev/null` returns error or empty
11. `ls src/server/ 2>/dev/null` returns error or empty
12. `ls src/lib/ 2>/dev/null` returns error or empty
13. `ls src/trpc/ 2>/dev/null` returns error or empty
14. `ls src/features/` shows chats, sidekiqs, auth, user, ai, workspace, billing
15. `ls src/shared/` shows db, trpc, lib, ui, icons, theme, layout, env.js
  </verify>
  <done>
Complete vertical slice architecture. All app/ pages import from features. All old horizontal directories removed. Full production build passes. All unit tests pass. Zero old-path imports remain.
  </done>
</task>

</tasks>

<verification>
Complete phase verification:
1. `cd sidekiq-webapp && npx tsc --noEmit` -- zero errors
2. `cd sidekiq-webapp && npx vitest run` -- ALL tests pass (ARCH-05)
3. `cd sidekiq-webapp && pnpm build` -- production build succeeds
4. Feature directories exist: `ls src/features/` shows 7 directories (ARCH-01)
5. Shared directory exists: `ls src/shared/` shows db, trpc, lib, ui, icons, theme, layout (ARCH-02)
6. Schema centralized: `cat src/shared/db/schema.ts | head -5` exists (ARCH-03)
7. Root router merges feature routers: `grep -c "Router" src/shared/trpc/root.ts` shows 5+ (ARCH-04)
8. No old-path imports: `grep -rn "@sidekiq/components/\|@sidekiq/hooks/\|@sidekiq/server/\|@sidekiq/lib/[^.]" src/ --include="*.ts" --include="*.tsx" | wc -l` returns 0
9. Each feature has barrel file: `ls src/features/*/index.ts | wc -l` returns 7
</verification>

<success_criteria>
- ARCH-01: All 7 features have directories under src/features/ with components, hooks, api
- ARCH-02: Shared utilities in src/shared/ (ui, db, trpc, lib, icons, theme, layout)
- ARCH-03: Drizzle schema centralized at src/shared/db/schema.ts
- ARCH-04: tRPC routers imported from feature directories, merged in root router
- ARCH-05: All existing tests pass, pnpm build succeeds, zero behavior changes
- All barrel files export client-safe public API only
- No imports reference old horizontal layer paths
- All old directories (components/, hooks/, server/, lib/, trpc/) removed
</success_criteria>

<output>
After completion, create `.planning/phases/09-vertical-slice-architecture/09-06-SUMMARY.md`
</output>
