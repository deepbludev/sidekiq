---
phase: 05-sidebar-navigation
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-thread-group.tsx
  - sidekiq-webapp/src/hooks/use-scroll-position.ts
  - sidekiq-webapp/src/components/sidebar/sidebar.tsx
  - sidekiq-webapp/src/components/sidebar/index.ts
autonomous: true

must_haves:
  truths:
    - "Thread list displays with date group headers (Pinned/Today/Yesterday/etc.)"
    - "List is virtualized for performance with many threads"
    - "Scroll position is preserved when switching between threads"
    - "Pinned threads appear in Pinned section, not duplicated in date groups"
    - "Empty groups are hidden"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx"
      provides: "Virtualized thread list with date grouping"
      exports: ["SidebarThreadList"]
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-thread-group.tsx"
      provides: "Date group header component"
      exports: ["SidebarThreadGroup"]
    - path: "sidekiq-webapp/src/hooks/use-scroll-position.ts"
      provides: "Scroll position preservation hook"
      exports: ["useScrollPosition"]
  key_links:
    - from: "sidebar-thread-list.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer"
    - from: "sidebar-thread-list.tsx"
      to: "date-grouping.ts"
      via: "groupThreadsByDate import"
      pattern: "groupThreadsByDate"
    - from: "sidebar-thread-list.tsx"
      to: "thread-item.tsx"
      via: "ThreadItem rendering"
      pattern: "<ThreadItem"
---

<objective>
Create the virtualized thread list with date grouping and scroll position preservation.

Purpose: Display user's conversation history efficiently with visual organization by date. This is the core content of the sidebar.
Output: SidebarThreadList with TanStack Virtual, date group headers, and scroll persistence.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sidebar-navigation/05-CONTEXT.md
@.planning/phases/05-sidebar-navigation/05-RESEARCH.md
@.planning/phases/05-sidebar-navigation/05-01-SUMMARY.md
@sidekiq-webapp/src/components/thread/thread-item.tsx
@sidekiq-webapp/src/hooks/use-thread-actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scroll position preservation hook</name>
  <files>sidekiq-webapp/src/hooks/use-scroll-position.ts</files>
  <action>
Create `use-scroll-position.ts` with:

1. **Purpose:** Preserve scroll position of thread list when switching threads

2. **Implementation:**
```typescript
import { useEffect, useRef, type RefObject } from "react";

/**
 * Hook to preserve scroll position of a scrollable container.
 * Stores position in a ref (not state) to avoid re-renders.
 * Restores position on mount using requestAnimationFrame.
 *
 * @param containerRef - Ref to the scrollable container element
 * @returns The scroll position ref (for external access if needed)
 */
export function useScrollPosition(containerRef: RefObject<HTMLDivElement | null>) {
  const scrollPositionRef = useRef<number>(0);

  // Save position on scroll
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    const handleScroll = () => {
      scrollPositionRef.current = container.scrollTop;
    };

    container.addEventListener("scroll", handleScroll, { passive: true });
    return () => container.removeEventListener("scroll", handleScroll);
  }, [containerRef]);

  // Restore position on mount
  useEffect(() => {
    const container = containerRef.current;
    if (!container) return;

    // Use requestAnimationFrame for reliable restoration after render
    requestAnimationFrame(() => {
      container.scrollTop = scrollPositionRef.current;
    });
  }, []); // Only on mount

  return scrollPositionRef;
}
```

3. **Key points:**
   - Use ref not state (per RESEARCH.md - avoids re-renders)
   - passive: true for scroll listener (performance)
   - requestAnimationFrame for reliable restoration after DOM updates
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>Hook exports useScrollPosition, saves/restores scroll position via ref</done>
</task>

<task type="auto">
  <name>Task 2: Create SidebarThreadGroup component</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-thread-group.tsx</files>
  <action>
Create `sidebar-thread-group.tsx` with:

1. **Props interface:**
```typescript
import type { DateGroup } from "@sidekiq/lib/date-grouping";

interface SidebarThreadGroupProps {
  group: DateGroup;
}
```

2. **Implementation:**
```tsx
/**
 * Date group header for sidebar thread list.
 * Displays group name (Pinned, Today, Yesterday, etc.) with muted styling.
 */
export function SidebarThreadGroup({ group }: SidebarThreadGroupProps) {
  return (
    <div className="px-3 py-2">
      <span className="text-xs font-medium uppercase tracking-wider text-muted-foreground">
        {group}
      </span>
    </div>
  );
}
```

3. **Styling per CONTEXT.md:**
   - Small, subtle, muted text
   - Uppercase for visual hierarchy
   - Proper padding to align with thread items
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>SidebarThreadGroup renders date group header with muted styling</done>
</task>

<task type="auto">
  <name>Task 3: Create SidebarThreadList with virtualization</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx</files>
  <action>
Create `sidebar-thread-list.tsx` with:

1. **Data fetching:**
   - Use tRPC query: `api.thread.list.useQuery()` (already filters out archived)
   - Get current threadId from pathname for active state

2. **Flatten groups for virtualization (per RESEARCH.md pattern):**
```typescript
type VirtualItem =
  | { type: "header"; group: DateGroup }
  | { type: "thread"; thread: Thread };

function flattenGroupsForVirtualization(groups: GroupedThreads[]): VirtualItem[] {
  const items: VirtualItem[] = [];
  for (const { group, threads } of groups) {
    items.push({ type: "header", group });
    for (const thread of threads) {
      items.push({ type: "thread", thread });
    }
  }
  return items;
}
```

3. **Import ThreadItem from Phase 3:**
```typescript
import { ThreadItem } from "@sidekiq/components/thread/thread-item";
```

This component already exists from Phase 3 and handles:
- Thread title display with truncation
- Active state highlighting (via isActive prop)
- Pin/archive indicators
- Context menu with rename, archive, delete actions
- Inline rename editing

4. **Virtualization with TanStack Virtual:**
```tsx
import { useVirtualizer } from "@tanstack/react-virtual";

const parentRef = useRef<HTMLDivElement>(null);

const virtualizer = useVirtualizer({
  count: virtualItems.length,
  getScrollElement: () => parentRef.current,
  estimateSize: (index) =>
    virtualItems[index].type === "header" ? 32 : 48, // Headers shorter than items
  overscan: 5, // Render 5 extra items above/below viewport
});
```

5. **Render virtualized items:**
```tsx
<div ref={parentRef} className="h-full overflow-auto">
  <div
    style={{
      height: virtualizer.getTotalSize(),
      position: "relative",
    }}
  >
    {virtualizer.getVirtualItems().map((virtualRow) => {
      const item = virtualItems[virtualRow.index];
      return (
        <div
          key={virtualRow.key}
          data-index={virtualRow.index}
          ref={virtualizer.measureElement}
          style={{
            position: "absolute",
            top: 0,
            left: 0,
            width: "100%",
            transform: `translateY(${virtualRow.start}px)`,
          }}
        >
          {item.type === "header" ? (
            <SidebarThreadGroup group={item.group} />
          ) : (
            <ThreadItem
              thread={item.thread}
              isActive={item.thread.id === activeThreadId}
              activeThreadId={activeThreadId}
            />
          )}
        </div>
      );
    })}
  </div>
</div>
```

6. **Integrate scroll position:**
   - Import and use `useScrollPosition(parentRef)`
   - This preserves scroll when switching threads

7. **Get active thread ID:**
```typescript
import { usePathname } from "next/navigation";
const pathname = usePathname();
const activeThreadId = pathname?.startsWith("/chat/")
  ? pathname.split("/")[2] ?? null
  : null;
```

8. **Props interface:**
```typescript
interface SidebarThreadListProps {
  searchQuery?: string; // For filtering - will be used in Plan 05-04
}
```

9. **Handle search mode (prepare for Plan 05-04):**
   - If `searchQuery` is provided and not empty, skip date grouping (show flat list)
   - For now, just use date grouping (search integration comes in Plan 05-04)

10. **Empty state:**
   - If no threads, show "No conversations yet" message

11. **Loading state:**
    - While query loading, show skeleton or loading indicator

Add JSDoc for the component.
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>SidebarThreadList renders virtualized list with date groups, integrates ThreadItem</done>
</task>

<task type="auto">
  <name>Task 4: Integrate thread list into Sidebar</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar.tsx, sidekiq-webapp/src/components/sidebar/index.ts</files>
  <action>
Update `sidebar.tsx` to include SidebarThreadList:

1. **Import SidebarThreadList:**
```typescript
import { SidebarThreadList } from "./sidebar-thread-list";
```

2. **Replace thread list placeholder:**
```tsx
{/* Thread list */}
<div className="flex-1 overflow-hidden">
  <SidebarThreadList />
</div>
```

3. **Update index.ts to export new components:**
```typescript
export { Sidebar } from "./sidebar";
export { SidebarHeader } from "./sidebar-header";
export { SidebarCollapsed } from "./sidebar-collapsed";
export { SidebarThreadList } from "./sidebar-thread-list";
export { SidebarThreadGroup } from "./sidebar-thread-group";
```

The sidebar should now show the actual thread list with date grouping.
  </action>
  <verify>
1. TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`
2. Lint passes: `pnpm lint`
  </verify>
  <done>Sidebar displays thread list with date grouping and virtualization</done>
</task>

</tasks>

<verification>
1. All files created with proper TypeScript types
2. No TypeScript errors: `pnpm tsc --noEmit`
3. Lint passes: `pnpm lint`
4. Thread list displays with date group headers
5. Scroll position preserved when clicking between threads
6. Active thread is highlighted
7. Empty state shown when no threads
</verification>

<success_criteria>
- SidebarThreadList renders threads from tRPC query
- Threads grouped by Pinned/Today/Yesterday/This Week/This Month/Older
- Date group headers display with muted styling
- Pinned threads only appear in Pinned section (not duplicated)
- Empty groups are hidden
- List is virtualized (verify by checking DOM - only visible items rendered)
- Scroll position preserved when navigating between threads
- Active thread has background highlight
- Empty state shows when no threads
</success_criteria>

<output>
After completion, create `.planning/phases/05-sidebar-navigation/05-03-SUMMARY.md`
</output>
