---
phase: 05-sidebar-navigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/package.json
  - sidekiq-webapp/pnpm-lock.yaml
  - sidekiq-webapp/src/hooks/use-sidebar-state.ts
  - sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts
  - sidekiq-webapp/src/lib/date-grouping.ts
autonomous: true

must_haves:
  truths:
    - "Sidebar collapsed state persists across browser sessions"
    - "Keyboard shortcuts Cmd+N, Cmd+B, Cmd+K trigger handlers"
    - "Threads are grouped into date buckets (Pinned/Today/Yesterday/This Week/This Month/Older)"
  artifacts:
    - path: "sidekiq-webapp/src/hooks/use-sidebar-state.ts"
      provides: "Collapse state management with localStorage"
      exports: ["useSidebarState"]
    - path: "sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts"
      provides: "Global keyboard shortcut handling"
      exports: ["useKeyboardShortcuts"]
    - path: "sidekiq-webapp/src/lib/date-grouping.ts"
      provides: "Thread date grouping logic"
      exports: ["groupThreadsByDate", "DateGroup", "GroupedThreads"]
  key_links:
    - from: "use-sidebar-state.ts"
      to: "localStorage"
      via: "getItem/setItem"
      pattern: "localStorage\\.(get|set)Item"
    - from: "date-grouping.ts"
      to: "date-fns"
      via: "isToday/isYesterday imports"
      pattern: "from \"date-fns\""
---

<objective>
Create foundation utilities for the sidebar: collapse state persistence, keyboard shortcuts, and date grouping logic.

Purpose: Establish the core hooks and utilities that other sidebar components will depend on. These are pure logic modules with no UI.
Output: Three files - useSidebarState hook, useKeyboardShortcuts hook, and date-grouping utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sidebar-navigation/05-CONTEXT.md
@.planning/phases/05-sidebar-navigation/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies</name>
  <files>sidekiq-webapp/package.json, sidekiq-webapp/pnpm-lock.yaml</files>
  <action>
Install required dependencies for sidebar phase:
```bash
cd sidekiq-webapp && pnpm add @tanstack/react-virtual date-fns
```

These are needed for:
- @tanstack/react-virtual: Virtualized thread list for performance with many threads
- date-fns: Date comparison helpers (isToday, isYesterday, isThisWeek, isThisMonth, formatDistanceToNow)

Note: fuse.js is already installed from Phase 4.
  </action>
  <verify>Run `pnpm list @tanstack/react-virtual date-fns` to confirm packages installed</verify>
  <done>Both packages appear in dependencies with version numbers</done>
</task>

<task type="auto">
  <name>Task 2: Create sidebar state hook with localStorage persistence</name>
  <files>sidekiq-webapp/src/hooks/use-sidebar-state.ts</files>
  <action>
Create `use-sidebar-state.ts` with:

1. **State management:**
   - `isCollapsed` boolean state
   - Lazy initializer that reads from localStorage (SSR-safe with typeof window check)
   - `toggle()` function that updates state AND localStorage

2. **SSR/Hydration safety:**
   - Use lazy useState initializer: `useState(() => { if (typeof window === 'undefined') return false; ... })`
   - This prevents hydration mismatch

3. **Interface:**
```typescript
interface SidebarState {
  isCollapsed: boolean;
  toggle: () => void;
  setIsCollapsed: (collapsed: boolean) => void;
}
```

4. **localStorage key:** "sidebar-collapsed" (string "true" or "false")

5. **Add JSDoc:** Document the hook, parameters, and return type per project conventions.
  </action>
  <verify>TypeScript compiles without errors: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>Hook exports useSidebarState, handles localStorage read/write, is SSR-safe</done>
</task>

<task type="auto">
  <name>Task 3: Create keyboard shortcuts hook</name>
  <files>sidekiq-webapp/src/hooks/use-keyboard-shortcuts.ts</files>
  <action>
Create `use-keyboard-shortcuts.ts` with:

1. **Interface:**
```typescript
interface ShortcutHandlers {
  onNewChat?: () => void;
  onToggleSidebar?: () => void;
  onFocusSearch?: () => void;
}
```

2. **Implementation:**
   - Single useEffect that attaches keydown listener to window
   - Check for `e.metaKey || e.ctrlKey` (works on Mac and Windows)
   - Shortcuts:
     - Cmd+N (key === 'n') → onNewChat
     - Cmd+B (key === 'b') → onToggleSidebar
     - Cmd+K (key === 'k') → onFocusSearch
   - Call `e.preventDefault()` before invoking handler to prevent browser defaults
   - Proper cleanup: remove event listener on unmount

3. **Dependencies array:** Include all handler functions to ensure latest refs

4. **Add JSDoc:** Document the hook and each shortcut.
  </action>
  <verify>TypeScript compiles without errors: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>Hook exports useKeyboardShortcuts, handles Cmd+N/B/K with proper cleanup</done>
</task>

<task type="auto">
  <name>Task 4: Create date grouping utility</name>
  <files>sidekiq-webapp/src/lib/date-grouping.ts</files>
  <action>
Create `date-grouping.ts` with:

1. **Types:**
```typescript
type DateGroup = "Pinned" | "Today" | "Yesterday" | "This Week" | "This Month" | "Older";

interface GroupedThreads {
  group: DateGroup;
  threads: Thread[];
}

interface Thread {
  id: string;
  title: string | null;
  isPinned: boolean;
  isArchived: boolean;
  lastActivityAt: Date;
  messageCount: number;
}
```

2. **Main function `groupThreadsByDate(threads: Thread[]): GroupedThreads[]`:**
   - Create buckets for each group
   - For each thread:
     - If `isPinned`, add to Pinned group and SKIP date grouping (per CONTEXT.md - no duplication)
     - Otherwise, use date-fns helpers to categorize:
       - `isToday(date)` → Today
       - `isYesterday(date)` → Yesterday
       - `isThisWeek(date)` → This Week
       - `isThisMonth(date)` → This Month
       - else → Older
   - Filter out empty groups (per CONTEXT.md - empty groups hidden)
   - Return as array in display order: Pinned, Today, Yesterday, This Week, This Month, Older

3. **Helper function `formatThreadTimestamp(date: Date): string`:**
   - If isToday: use `formatDistanceToNow(date, { addSuffix: true })` → "2h ago"
   - If isYesterday: return "Yesterday"
   - Else: use `format(date, "MMM d")` → "Jan 15"

4. **Imports from date-fns:** isToday, isYesterday, isThisWeek, isThisMonth, formatDistanceToNow, format

5. **Add JSDoc:** Document each function and type.
  </action>
  <verify>TypeScript compiles without errors: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>Module exports groupThreadsByDate, formatThreadTimestamp, DateGroup, GroupedThreads types</done>
</task>

</tasks>

<verification>
1. Dependencies installed: `pnpm list @tanstack/react-virtual date-fns` shows both
2. All three files exist and export expected functions/types
3. No TypeScript errors: `pnpm tsc --noEmit` passes
4. Lint passes: `pnpm lint`
</verification>

<success_criteria>
- @tanstack/react-virtual and date-fns are installed
- useSidebarState hook persists collapse state to localStorage
- useKeyboardShortcuts hook handles Cmd+N, Cmd+B, Cmd+K
- groupThreadsByDate correctly groups threads with Pinned separate from date groups
- formatThreadTimestamp returns appropriate relative/absolute formats
- All TypeScript compiles, lint passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-sidebar-navigation/05-01-SUMMARY.md`
</output>
