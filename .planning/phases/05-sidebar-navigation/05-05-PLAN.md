---
phase: 05-sidebar-navigation
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04"]
files_modified:
  - sidekiq-webapp/src/components/sidebar/sidebar-footer.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-mobile.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar.tsx
  - sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx
  - sidekiq-webapp/src/components/sidebar/index.ts
autonomous: false

must_haves:
  truths:
    - "User avatar and dropdown menu appear at bottom of sidebar"
    - "Dropdown menu includes Settings, Theme toggle, and Logout options"
    - "Mobile drawer slides in from left on small screens"
    - "Hamburger menu icon triggers mobile drawer"
    - "Selecting a thread closes mobile drawer"
    - "Tapping outside drawer closes it"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-footer.tsx"
      provides: "User avatar and dropdown menu"
      exports: ["SidebarFooter"]
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-mobile.tsx"
      provides: "Mobile drawer wrapper"
      exports: ["SidebarMobile"]
  key_links:
    - from: "sidebar-mobile.tsx"
      to: "sheet.tsx"
      via: "Sheet component usage"
      pattern: "<Sheet"
    - from: "sidebar-footer.tsx"
      to: "dropdown-menu.tsx"
      via: "DropdownMenu usage"
      pattern: "<DropdownMenu"
    - from: "layout.tsx"
      to: "sidebar-mobile.tsx"
      via: "component import"
      pattern: "<SidebarMobile"
---

<objective>
Create sidebar footer with user menu and mobile drawer for responsive design.

Purpose: Complete the sidebar with user controls and make it work on mobile devices.
Output: SidebarFooter with user dropdown, SidebarMobile drawer, and responsive layout integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-sidebar-navigation/05-CONTEXT.md
@.planning/phases/05-sidebar-navigation/05-RESEARCH.md
@.planning/phases/05-sidebar-navigation/05-02-SUMMARY.md
@.planning/phases/05-sidebar-navigation/05-03-SUMMARY.md
@.planning/phases/05-sidebar-navigation/05-04-SUMMARY.md
@sidekiq-webapp/src/components/ui/sheet.tsx
@sidekiq-webapp/src/components/ui/dropdown-menu.tsx
@sidekiq-webapp/src/components/ui/avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SidebarFooter component</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-footer.tsx</files>
  <action>
Create `sidebar-footer.tsx` with:

1. **Get user session:**
```typescript
// For now, use a placeholder or mock user
// TODO: Integrate with better-auth session in future
interface User {
  name: string | null;
  email: string;
  image: string | null;
}
```

For now, we'll use a placeholder approach. The real session integration can come later.

2. **Implementation:**
```tsx
"use client";

import { LogOut, Settings, Moon, Sun, Monitor } from "lucide-react";
import { useTheme } from "next-themes";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
  DropdownMenuTrigger,
} from "@sidekiq/components/ui/dropdown-menu";
import {
  Avatar,
  AvatarFallback,
  AvatarImage,
} from "@sidekiq/components/ui/avatar";
import { Button } from "@sidekiq/components/ui/button";
import { authClient } from "@sidekiq/lib/auth-client";

interface SidebarFooterProps {
  isCollapsed: boolean;
}

/**
 * Sidebar footer with user avatar and dropdown menu.
 * Contains Settings, Theme toggle, and Logout options.
 */
export function SidebarFooter({ isCollapsed }: SidebarFooterProps) {
  const { theme, setTheme } = useTheme();
  const { data: session } = authClient.useSession();

  const user = session?.user;
  const initials = user?.name
    ?.split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase() ?? user?.email?.[0]?.toUpperCase() ?? "U";

  const handleSignOut = async () => {
    await authClient.signOut();
    window.location.href = "/sign-in";
  };

  return (
    <div className="border-t border-border/50 p-3">
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button
            variant="ghost"
            className={cn(
              "w-full justify-start gap-2",
              isCollapsed && "justify-center px-0"
            )}
          >
            <Avatar className="h-8 w-8">
              <AvatarImage src={user?.image ?? undefined} alt={user?.name ?? "User"} />
              <AvatarFallback className="text-xs">{initials}</AvatarFallback>
            </Avatar>
            {!isCollapsed && (
              <div className="flex flex-col items-start text-left">
                <span className="text-sm font-medium truncate max-w-[140px]">
                  {user?.name ?? "User"}
                </span>
                <span className="text-xs text-muted-foreground truncate max-w-[140px]">
                  {user?.email ?? ""}
                </span>
              </div>
            )}
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent align="start" side="top" className="w-56">
          <DropdownMenuLabel>My Account</DropdownMenuLabel>
          <DropdownMenuSeparator />

          {/* Settings - placeholder, no navigation yet */}
          <DropdownMenuItem disabled>
            <Settings className="mr-2 h-4 w-4" />
            Settings
          </DropdownMenuItem>

          {/* Theme submenu */}
          <DropdownMenuSub>
            <DropdownMenuSubTrigger>
              {theme === "dark" ? (
                <Moon className="mr-2 h-4 w-4" />
              ) : theme === "light" ? (
                <Sun className="mr-2 h-4 w-4" />
              ) : (
                <Monitor className="mr-2 h-4 w-4" />
              )}
              Theme
            </DropdownMenuSubTrigger>
            <DropdownMenuSubContent>
              <DropdownMenuItem onClick={() => setTheme("light")}>
                <Sun className="mr-2 h-4 w-4" />
                Light
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => setTheme("dark")}>
                <Moon className="mr-2 h-4 w-4" />
                Dark
              </DropdownMenuItem>
              <DropdownMenuItem onClick={() => setTheme("system")}>
                <Monitor className="mr-2 h-4 w-4" />
                System
              </DropdownMenuItem>
            </DropdownMenuSubContent>
          </DropdownMenuSub>

          <DropdownMenuSeparator />

          {/* Logout */}
          <DropdownMenuItem onClick={handleSignOut}>
            <LogOut className="mr-2 h-4 w-4" />
            Log out
          </DropdownMenuItem>
        </DropdownMenuContent>
      </DropdownMenu>
    </div>
  );
}
```

3. **Import cn utility:**
```typescript
import { cn } from "@sidekiq/lib/utils";
```

4. **Note:** Settings menu item is disabled for now (placeholder for future settings page).

Add JSDoc for the component.
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>SidebarFooter renders user avatar, dropdown with theme toggle and logout</done>
</task>

<task type="auto">
  <name>Task 2: Create SidebarMobile component</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-mobile.tsx</files>
  <action>
Create `sidebar-mobile.tsx` with:

1. **Implementation:**
```tsx
"use client";

import { useState, cloneElement, type ReactElement } from "react";
import { Menu } from "lucide-react";
import {
  Sheet,
  SheetContent,
  SheetTrigger,
} from "@sidekiq/components/ui/sheet";
import { Button } from "@sidekiq/components/ui/button";

interface SidebarMobileProps {
  children: ReactElement<{ onThreadSelect?: () => void }>;
}

/**
 * Mobile sidebar drawer wrapper.
 * Wraps sidebar content in a Sheet that slides from left.
 * Closes when a thread is selected.
 */
export function SidebarMobile({ children }: SidebarMobileProps) {
  const [open, setOpen] = useState(false);

  return (
    <Sheet open={open} onOpenChange={setOpen}>
      <SheetTrigger asChild>
        <Button variant="ghost" size="icon" className="md:hidden">
          <Menu className="h-5 w-5" />
          <span className="sr-only">Toggle sidebar</span>
        </Button>
      </SheetTrigger>
      <SheetContent side="left" className="w-72 p-0">
        {/* Pass onThreadSelect to close drawer when thread is clicked */}
        {cloneElement(children, {
          onThreadSelect: () => setOpen(false),
        })}
      </SheetContent>
    </Sheet>
  );
}
```

2. **Key points:**
   - Uses Sheet component from Radix (already exists)
   - side="left" per CONTEXT.md
   - w-72 matches sidebar expanded width
   - p-0 removes default padding (sidebar has its own)
   - Passes onThreadSelect callback to close drawer

3. **The Sidebar component needs to accept and propagate onThreadSelect:**
   - This will be handled in Task 3

Add JSDoc for the component.
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>SidebarMobile wraps content in Sheet, triggers with hamburger icon</done>
</task>

<task type="auto">
  <name>Task 3: Update Sidebar to support mobile close and integrate footer</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar.tsx</files>
  <action>
Update `sidebar.tsx`:

1. **Add onThreadSelect prop:**
```typescript
interface SidebarProps {
  onThreadSelect?: () => void;
}

export function Sidebar({ onThreadSelect }: SidebarProps) {
  // ...
}
```

2. **Integrate SidebarFooter:**
```tsx
import { SidebarFooter } from "./sidebar-footer";

// In the expanded view:
<>
  <SidebarHeader isCollapsed={isCollapsed} />
  <SidebarSearch
    query={searchQuery}
    onQueryChange={setSearchQuery}
    inputRef={searchInputRef}
  />
  <div className="flex-1 overflow-hidden">
    <SidebarThreadList
      searchQuery={searchQuery}
      onThreadSelect={onThreadSelect}
    />
  </div>
  <SidebarFooter isCollapsed={isCollapsed} />
</>
```

3. **Pass onThreadSelect to SidebarThreadList:**
   - SidebarThreadList needs to call onThreadSelect when a thread is clicked

4. **Update SidebarThreadList to accept onThreadSelect:**
```typescript
interface SidebarThreadListProps {
  searchQuery?: string;
  onThreadSelect?: () => void;
}
```

And call it when thread is clicked:
```tsx
// In ThreadItem click handler or wrap the click
<div onClick={() => {
  router.push(`/chat/${thread.id}`);
  onThreadSelect?.();
}}>
```

5. **Note:** We need to ensure ThreadItem click triggers onThreadSelect. Options:
   - Pass onThreadSelect to ThreadItem
   - Wrap ThreadItem in a div that also calls onThreadSelect
   - Use event delegation

Simplest: Wrap the ThreadItem rendering in the list:
```tsx
<div
  onClick={() => onThreadSelect?.()}
  className="contents" // Don't affect layout
>
  <ThreadItem ... />
</div>
```

Actually, better approach - let ThreadItem handle its own navigation and then call parent callback. Since ThreadItem already uses router.push, we can add an onNavigate prop.

For minimal changes, we'll intercept the click at the list level and just call onThreadSelect on any click inside thread item area.

Add JSDoc updates.
  </action>
  <verify>TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`</verify>
  <done>Sidebar accepts onThreadSelect, integrates footer, passes callback to thread list</done>
</task>

<task type="auto">
  <name>Task 4: Update layout for mobile drawer integration</name>
  <files>sidekiq-webapp/src/app/(dashboard)/chat/layout.tsx, sidekiq-webapp/src/components/sidebar/index.ts</files>
  <action>
Update `layout.tsx`:

1. **Import SidebarMobile:**
```typescript
import { Sidebar, SidebarMobile } from "@sidekiq/components/sidebar";
```

2. **Update layout structure:**
```tsx
<TooltipProvider>
  <div className="flex h-screen">
    {/* Desktop sidebar */}
    <div className="hidden md:flex">
      <Sidebar />
    </div>

    {/* Main content area */}
    <div className="flex flex-1 flex-col">
      {/* Mobile header with drawer trigger */}
      <header className="border-border/50 flex h-14 shrink-0 items-center gap-2 border-b px-4 md:hidden">
        <SidebarMobile>
          <Sidebar />
        </SidebarMobile>
        <span className="text-lg font-semibold">Sidekiq</span>
      </header>

      {/* Main content */}
      <main className="flex-1 overflow-hidden">{children}</main>
    </div>
  </div>
</TooltipProvider>
```

3. **Remove old ThemeToggle from header:**
   - Theme toggle is now in sidebar footer dropdown
   - Mobile users access it via sidebar drawer

4. **Update index.ts barrel export:**
```typescript
export { Sidebar } from "./sidebar";
export { SidebarHeader } from "./sidebar-header";
export { SidebarCollapsed } from "./sidebar-collapsed";
export { SidebarThreadList } from "./sidebar-thread-list";
export { SidebarThreadGroup } from "./sidebar-thread-group";
export { SidebarSearch } from "./sidebar-search";
export { SidebarFooter } from "./sidebar-footer";
export { SidebarMobile } from "./sidebar-mobile";
```

Add/update JSDoc.
  </action>
  <verify>
1. TypeScript compiles: `cd sidekiq-webapp && pnpm tsc --noEmit`
2. Lint passes: `pnpm lint`
  </verify>
  <done>Layout includes mobile drawer, hamburger triggers sidebar sheet</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete sidebar with:
- Collapsible sidebar on desktop with thread list and date grouping
- Search with fuzzy matching and highlighting
- User footer with avatar, theme toggle, and logout
- Mobile drawer that slides from left
- Keyboard shortcuts (Cmd+N, Cmd+B, Cmd+K)
  </what-built>
  <how-to-verify>
1. **Desktop sidebar:**
   - Navigate to http://localhost:3000/chat
   - Verify sidebar shows on left with thread list
   - Click collapse toggle - should show icon rail
   - Click New Chat - should navigate to /chat (new conversation)
   - Test keyboard shortcuts: Cmd+N (new chat), Cmd+B (toggle), Cmd+K (focus search)

2. **Thread list:**
   - Create a few threads if needed (send messages to create them)
   - Verify threads grouped by date (Today, Yesterday, etc.)
   - Verify pinned threads appear in Pinned section only
   - Click a thread - should navigate and highlight active

3. **Search:**
   - Type in search box - should filter threads
   - Verify fuzzy matching (typos work)
   - Verify matching text highlighted
   - Clear search - grouped view returns

4. **Footer:**
   - Click user avatar at bottom
   - Verify dropdown shows Settings, Theme, Logout
   - Toggle theme - should switch light/dark/system
   - Click Logout - should sign out

5. **Mobile:**
   - Resize browser to mobile width (< 768px)
   - Verify hamburger menu appears
   - Click hamburger - drawer slides from left
   - Click a thread - drawer should close
   - Tap outside drawer - should close

6. **Scroll preservation:**
   - Scroll down in thread list
   - Click a thread, then click back
   - Verify scroll position preserved
  </how-to-verify>
  <resume-signal>Type "approved" to confirm sidebar works correctly, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. All files created/updated with proper TypeScript types
2. No TypeScript errors: `pnpm tsc --noEmit`
3. Lint passes: `pnpm lint`
4. Desktop sidebar with footer visible
5. Mobile drawer opens/closes correctly
6. Theme toggle works in footer dropdown
7. Logout works
8. Thread selection closes mobile drawer
</verification>

<success_criteria>
- SidebarFooter shows user avatar and dropdown menu
- Dropdown includes Settings (disabled), Theme submenu, Logout
- Theme toggle switches between Light/Dark/System
- Logout signs user out and redirects to sign-in
- SidebarMobile wraps sidebar in Sheet drawer
- Hamburger icon visible on mobile, opens drawer
- Selecting thread closes mobile drawer
- Tapping overlay closes mobile drawer
- All SIDE requirements met:
  - SIDE-01: History sorted by lastActivityAt (via thread.list query)
  - SIDE-02: Pinned at top (via grouping)
  - SIDE-03: Date grouping (Pinned/Today/Yesterday/etc.)
  - SIDE-04: Search by title with fuzzy matching
  - SIDE-05: Scroll position preserved
  - SIDE-06: Sidekiq indicator (placeholder - threads don't have sidekiq yet)
</success_criteria>

<output>
After completion and approval, create `.planning/phases/05-sidebar-navigation/05-05-SUMMARY.md`
</output>
