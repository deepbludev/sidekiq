---
phase: 08-team-foundation
plan: 05
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - sidekiq-webapp/src/app/invite/[token]/page.tsx
  - sidekiq-webapp/src/app/invite/[token]/layout.tsx
  - sidekiq-webapp/src/components/team/invite-accept-card.tsx
autonomous: true

must_haves:
  truths:
    - "Invite page shows team name and avatar"
    - "Expired invites show clear error message"
    - "Unauthenticated users are directed to sign in"
    - "Authenticated users can accept invite with one click"
    - "Successful acceptance redirects to chat"
  artifacts:
    - path: "sidekiq-webapp/src/app/invite/[token]/page.tsx"
      provides: "Public invite acceptance page"
      exports: ["default"]
    - path: "sidekiq-webapp/src/components/team/invite-accept-card.tsx"
      provides: "Accept invite card component"
      exports: ["InviteAcceptCard"]
  key_links:
    - from: "sidekiq-webapp/src/app/invite/[token]/page.tsx"
      to: "sidekiq-webapp/src/server/api/routers/team.ts"
      via: "getInviteByToken and acceptInvite"
      pattern: "team\\.getInviteByToken|team\\.acceptInvite"
---

<objective>
Create the invite acceptance page and flow.

Purpose: Enable invited users to accept team invitations via the token link. Handle all edge cases: expired invites, wrong email, unauthenticated users, and successful acceptance.

Output: Public invite page at /invite/[token] with appropriate states for all scenarios.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-team-foundation/08-CONTEXT.md
@.planning/phases/08-team-foundation/08-RESEARCH.md
@.planning/phases/08-team-foundation/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create invite accept card component</name>
  <files>sidekiq-webapp/src/components/team/invite-accept-card.tsx</files>
  <action>
Create the invite acceptance card component:

```typescript
"use client";

import { useRouter } from "next/navigation";
import { CheckCircle, XCircle, Clock, AlertTriangle } from "lucide-react";

import { Button } from "@sidekiq/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardFooter,
  CardHeader,
  CardTitle,
} from "@sidekiq/components/ui/card";
import { TeamAvatar } from "@sidekiq/components/team/team-avatar";
import { api } from "@sidekiq/trpc/react";
import { toast } from "sonner";
import type { SidekiqAvatar } from "@sidekiq/server/db/schema";

interface InviteData {
  teamName: string;
  teamAvatar: SidekiqAvatar;
  email: string;
  isExpired: boolean;
  expiresAt: Date;
}

interface InviteAcceptCardProps {
  token: string;
  invite: InviteData | null;
  isAuthenticated: boolean;
  userEmail?: string;
  signInUrl: string;
}

/**
 * Card component for accepting team invitations.
 * Handles various states: valid invite, expired, wrong email, not authenticated.
 */
export function InviteAcceptCard({
  token,
  invite,
  isAuthenticated,
  userEmail,
  signInUrl,
}: InviteAcceptCardProps) {
  const router = useRouter();

  const acceptMutation = api.team.acceptInvite.useMutation({
    onSuccess: (data) => {
      toast.success(`Welcome to ${data.team.name}!`);
      router.push("/chat");
    },
    onError: (error) => {
      toast.error(error.message);
    },
  });

  // Invalid or not found invite
  if (!invite) {
    return (
      <Card className="w-full max-w-md mx-auto">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-destructive/10">
            <XCircle className="h-6 w-6 text-destructive" />
          </div>
          <CardTitle>Invite Not Found</CardTitle>
          <CardDescription>
            This invitation link is invalid or has already been used.
          </CardDescription>
        </CardHeader>
        <CardFooter className="justify-center">
          <Button variant="outline" onClick={() => router.push("/chat")}>
            Go to Sidekiq
          </Button>
        </CardFooter>
      </Card>
    );
  }

  // Expired invite
  if (invite.isExpired) {
    return (
      <Card className="w-full max-w-md mx-auto">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/10">
            <Clock className="h-6 w-6 text-amber-500" />
          </div>
          <CardTitle>Invite Expired</CardTitle>
          <CardDescription>
            This invitation to join <strong>{invite.teamName}</strong> has expired.
            Please ask the team owner to send a new invitation.
          </CardDescription>
        </CardHeader>
        <CardFooter className="justify-center">
          <Button variant="outline" onClick={() => router.push("/chat")}>
            Go to Sidekiq
          </Button>
        </CardFooter>
      </Card>
    );
  }

  // Not authenticated - need to sign in
  if (!isAuthenticated) {
    return (
      <Card className="w-full max-w-md mx-auto">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4">
            <TeamAvatar
              avatar={invite.teamAvatar}
              name={invite.teamName}
              size="xl"
            />
          </div>
          <CardTitle>Join {invite.teamName}</CardTitle>
          <CardDescription>
            You&apos;ve been invited to join <strong>{invite.teamName}</strong> on Sidekiq.
            Sign in or create an account to accept this invitation.
          </CardDescription>
        </CardHeader>
        <CardContent className="text-center text-sm text-muted-foreground">
          <p>This invite is for: <strong>{invite.email}</strong></p>
        </CardContent>
        <CardFooter className="flex-col gap-2">
          <Button className="w-full" asChild>
            <a href={signInUrl}>Sign In to Accept</a>
          </Button>
          <p className="text-xs text-muted-foreground">
            Don&apos;t have an account? You can create one after clicking sign in.
          </p>
        </CardFooter>
      </Card>
    );
  }

  // Wrong email - authenticated but email doesn't match
  if (userEmail && userEmail.toLowerCase() !== invite.email.toLowerCase()) {
    return (
      <Card className="w-full max-w-md mx-auto">
        <CardHeader className="text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-amber-500/10">
            <AlertTriangle className="h-6 w-6 text-amber-500" />
          </div>
          <CardTitle>Email Mismatch</CardTitle>
          <CardDescription>
            This invitation was sent to <strong>{invite.email}</strong>, but you&apos;re
            signed in as <strong>{userEmail}</strong>.
          </CardDescription>
        </CardHeader>
        <CardContent className="text-center text-sm text-muted-foreground">
          <p>Please sign in with the correct email address to accept this invitation.</p>
        </CardContent>
        <CardFooter className="flex-col gap-2">
          <Button variant="outline" className="w-full" asChild>
            <a href="/api/auth/signout?callbackUrl=/invite/${token}">
              Sign Out and Switch Account
            </a>
          </Button>
        </CardFooter>
      </Card>
    );
  }

  // Valid invite - can accept
  return (
    <Card className="w-full max-w-md mx-auto">
      <CardHeader className="text-center">
        <div className="mx-auto mb-4">
          <TeamAvatar
            avatar={invite.teamAvatar}
            name={invite.teamName}
            size="xl"
          />
        </div>
        <CardTitle>Join {invite.teamName}</CardTitle>
        <CardDescription>
          You&apos;ve been invited to join <strong>{invite.teamName}</strong> on Sidekiq.
          Click below to accept and start collaborating with your team.
        </CardDescription>
      </CardHeader>
      <CardFooter className="flex-col gap-2">
        <Button
          className="w-full"
          onClick={() => acceptMutation.mutate({ token })}
          disabled={acceptMutation.isPending}
        >
          {acceptMutation.isPending ? "Joining..." : "Accept Invitation"}
        </Button>
        <Button
          variant="ghost"
          className="w-full"
          onClick={() => router.push("/chat")}
          disabled={acceptMutation.isPending}
        >
          Decline
        </Button>
      </CardFooter>
    </Card>
  );
}
```
  </action>
  <verify>Run `pnpm typecheck` to verify component compiles</verify>
  <done>
- All invite states handled (not found, expired, unauthenticated, wrong email, valid)
- Team avatar and name displayed
- Accept button triggers mutation
- Decline option available
  </done>
</task>

<task type="auto">
  <name>Task 2: Create invite page layout and page</name>
  <files>
    sidekiq-webapp/src/app/invite/[token]/layout.tsx
    sidekiq-webapp/src/app/invite/[token]/page.tsx
  </files>
  <action>
Create the invite page layout and page:

**layout.tsx:**
```typescript
import type { ReactNode } from "react";

interface InviteLayoutProps {
  children: ReactNode;
}

/**
 * Layout for invite pages.
 * Simple centered layout without sidebar.
 */
export default function InviteLayout({ children }: InviteLayoutProps) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-background to-muted/30 p-4">
      {children}
    </div>
  );
}
```

**page.tsx:**
```typescript
import { headers } from "next/headers";
import { auth } from "@sidekiq/server/better-auth";
import { createCaller } from "@sidekiq/server/api/root";
import { createTRPCContext } from "@sidekiq/server/api/trpc";
import { InviteAcceptCard } from "@sidekiq/components/team/invite-accept-card";
import { env } from "@sidekiq/env";

interface InvitePageProps {
  params: Promise<{ token: string }>;
}

/**
 * Public invite acceptance page.
 * Fetches invite data and renders appropriate state.
 */
export default async function InvitePage({ params }: InvitePageProps) {
  const { token } = await params;

  // Get session if user is authenticated
  const session = await auth.api.getSession({
    headers: await headers(),
  });

  // Create tRPC caller for server-side query
  const ctx = await createTRPCContext({
    headers: await headers(),
  });
  const caller = createCaller(ctx);

  // Fetch invite data (public procedure)
  const invite = await caller.team.getInviteByToken({ token });

  // Build sign-in URL with callback to return here after auth
  const currentUrl = `${env.BETTER_AUTH_URL}/invite/${token}`;
  const signInUrl = `/sign-in?callbackUrl=${encodeURIComponent(currentUrl)}`;

  return (
    <InviteAcceptCard
      token={token}
      invite={invite}
      isAuthenticated={!!session?.user}
      userEmail={session?.user?.email}
      signInUrl={signInUrl}
    />
  );
}

export async function generateMetadata({ params }: InvitePageProps) {
  const { token } = await params;

  // Create context for server-side query
  const ctx = await createTRPCContext({
    headers: await headers(),
  });
  const caller = createCaller(ctx);

  const invite = await caller.team.getInviteByToken({ token });

  if (invite && !invite.isExpired) {
    return {
      title: `Join ${invite.teamName} - Sidekiq`,
      description: `You've been invited to join ${invite.teamName} on Sidekiq`,
    };
  }

  return {
    title: "Team Invite - Sidekiq",
    description: "Accept your team invitation on Sidekiq",
  };
}
```
  </action>
  <verify>Run `pnpm typecheck` and `pnpm build` to verify page compiles and renders</verify>
  <done>
- Layout provides centered, clean presentation
- Page fetches invite data server-side
- Session checked for authentication state
- Sign-in URL includes callback to return after auth
- Metadata dynamically set based on invite
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `pnpm typecheck` passes
2. `pnpm build` succeeds
3. Navigate to /invite/[valid-token] shows accept UI
4. Navigate to /invite/[invalid-token] shows not found
5. Expired invites show expired message
6. Unauthenticated users see sign-in prompt
</verification>

<success_criteria>
- Invite page accessible at /invite/[token]
- All invite states render correctly
- Authentication flow redirects back after sign-in
- Accept mutation joins team and redirects to chat
- Metadata reflects team name for valid invites
</success_criteria>

<output>
After completion, create `.planning/phases/08-team-foundation/08-05-SUMMARY.md`
</output>
