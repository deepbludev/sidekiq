---
phase: 08-team-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/server/db/schema.ts
  - sidekiq-webapp/src/lib/validations/team.ts
  - sidekiq-webapp/src/lib/team-permissions.ts
autonomous: true

must_haves:
  truths:
    - "Teams have avatar configuration like Sidekiqs"
    - "Teams have admin role in addition to owner and member"
    - "Teams have configurable member limits"
    - "Role permission checks are available for authorization"
  artifacts:
    - path: "sidekiq-webapp/src/server/db/schema.ts"
      provides: "Extended team schema with avatar, memberLimit"
      contains: "teamRoleEnum.*admin"
    - path: "sidekiq-webapp/src/lib/validations/team.ts"
      provides: "Zod schemas for team operations"
      exports: ["createTeamSchema", "updateTeamSchema", "inviteMemberSchema"]
    - path: "sidekiq-webapp/src/lib/team-permissions.ts"
      provides: "Role permission helper functions"
      exports: ["canInvite", "canRemoveMember", "canChangeRole"]
  key_links:
    - from: "sidekiq-webapp/src/lib/validations/team.ts"
      to: "sidekiq-webapp/src/server/db/schema.ts"
      via: "imports SidekiqAvatar type for team avatar"
      pattern: "import.*SidekiqAvatar"
---

<objective>
Extend database schema and create foundational types for team management.

Purpose: Establish the data layer and validation schemas needed for team CRUD operations, role-based permissions, and invite system. The teams table needs avatar support (reusing Sidekiq pattern), admin role support, and member limits.

Output: Extended schema with team role enum including admin, validation schemas for all team operations, and permission helper functions for authorization checks.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-team-foundation/08-CONTEXT.md
@.planning/phases/08-team-foundation/08-RESEARCH.md
@sidekiq-webapp/src/server/db/schema.ts
@sidekiq-webapp/src/lib/validations/sidekiq.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend team schema with avatar, admin role, and member limit</name>
  <files>sidekiq-webapp/src/server/db/schema.ts</files>
  <action>
1. Update `teamRoleEnum` to include "admin" role: `["owner", "admin", "member"]`

2. Add columns to `teams` table:
   - `avatar`: JSONB using existing `SidekiqAvatar` type with default `{ type: "initials", color: "#6366f1" }`
   - `memberLimit`: integer with default 50 (per CONTEXT.md)

3. Keep existing foreign keys and indexes unchanged.

Note: Schema already has teams, teamMembers, teamInvites tables with proper relations - we're only extending, not recreating.
  </action>
  <verify>Run `pnpm db:generate` to generate migration (if using Drizzle migrations) or verify TypeScript compiles with `pnpm typecheck`</verify>
  <done>
- teamRoleEnum includes "owner", "admin", "member"
- teams table has avatar JSONB column with SidekiqAvatar type
- teams table has memberLimit integer column with default 50
  </done>
</task>

<task type="auto">
  <name>Task 2: Create team validation schemas</name>
  <files>sidekiq-webapp/src/lib/validations/team.ts</files>
  <action>
Create validation schemas following the pattern in `sidekiq.ts`:

1. Re-export `sidekiqAvatarSchema` as `teamAvatarSchema` (same structure) from sidekiq.ts for reuse

2. Create schemas:

```typescript
// createTeamSchema - for team creation
export const createTeamSchema = z.object({
  name: z.string()
    .min(1, "Team name is required")
    .max(100, "Team name must be at most 100 characters"),
  avatar: sidekiqAvatarSchema.default({ type: "initials", color: "#6366f1" }),
});

// updateTeamSchema - for team updates
export const updateTeamSchema = z.object({
  id: z.string().min(1, "Team ID is required"),
  name: z.string().min(1).max(100).optional(),
  avatar: sidekiqAvatarSchema.optional(),
});

// deleteTeamSchema - for team deletion with type-to-confirm pattern
export const deleteTeamSchema = z.object({
  id: z.string().min(1, "Team ID is required"),
});

// inviteMemberSchema - for creating invites
export const inviteMemberSchema = z.object({
  teamId: z.string().min(1, "Team ID is required"),
  email: z.string().email("Invalid email address").transform(e => e.toLowerCase()),
  sendEmail: z.boolean().default(true), // false = generate link only
});

// acceptInviteSchema - for accepting invites
export const acceptInviteSchema = z.object({
  token: z.string().min(1, "Invite token is required"),
});

// revokeInviteSchema - for revoking pending invites
export const revokeInviteSchema = z.object({
  inviteId: z.string().min(1, "Invite ID is required"),
});

// resendInviteSchema - for resending invites
export const resendInviteSchema = z.object({
  inviteId: z.string().min(1, "Invite ID is required"),
});

// removeMemberSchema - for removing members
export const removeMemberSchema = z.object({
  teamId: z.string().min(1, "Team ID is required"),
  userId: z.string().min(1, "User ID is required"),
});

// changeRoleSchema - for changing member roles
export const changeRoleSchema = z.object({
  teamId: z.string().min(1, "Team ID is required"),
  userId: z.string().min(1, "User ID is required"),
  newRole: z.enum(["admin", "member"]), // Cannot change to owner via this
});

// transferOwnershipSchema - for ownership transfer
export const transferOwnershipSchema = z.object({
  teamId: z.string().min(1, "Team ID is required"),
  newOwnerId: z.string().min(1, "New owner ID is required"),
});

// leaveTeamSchema - for member self-leave
export const leaveTeamSchema = z.object({
  teamId: z.string().min(1, "Team ID is required"),
});

// getTeamByIdSchema - for fetching single team
export const getTeamByIdSchema = z.object({
  id: z.string().min(1, "Team ID is required"),
});
```

Export all schemas and their inferred types.
  </action>
  <verify>Run `pnpm typecheck` to ensure schemas compile correctly</verify>
  <done>
- All team-related Zod schemas created
- Types exported for each schema input
- Email transformation to lowercase included in inviteMemberSchema
  </done>
</task>

<task type="auto">
  <name>Task 3: Create role permission helpers</name>
  <files>sidekiq-webapp/src/lib/team-permissions.ts</files>
  <action>
Create permission helper functions per RESEARCH.md and CONTEXT.md:

```typescript
/**
 * Team role type from database enum.
 */
export type TeamRole = "owner" | "admin" | "member";

/**
 * Check if a user with the given role can invite new members.
 * Per CONTEXT.md: Owners and Admins can invite.
 */
export function canInvite(userRole: TeamRole): boolean {
  return userRole === "owner" || userRole === "admin";
}

/**
 * Check if a user can remove a specific member.
 * Per CONTEXT.md:
 * - Owner can remove anyone except themselves
 * - Admin can remove members only (not other admins)
 * - Members cannot remove anyone
 */
export function canRemoveMember(
  userRole: TeamRole,
  targetRole: TeamRole,
  isSelf: boolean
): boolean {
  // Cannot remove self (owner must transfer, others must leave)
  if (isSelf) return false;

  if (userRole === "owner") {
    // Owner can remove anyone except another owner (there's only one owner)
    return targetRole !== "owner";
  }
  if (userRole === "admin") {
    // Admin can only remove members, not other admins
    return targetRole === "member";
  }
  return false;
}

/**
 * Check if a user can change another member's role.
 * Per CONTEXT.md:
 * - Owner can change any role
 * - Admin can promote member to admin, demote admin to member
 * - Admin cannot promote to owner
 * - Members cannot change roles
 */
export function canChangeRole(
  userRole: TeamRole,
  targetRole: TeamRole,
  newRole: TeamRole
): boolean {
  // Cannot change own role
  if (userRole === "owner") {
    // Owner can change any role except their own
    return targetRole !== "owner";
  }
  if (userRole === "admin") {
    // Admin can change member <-> admin but not to owner
    if (newRole === "owner") return false;
    return targetRole === "member" || targetRole === "admin";
  }
  return false;
}

/**
 * Check if a user can transfer team ownership.
 * Only the owner can transfer ownership.
 */
export function canTransferOwnership(userRole: TeamRole): boolean {
  return userRole === "owner";
}

/**
 * Check if a user can delete the team.
 * Only the owner can delete the team.
 */
export function canDeleteTeam(userRole: TeamRole): boolean {
  return userRole === "owner";
}

/**
 * Check if a user can leave the team.
 * Per CONTEXT.md: Members can self-leave.
 * Owner cannot leave (must transfer ownership first).
 */
export function canLeaveTeam(userRole: TeamRole): boolean {
  return userRole !== "owner";
}

/**
 * Check if a user can revoke a pending invite.
 * Owners and Admins can revoke invites.
 */
export function canRevokeInvite(userRole: TeamRole): boolean {
  return userRole === "owner" || userRole === "admin";
}

/**
 * Get display icon for a role.
 * Per CONTEXT.md: crown for owner, shield for admin.
 */
export function getRoleIcon(role: TeamRole): "crown" | "shield" | null {
  if (role === "owner") return "crown";
  if (role === "admin") return "shield";
  return null;
}

/**
 * Get display label for a role.
 */
export function getRoleLabel(role: TeamRole): string {
  if (role === "owner") return "Owner";
  if (role === "admin") return "Admin";
  return "Member";
}
```
  </action>
  <verify>Run `pnpm typecheck` to ensure permissions compile correctly</verify>
  <done>
- All permission helper functions created
- Functions match CONTEXT.md permission rules
- Role display helpers (icon, label) included
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `pnpm typecheck` passes with no errors
2. Schema includes admin role in teamRoleEnum
3. Teams table has avatar and memberLimit columns
4. All validation schemas export correctly
5. Permission helpers are testable pure functions
</verification>

<success_criteria>
- Database schema extended with admin role, avatar, memberLimit
- All team operation schemas created with proper validation
- Permission helper functions match CONTEXT.md rules
- TypeScript types inferred correctly from schemas
</success_criteria>

<output>
After completion, create `.planning/phases/08-team-foundation/08-01-SUMMARY.md`
</output>
