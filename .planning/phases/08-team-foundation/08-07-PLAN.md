---
phase: 08-team-foundation
plan: 07
type: execute
wave: 4
depends_on: ["08-02", "08-03"]
files_modified:
  - sidekiq-webapp/src/components/sidebar/sidebar-teams.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-header.tsx
  - sidekiq-webapp/src/hooks/use-active-team.ts
autonomous: true

must_haves:
  truths:
    - "Team dropdown appears in sidebar header"
    - "User can switch between teams via dropdown"
    - "Active team persists across sessions (localStorage)"
    - "Sidebar shows Teams section with + button"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidebar/sidebar-teams.tsx"
      provides: "Teams section in sidebar"
      exports: ["SidebarTeams"]
    - path: "sidekiq-webapp/src/hooks/use-active-team.ts"
      provides: "Hook for managing active team state"
      exports: ["useActiveTeam"]
  key_links:
    - from: "sidekiq-webapp/src/components/sidebar/sidebar-header.tsx"
      to: "sidekiq-webapp/src/hooks/use-active-team.ts"
      via: "team dropdown"
      pattern: "useActiveTeam"
    - from: "sidekiq-webapp/src/hooks/use-active-team.ts"
      to: "localStorage"
      via: "team persistence"
      pattern: "localStorage.*activeTeamId"
---

<objective>
Integrate team functionality into the sidebar with team dropdown and section.

Purpose: Enable users to access teams from the main sidebar, switch between teams, and navigate to team settings. The active team persists across sessions.

Output: Team dropdown in sidebar header, teams section with navigation, and active team state hook.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-team-foundation/08-CONTEXT.md
@.planning/phases/08-team-foundation/08-02-SUMMARY.md
@.planning/phases/08-team-foundation/08-03-SUMMARY.md
@sidekiq-webapp/src/components/sidebar/sidebar-header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create active team hook with localStorage persistence</name>
  <files>sidekiq-webapp/src/hooks/use-active-team.ts</files>
  <action>
Create a hook for managing active team state with localStorage persistence:

```typescript
"use client";

import { useState, useEffect, useCallback } from "react";
import { api } from "@sidekiq/trpc/react";

const ACTIVE_TEAM_KEY = "sidekiq-active-team-id";

interface UseActiveTeamResult {
  /** Currently active team ID, or null if no team selected */
  activeTeamId: string | null;
  /** Set the active team */
  setActiveTeamId: (teamId: string | null) => void;
  /** The active team data, or null */
  activeTeam: {
    id: string;
    name: string;
    avatar: unknown;
    role: string;
  } | null;
  /** All teams the user is a member of */
  teams: {
    id: string;
    name: string;
    avatar: unknown;
    role: string;
  }[];
  /** Whether teams are loading */
  isLoading: boolean;
}

/**
 * Hook for managing the active team state.
 *
 * Features:
 * - Persists active team to localStorage
 * - Validates stored team ID against user's teams
 * - Falls back to null if stored team is invalid
 *
 * Per CONTEXT.md: Active team selection persists across sessions.
 */
export function useActiveTeam(): UseActiveTeamResult {
  const [activeTeamId, setActiveTeamIdState] = useState<string | null>(null);
  const [isInitialized, setIsInitialized] = useState(false);

  // Fetch user's teams
  const { data: teams = [], isLoading } = api.team.list.useQuery();

  // Initialize from localStorage (SSR-safe)
  useEffect(() => {
    if (typeof window === "undefined") return;

    const stored = localStorage.getItem(ACTIVE_TEAM_KEY);
    setActiveTeamIdState(stored);
    setIsInitialized(true);
  }, []);

  // Validate stored team ID when teams load
  useEffect(() => {
    if (!isInitialized || isLoading) return;

    // If we have a stored ID, validate it exists in user's teams
    if (activeTeamId) {
      const teamExists = teams.some((t) => t.id === activeTeamId);
      if (!teamExists) {
        // Stored team no longer valid (deleted, removed), clear it
        localStorage.removeItem(ACTIVE_TEAM_KEY);
        setActiveTeamIdState(null);
      }
    }
  }, [activeTeamId, teams, isLoading, isInitialized]);

  // Set active team with localStorage persistence
  const setActiveTeamId = useCallback((teamId: string | null) => {
    if (teamId) {
      localStorage.setItem(ACTIVE_TEAM_KEY, teamId);
    } else {
      localStorage.removeItem(ACTIVE_TEAM_KEY);
    }
    setActiveTeamIdState(teamId);
  }, []);

  // Find active team data
  const activeTeam = activeTeamId
    ? teams.find((t) => t.id === activeTeamId) ?? null
    : null;

  return {
    activeTeamId,
    setActiveTeamId,
    activeTeam,
    teams,
    isLoading: isLoading || !isInitialized,
  };
}
```
  </action>
  <verify>Run `pnpm typecheck` to verify hook compiles</verify>
  <done>
- Hook manages active team state
- Persists to localStorage
- Validates stored ID against user's teams
- SSR-safe initialization
  </done>
</task>

<task type="auto">
  <name>Task 2: Create sidebar teams section</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-teams.tsx</files>
  <action>
Create a teams section component for the sidebar:

```typescript
"use client";

import { useState } from "react";
import Link from "next/link";
import { Plus, Settings, Users } from "lucide-react";

import { Button } from "@sidekiq/components/ui/button";
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from "@sidekiq/components/ui/collapsible";
import { TeamAvatar } from "@sidekiq/components/team/team-avatar";
import { TeamCreateDialog } from "@sidekiq/components/team/team-create-dialog";
import { useActiveTeam } from "@sidekiq/hooks/use-active-team";
import type { SidekiqAvatar } from "@sidekiq/server/db/schema";
import { cn } from "@sidekiq/lib/utils";

interface SidebarTeamsProps {
  isCollapsed?: boolean;
}

/**
 * Teams section in the sidebar.
 * Shows user's teams with ability to create new ones.
 * Collapsed mode shows only icons.
 */
export function SidebarTeams({ isCollapsed = false }: SidebarTeamsProps) {
  const [createDialogOpen, setCreateDialogOpen] = useState(false);
  const [isOpen, setIsOpen] = useState(true);
  const { teams, activeTeamId, setActiveTeamId, isLoading } = useActiveTeam();

  if (isLoading) {
    return null; // Don't show loading state in sidebar
  }

  // Collapsed mode - just show icon
  if (isCollapsed) {
    return (
      <div className="px-2 py-1">
        <Link href="/settings/teams">
          <Button variant="ghost" size="icon" className="w-full h-10">
            <Users className="h-5 w-5" />
            <span className="sr-only">Teams</span>
          </Button>
        </Link>
      </div>
    );
  }

  return (
    <>
      <Collapsible open={isOpen} onOpenChange={setIsOpen} className="px-2">
        <div className="flex items-center justify-between py-2">
          <CollapsibleTrigger asChild>
            <Button
              variant="ghost"
              size="sm"
              className="gap-1 px-2 font-semibold text-muted-foreground hover:text-foreground"
            >
              <Users className="h-4 w-4" />
              Teams
              {teams.length > 0 && (
                <span className="ml-1 text-xs">({teams.length})</span>
              )}
            </Button>
          </CollapsibleTrigger>

          <Button
            variant="ghost"
            size="icon"
            className="h-7 w-7"
            onClick={() => setCreateDialogOpen(true)}
          >
            <Plus className="h-4 w-4" />
            <span className="sr-only">Create team</span>
          </Button>
        </div>

        <CollapsibleContent className="space-y-1">
          {teams.length === 0 ? (
            <p className="px-2 py-2 text-xs text-muted-foreground">
              No teams yet. Create one to start collaborating.
            </p>
          ) : (
            teams.map((team) => (
              <Link
                key={team.id}
                href={`/settings/teams?team=${team.id}`}
                onClick={() => setActiveTeamId(team.id)}
                className={cn(
                  "flex items-center gap-2 rounded-lg px-2 py-1.5 text-sm transition-colors hover:bg-muted",
                  activeTeamId === team.id && "bg-muted"
                )}
              >
                <TeamAvatar
                  avatar={team.avatar as SidekiqAvatar}
                  name={team.name}
                  size="sm"
                />
                <span className="truncate flex-1">{team.name}</span>
                <Settings className="h-3.5 w-3.5 text-muted-foreground opacity-0 group-hover:opacity-100" />
              </Link>
            ))
          )}
        </CollapsibleContent>
      </Collapsible>

      <TeamCreateDialog
        open={createDialogOpen}
        onOpenChange={setCreateDialogOpen}
      />
    </>
  );
}
```
  </action>
  <verify>Run `pnpm typecheck` to verify component compiles</verify>
  <done>
- Teams section shows list of user's teams
- Create button opens dialog
- Collapsed mode shows icon only
- Active team highlighted
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate teams into sidebar header with dropdown</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-header.tsx</files>
  <action>
Update the sidebar header to include a team dropdown (if teams exist).

First read the current sidebar-header.tsx file to understand its structure, then add team dropdown functionality.

The team dropdown should:
1. Only appear if user has teams
2. Show active team avatar and name
3. Allow switching between teams
4. Include "Manage Teams" link to settings/teams

Add to the existing sidebar-header.tsx:

```typescript
// Add to imports
import { ChevronDown, Check } from "lucide-react";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@sidekiq/components/ui/dropdown-menu";
import { TeamAvatar } from "@sidekiq/components/team/team-avatar";
import { useActiveTeam } from "@sidekiq/hooks/use-active-team";
import type { SidekiqAvatar } from "@sidekiq/server/db/schema";

// Add team dropdown component (can be inline or separate)
function TeamDropdown() {
  const { teams, activeTeam, setActiveTeamId } = useActiveTeam();

  if (teams.length === 0) {
    return null;
  }

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button variant="ghost" className="gap-2 px-2 h-9 w-full justify-start">
          {activeTeam ? (
            <>
              <TeamAvatar
                avatar={activeTeam.avatar as SidekiqAvatar}
                name={activeTeam.name}
                size="sm"
              />
              <span className="truncate flex-1 text-left">{activeTeam.name}</span>
            </>
          ) : (
            <>
              <Users className="h-4 w-4" />
              <span className="text-muted-foreground">Select team</span>
            </>
          )}
          <ChevronDown className="h-4 w-4 text-muted-foreground" />
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="start" className="w-56">
        <DropdownMenuItem
          onClick={() => setActiveTeamId(null)}
          className="flex items-center gap-2"
        >
          <div className="h-5 w-5 flex items-center justify-center">
            {!activeTeam && <Check className="h-4 w-4" />}
          </div>
          <span>Personal</span>
        </DropdownMenuItem>
        <DropdownMenuSeparator />
        {teams.map((team) => (
          <DropdownMenuItem
            key={team.id}
            onClick={() => setActiveTeamId(team.id)}
            className="flex items-center gap-2"
          >
            <div className="h-5 w-5 flex items-center justify-center">
              {activeTeam?.id === team.id && <Check className="h-4 w-4" />}
            </div>
            <TeamAvatar
              avatar={team.avatar as SidekiqAvatar}
              name={team.name}
              size="sm"
            />
            <span className="truncate">{team.name}</span>
          </DropdownMenuItem>
        ))}
        <DropdownMenuSeparator />
        <DropdownMenuItem asChild>
          <Link href="/settings/teams" className="flex items-center gap-2">
            <Settings className="h-4 w-4" />
            Manage Teams
          </Link>
        </DropdownMenuItem>
      </DropdownMenuContent>
    </DropdownMenu>
  );
}

// Then use <TeamDropdown /> in the header where appropriate
// Usually below the logo/new chat button area
```

Integration approach:
- If sidebar header has a simple structure, add TeamDropdown below the main action buttons
- If collapsed, hide the dropdown (teams accessible via SidebarTeams section)
- Keep existing functionality intact
  </action>
  <verify>Run `pnpm typecheck` and test sidebar in browser</verify>
  <done>
- Team dropdown appears in sidebar header
- Shows active team or "Personal" option
- Switching teams updates localStorage
- Manage Teams link navigates to settings
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `pnpm typecheck` passes
2. Sidebar shows team dropdown (when user has teams)
3. Switching teams persists across page refresh
4. Teams section in sidebar lists all teams
5. Create team button opens dialog from sidebar
</verification>

<success_criteria>
- Active team hook persists to localStorage
- Team dropdown in sidebar header allows switching
- Teams section shows all user's teams
- Collapsed sidebar shows teams icon
- Invalid stored team ID is cleared
</success_criteria>

<output>
After completion, create `.planning/phases/08-team-foundation/08-07-SUMMARY.md`
</output>
