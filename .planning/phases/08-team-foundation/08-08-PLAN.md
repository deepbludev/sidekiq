---
phase: 08-team-foundation
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/drizzle/0002_team_schema_sync.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "team_role enum includes 'admin' value"
    - "team table has avatar JSONB column with correct default"
    - "team table has member_limit integer column with default 50"
    - "team.list tRPC query returns successfully"
  artifacts:
    - path: "sidekiq-webapp/drizzle/0002_team_schema_sync.sql"
      provides: "Schema sync migration"
      contains: "ALTER TYPE team_role ADD VALUE"
  key_links:
    - from: "sidekiq-webapp/drizzle/0002_team_schema_sync.sql"
      to: "sidekiq-webapp/src/server/db/schema.ts"
      via: "enum and column alignment"
      pattern: "team_role.*admin"
---

<objective>
Sync database schema with schema.ts by creating migration for missing team_role enum value and team table columns.

Purpose: Fix database schema mismatch causing team.list tRPC query to fail. The schema.ts file defines 'admin' role and additional columns that the 0001_core_models.sql migration did not include.

Output: Migration file that brings database in sync with Drizzle schema.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@sidekiq-webapp/src/server/db/schema.ts
@sidekiq-webapp/drizzle/0001_core_models.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema sync migration</name>
  <files>sidekiq-webapp/drizzle/0002_team_schema_sync.sql</files>
  <action>
Create a new migration file `0002_team_schema_sync.sql` with the following SQL statements:

1. Add 'admin' value to team_role enum:
```sql
ALTER TYPE team_role ADD VALUE 'admin';
```
Note: PostgreSQL requires ALTER TYPE ADD VALUE to be run outside a transaction. Drizzle handles this correctly.

2. Add avatar column to team table:
```sql
ALTER TABLE "team" ADD COLUMN "avatar" jsonb NOT NULL DEFAULT '{"type":"initials","color":"#6366f1"}'::jsonb;
```

3. Add member_limit column to team table:
```sql
ALTER TABLE "team" ADD COLUMN "member_limit" integer NOT NULL DEFAULT 50;
```

Use `--> statement-breakpoint` between statements as per Drizzle migration convention (see 0001_core_models.sql for pattern).

Also add missing columns and indexes from schema.ts for sidekiq table that were not in the original migration:
- conversation_starters jsonb
- default_model varchar
- avatar jsonb
- is_favorite boolean
- last_used_at timestamp
- thread_count integer
- sidekiq_favorite_idx index
- sidekiq_owner_name_unique index

And for thread table:
- deleted_sidekiq_name varchar
  </action>
  <verify>
File exists at sidekiq-webapp/drizzle/0002_team_schema_sync.sql with all required ALTER statements.
  </verify>
  <done>Migration file created with enum update, team columns, sidekiq columns, and thread column additions.</done>
</task>

<task type="auto">
  <name>Task 2: Apply migration and verify</name>
  <files>None (database operation)</files>
  <action>
Run the migration against the local database:

```bash
cd sidekiq-webapp && pnpm db:push
```

This will apply the schema changes to the database.

If db:push fails due to enum constraints (ADD VALUE must be outside transaction), create a manual migration approach:

1. First try `pnpm db:push`
2. If that fails, use `psql` directly to apply the enum change:
```bash
docker exec -i sidekiq-db psql -U postgres -d sidekiq -c "ALTER TYPE team_role ADD VALUE IF NOT EXISTS 'admin';"
```

Then run db:push again for the column changes.

After migration, verify the changes took effect by checking the database:
```bash
docker exec -i sidekiq-db psql -U postgres -d sidekiq -c "\d team"
docker exec -i sidekiq-db psql -U postgres -d sidekiq -c "\dT+ team_role"
```
  </action>
  <verify>
1. `pnpm db:push` completes successfully (or manual psql + db:push)
2. `\d team` shows avatar and member_limit columns
3. `\dT+ team_role` shows owner, admin, member values
  </verify>
  <done>Database schema matches schema.ts - avatar column, member_limit column, and admin role all present.</done>
</task>

<task type="auto">
  <name>Task 3: Verify tRPC team.list works</name>
  <files>None (verification only)</files>
  <action>
Start the dev server and verify the team.list query no longer fails:

```bash
cd sidekiq-webapp && pnpm dev
```

Then test the team functionality:
1. Open browser to http://localhost:3000
2. Log in if needed
3. Navigate to sidebar - teams section should load without errors
4. Create a new team via the UI to confirm full CRUD works

Check browser dev tools Network tab for `/api/trpc/team.list` - should return 200.
  </action>
  <verify>
1. Dev server starts without errors
2. team.list tRPC call returns 200 in Network tab
3. Teams section in sidebar renders correctly
4. Team creation works end-to-end
  </verify>
  <done>team.list tRPC query works, teams display in sidebar, and team CRUD operations function correctly.</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Database schema matches schema.ts (no drift)
2. team_role enum has all three values: owner, admin, member
3. team table has avatar and member_limit columns
4. All Phase 8 team functionality works as expected
</verification>

<success_criteria>
- Migration file 0002_team_schema_sync.sql exists
- Database has correct enum and columns
- team.list tRPC returns data successfully
- Team UI in sidebar loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-team-foundation/08-08-SUMMARY.md`
</output>
