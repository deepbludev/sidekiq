---
phase: 03-thread-management
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/components/chat/chat-interface.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After first message exchange, AI response streams completely"
    - "URL updates to /chat/[threadId] without component unmount"
    - "onFinish callback fires, triggering title generation"
    - "Thread receives auto-generated title after first exchange"
  artifacts:
    - path: "sidekiq-webapp/src/components/chat/chat-interface.tsx"
      provides: "URL update via history API instead of router"
      contains: "window.history.replaceState"
  key_links:
    - from: "sidekiq-webapp/src/components/chat/chat-interface.tsx"
      to: "window.history"
      via: "replaceState call in customFetch"
      pattern: "window\\.history\\.replaceState"
---

<objective>
Fix the stream abortion bug caused by router.replace() triggering component unmount during streaming.

Purpose: The current implementation uses router.replace() which unmounts ChatInterface mid-stream, aborting the AI response. Using window.history.replaceState() updates the URL without navigation/remount.
Output: Modified chat-interface.tsx with history API call instead of router navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/debug/ai-response-not-triggered-on-first-message.md

# File to modify
@sidekiq-webapp/src/components/chat/chat-interface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace router.replace with window.history.replaceState</name>
  <files>sidekiq-webapp/src/components/chat/chat-interface.tsx</files>
  <action>
In the customFetch function (around line 61), replace:

```typescript
router.replace(`/chat/${newThreadId}`);
```

With:

```typescript
window.history.replaceState(null, "", `/chat/${newThreadId}`);
```

This updates the browser URL without triggering React navigation, so:
- ChatInterface does NOT unmount
- Streaming connection stays alive
- useChat receives the full AI response
- onFinish callback fires
- Title generation triggers

Since router is no longer used in customFetch, you can remove it from the useCallback dependency array if desired. However, keep the router import and useRouter() call since they may be needed elsewhere or for future use.
  </action>
  <verify>
1. `pnpm exec tsc --noEmit` in sidekiq-webapp passes
2. `pnpm lint` passes
  </verify>
  <done>
customFetch uses window.history.replaceState() instead of router.replace()
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify the fix manually</name>
  <files>None</files>
  <action>
Start the dev server if not running and test the fix:

1. Navigate to /chat (new chat state, threadId=null)
2. Send a message (e.g., "Hello, what's the weather like today?")
3. Observe:
   - URL changes to /chat/[threadId] (verify in browser address bar)
   - AI response streams in completely
   - No need for second message to trigger response
4. Wait a few seconds
5. Refresh the page or check sidebar
6. Observe: Thread title is auto-generated (not null or "New conversation" unless API failed)

If testing reveals issues, debug using browser DevTools Network tab to verify:
- Single POST to /api/chat
- Response streams to completion (not aborted)
- X-Thread-Id header present in response
  </action>
  <verify>
From /chat, first message triggers:
1. URL change to /chat/[threadId]
2. Complete AI response in same session
3. Title updates after response completes
  </verify>
  <done>
Bug confirmed fixed: AI responds on first message, title auto-generates
  </done>
</task>

</tasks>

<verification>
1. URL updates without page navigation or component remount
2. AI response streams completely on first message
3. No "second message required" behavior
4. Thread title auto-generates after first exchange
5. TypeScript compiles without errors
</verification>

<success_criteria>
- First message from /chat triggers complete AI response (no second message needed)
- URL updates to /chat/[threadId] while streaming continues
- Thread title is auto-generated after first AI response completes
- Existing thread behavior (/chat/[threadId]) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/03-thread-management/03-04-SUMMARY.md`
</output>
