---
phase: 11-workspace-authorization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/shared/lib/workspace-auth.ts
  - sidekiq-webapp/src/shared/trpc/trpc.ts
  - sidekiq-webapp/src/shared/trpc/react.tsx
  - sidekiq-webapp/src/features/chats/components/chat-interface.tsx
autonomous: true

must_haves:
  truths:
    - "workspaceProcedure exists and extends protectedProcedure with workspace membership validation"
    - "validateWorkspaceMembership() is a shared function usable by both tRPC and non-tRPC code paths"
    - "Every tRPC request from the browser includes x-workspace-id header read from localStorage"
    - "Every /api/chat request from the browser includes x-workspace-id header read from localStorage"
    - "Missing x-workspace-id header falls back to personal workspace in workspaceProcedure"
  artifacts:
    - path: "sidekiq-webapp/src/shared/lib/workspace-auth.ts"
      provides: "validateWorkspaceMembership() and resolveWorkspaceId() helpers"
      exports: ["validateWorkspaceMembership", "resolveWorkspaceId"]
    - path: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      provides: "workspaceProcedure builder"
      exports: ["workspaceProcedure"]
    - path: "sidekiq-webapp/src/shared/trpc/react.tsx"
      provides: "x-workspace-id header injection in tRPC client"
      contains: "x-workspace-id"
    - path: "sidekiq-webapp/src/features/chats/components/chat-interface.tsx"
      provides: "x-workspace-id header injection in DefaultChatTransport"
      contains: "x-workspace-id"
  key_links:
    - from: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      to: "sidekiq-webapp/src/shared/lib/workspace-auth.ts"
      via: "import validateWorkspaceMembership"
      pattern: "import.*validateWorkspaceMembership.*workspace-auth"
    - from: "sidekiq-webapp/src/shared/trpc/react.tsx"
      to: "localStorage"
      via: "localStorage.getItem in headers function"
      pattern: "localStorage\\.getItem.*sidekiq-active-workspace-id"
    - from: "sidekiq-webapp/src/features/chats/components/chat-interface.tsx"
      to: "localStorage"
      via: "localStorage.getItem in DefaultChatTransport headers"
      pattern: "x-workspace-id"
---

<objective>
Create the shared workspace authorization infrastructure: the `validateWorkspaceMembership()` helper, the `workspaceProcedure` tRPC middleware, and client-side `x-workspace-id` header injection in both the tRPC client and the chat transport.

Purpose: This is the foundation that all other Phase 11 plans depend on. Without the shared helper and middleware, routers cannot be scoped. Without client header injection, the server has no workspace context.

Output: 1 new file (`workspace-auth.ts`), 3 modified files (`trpc.ts`, `react.tsx`, `chat-interface.tsx`).
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-workspace-authorization/11-CONTEXT.md
@.planning/phases/11-workspace-authorization/11-RESEARCH.md

Key source files to reference:
@sidekiq-webapp/src/shared/trpc/trpc.ts
@sidekiq-webapp/src/shared/trpc/react.tsx
@sidekiq-webapp/src/shared/db/schema.ts
@sidekiq-webapp/src/features/workspace/lib/permissions.ts
@sidekiq-webapp/src/features/workspace/hooks/use-active-workspace.ts
@sidekiq-webapp/src/features/chats/components/chat-interface.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared workspace authorization helper</name>
  <files>sidekiq-webapp/src/shared/lib/workspace-auth.ts</files>
  <action>
Create a NEW file `src/shared/lib/workspace-auth.ts` with two exported functions:

**1. `validateWorkspaceMembership(db, workspaceId, userId)`**
- Queries `workspaceMembers` table joining `workspace` relation
- WHERE: `workspaceMembers.workspaceId = workspaceId AND workspaceMembers.userId = userId`
- Returns `{ role: WorkspaceRole, workspaceType: "personal" | "team" } | null`
- Uses `db.query.workspaceMembers.findFirst()` with `with: { workspace: { columns: { type: true } } }`
- Import `WorkspaceRole` from `@sidekiq/workspace/lib/permissions`
- Import schema from `@sidekiq/shared/db/schema`
- Import `and, eq` from `drizzle-orm`

**2. `resolveWorkspaceId(db, headerWorkspaceId, userId)`**
- If `headerWorkspaceId` is provided and valid (via `validateWorkspaceMembership`), return `{ workspaceId, role }`
- If `headerWorkspaceId` is provided but INVALID (user not member), log a warning: `[Auth] Unauthorized workspace access: userId=..., workspaceId=..., timestamp=...` and fall through to personal
- If no header or invalid header, look up personal workspace: `db.query.workspaces.findFirst()` where `ownerId = userId AND type = "personal"`
- If personal workspace not found (self-healing), create it:
  - Insert into `workspaces` with `nanoid()` id, name "Personal", type "personal", ownerId, memberLimit 1, avatar `{ type: "initials", color: "#6366f1" }`
  - Insert into `workspaceMembers` with the new workspaceId, userId, role "owner"
  - Return the new workspace id with role "owner"
- If personal workspace found, return `{ workspaceId: personalWorkspace.id, role: "owner" as WorkspaceRole }`

Use proper TypeScript types. Use `typeof db` for the database parameter type (import `db` from `@sidekiq/shared/db`). Add JSDoc to both functions explaining their purpose and that they are shared between tRPC middleware and the chat route handler.

The self-healing pattern mirrors the existing `databaseHooks.user.create.after` in `features/auth/api/config.ts` -- reference that for the exact field values (nanoid import, avatar shape, etc.).
  </action>
  <verify>
`npx tsc --noEmit` passes with no type errors in the new file. Verify imports resolve correctly.
  </verify>
  <done>
`workspace-auth.ts` exports `validateWorkspaceMembership` and `resolveWorkspaceId` with correct types. Both functions compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add workspaceProcedure to tRPC and inject client headers</name>
  <files>
    sidekiq-webapp/src/shared/trpc/trpc.ts
    sidekiq-webapp/src/shared/trpc/react.tsx
    sidekiq-webapp/src/features/chats/components/chat-interface.tsx
  </files>
  <action>
**A. `src/shared/trpc/trpc.ts` -- Add workspaceProcedure**

Add a new exported `workspaceProcedure` after the existing `protectedProcedure`:

```typescript
export const workspaceProcedure = protectedProcedure.use(async ({ ctx, next }) => {
  const headerWorkspaceId = ctx.headers.get("x-workspace-id");

  const resolved = await resolveWorkspaceId(
    ctx.db,
    headerWorkspaceId,
    ctx.session.user.id,
  );

  return next({
    ctx: {
      workspaceId: resolved.workspaceId,
      workspaceRole: resolved.role,
    },
  });
});
```

- Import `resolveWorkspaceId` from `@sidekiq/shared/lib/workspace-auth`
- The `resolveWorkspaceId` function handles: missing header -> personal workspace fallback, invalid workspace -> log + personal fallback, valid workspace -> return it
- Note: Do NOT throw on missing header (graceful degradation per CONTEXT.md). Do NOT throw on invalid workspace either (resolveWorkspaceId handles fallback + logging internally)
- Add JSDoc explaining this extends protectedProcedure with workspace membership validation and context injection

**B. `src/shared/trpc/react.tsx` -- Inject x-workspace-id header in tRPC client**

In the `httpBatchStreamLink` config, update the `headers` function:

```typescript
headers: () => {
  const headers = new Headers();
  headers.set("x-trpc-source", "nextjs-react");
  // Inject active workspace ID from localStorage on every request
  if (typeof window !== "undefined") {
    const workspaceId = localStorage.getItem("sidekiq-active-workspace-id");
    if (workspaceId) {
      headers.set("x-workspace-id", workspaceId);
    }
  }
  return headers;
},
```

IMPORTANT: Read directly from `localStorage.getItem()` inside the headers function, NOT from React state. The `headers` function is called per-request by tRPC, so it always gets the latest value even though the tRPC client is created once in `useState`. The `typeof window !== "undefined"` guard is needed because this code runs in both server and client contexts. The localStorage key `sidekiq-active-workspace-id` is already used by `use-active-workspace.ts`.

**C. `src/features/chats/components/chat-interface.tsx` -- Inject x-workspace-id in DefaultChatTransport**

In the `useMemo` that creates the `DefaultChatTransport`, add a `headers` option:

```typescript
const transport = useMemo(
  () =>
    new DefaultChatTransport({
      api: "/api/chat",
      headers: () => {
        const headers: Record<string, string> = {};
        if (typeof window !== "undefined") {
          const workspaceId = localStorage.getItem("sidekiq-active-workspace-id");
          if (workspaceId) {
            headers["x-workspace-id"] = workspaceId;
          }
        }
        return headers;
      },
      body: () => {
        // existing body logic unchanged
        const currentThreadId = activeThreadIdRef.current;
        if (currentThreadId) {
          return { threadId: currentThreadId };
        }
        return sidekiq ? { sidekiqId: sidekiq.id } : {};
      },
      fetch: customFetch,
    }),
  [sidekiq, customFetch],
);
```

Verify that `DefaultChatTransport` accepts a `headers` option (it does per AI SDK v6 -- the type accepts `headers?: HeadersInit | (() => HeadersInit | Promise<HeadersInit>)`).
  </action>
  <verify>
1. `npx tsc --noEmit` passes -- no type errors
2. `pnpm build` in sidekiq-webapp succeeds (validates server/client boundary, imports)
3. Grep for "x-workspace-id" appears in all 3 files: `trpc.ts`, `react.tsx`, `chat-interface.tsx`
  </verify>
  <done>
- `workspaceProcedure` is exported from `trpc.ts` and extends `protectedProcedure` with `workspaceId` and `workspaceRole` in context
- tRPC client injects `x-workspace-id` header from localStorage on every request
- Chat transport injects `x-workspace-id` header from localStorage on every request
- All three modifications compile and build successfully
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- no type errors across all modified/new files
2. `pnpm build` -- full Next.js build passes
3. Grep confirms `x-workspace-id` appears in `trpc.ts`, `react.tsx`, `chat-interface.tsx`, and `workspace-auth.ts`
4. `workspaceProcedure` is exported from `trpc.ts`
5. `validateWorkspaceMembership` and `resolveWorkspaceId` are exported from `workspace-auth.ts`
</verification>

<success_criteria>
- workspaceProcedure exists in trpc.ts and is importable by routers
- validateWorkspaceMembership exists and is importable by chat route handler
- resolveWorkspaceId handles missing header (personal fallback), invalid workspace (log + personal fallback), and valid workspace
- Client tRPC requests include x-workspace-id header from localStorage
- Client chat transport requests include x-workspace-id header from localStorage
- Full build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/11-workspace-authorization/11-01-SUMMARY.md`
</output>
