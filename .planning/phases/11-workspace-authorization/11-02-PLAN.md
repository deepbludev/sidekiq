---
phase: 11-workspace-authorization
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - sidekiq-webapp/src/features/chats/api/router.ts
  - sidekiq-webapp/src/features/sidekiqs/api/router.ts
autonomous: true

must_haves:
  truths:
    - "All 7 thread procedures use workspaceProcedure instead of protectedProcedure"
    - "All 7 sidekiq procedures use workspaceProcedure instead of protectedProcedure"
    - "thread.list filters by workspaceId (not userId) so team members see all workspace threads"
    - "Thread mutations still check userId to ensure only thread creators can modify their threads"
    - "sidekiq.list filters by workspaceId (not ownerId) so team members see all workspace sidekiqs"
    - "Sidekiq name uniqueness is scoped to workspace (not user)"
    - "Sidekiq mutations still check ownerId to ensure only creators can modify"
    - "New sidekiqs are created with workspaceId from context"
    - "Duplicated sidekiqs are created with workspaceId from context"
  artifacts:
    - path: "sidekiq-webapp/src/features/chats/api/router.ts"
      provides: "Workspace-scoped thread procedures"
      contains: "workspaceProcedure"
    - path: "sidekiq-webapp/src/features/sidekiqs/api/router.ts"
      provides: "Workspace-scoped sidekiq procedures"
      contains: "workspaceProcedure"
  key_links:
    - from: "sidekiq-webapp/src/features/chats/api/router.ts"
      to: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      via: "import workspaceProcedure"
      pattern: "import.*workspaceProcedure.*trpc"
    - from: "sidekiq-webapp/src/features/sidekiqs/api/router.ts"
      to: "sidekiq-webapp/src/shared/trpc/trpc.ts"
      via: "import workspaceProcedure"
      pattern: "import.*workspaceProcedure.*trpc"
    - from: "sidekiq-webapp/src/features/chats/api/router.ts"
      to: "ctx.workspaceId"
      via: "workspaceId filter in thread queries"
      pattern: "threads\\.workspaceId.*ctx\\.workspaceId"
    - from: "sidekiq-webapp/src/features/sidekiqs/api/router.ts"
      to: "ctx.workspaceId"
      via: "workspaceId filter in sidekiq queries"
      pattern: "sidekiqs\\.workspaceId.*ctx\\.workspaceId"
---

<objective>
Migrate all 14 procedures in the thread and sidekiq routers from `protectedProcedure` to `workspaceProcedure`, changing data filtering from user-based to workspace-based while preserving ownership checks on mutations.

Purpose: This enforces workspace isolation at the tRPC layer. After this plan, all thread and sidekiq data access is scoped to the active workspace, meaning users only see content belonging to the workspace they're operating in.

Output: 2 modified router files with all 14 procedures workspace-scoped.
</objective>

<execution_context>
@/Users/carlocasorzo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/carlocasorzo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-workspace-authorization/11-CONTEXT.md
@.planning/phases/11-workspace-authorization/11-RESEARCH.md
@.planning/phases/11-workspace-authorization/11-01-SUMMARY.md

Key source files:
@sidekiq-webapp/src/features/chats/api/router.ts
@sidekiq-webapp/src/features/sidekiqs/api/router.ts
@sidekiq-webapp/src/shared/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate thread router to workspaceProcedure</name>
  <files>sidekiq-webapp/src/features/chats/api/router.ts</files>
  <action>
Change the import from `protectedProcedure` to `workspaceProcedure`:
```typescript
import {
  createTRPCRouter,
  workspaceProcedure,
} from "@sidekiq/shared/trpc/trpc";
```

Migrate all 7 procedures. The pattern for each:

**1. `getTitle` (query) -- Switch to workspaceProcedure, add workspaceId filter**
- Change `protectedProcedure` to `workspaceProcedure`
- Change WHERE from `eq(threads.userId, ctx.session.user.id)` to `eq(threads.workspaceId, ctx.workspaceId)` in the `and()` clause
- Keep `eq(threads.id, input.threadId)` -- still filter by specific thread ID

**2. `list` (query) -- Switch to workspaceProcedure, replace userId with workspaceId**
- Change `protectedProcedure` to `workspaceProcedure`
- In the `where` clause, replace `eq(threads.userId, ctx.session.user.id)` with `eq(threads.workspaceId, ctx.workspaceId)` in BOTH branches (archived and non-archived)
- This is an INTENTIONAL semantics change: in a team workspace, this now returns ALL threads from ALL members, not just the requesting user's threads. This is correct behavior per research (shared visibility in team workspaces).

**3. `delete` (mutation) -- Switch to workspaceProcedure, add workspaceId, KEEP userId**
- Change `protectedProcedure` to `workspaceProcedure`
- Change the `.where()` clause to: `and(eq(threads.id, input.threadId), eq(threads.workspaceId, ctx.workspaceId), eq(threads.userId, ctx.session.user.id))`
- THREE conditions: thread ID match, workspace match, AND user ownership. This ensures only the thread creator can delete, even in team workspaces.

**4. `archive` (mutation) -- Same pattern as delete**
- Change `protectedProcedure` to `workspaceProcedure`
- Add `eq(threads.workspaceId, ctx.workspaceId)` to the `and()` clause alongside existing `eq(threads.id, ...)` and `eq(threads.userId, ...)`

**5. `unarchive` (mutation) -- Same pattern as delete**
- Change `protectedProcedure` to `workspaceProcedure`
- Add `eq(threads.workspaceId, ctx.workspaceId)` to the `and()` clause

**6. `togglePin` (mutation) -- Same pattern as delete**
- Change `protectedProcedure` to `workspaceProcedure`
- Add `eq(threads.workspaceId, ctx.workspaceId)` to BOTH the initial `findFirst` query and the subsequent `update().where()` clause

**7. `rename` (mutation) -- Same pattern as delete**
- Change `protectedProcedure` to `workspaceProcedure`
- Add `eq(threads.workspaceId, ctx.workspaceId)` to the `and()` clause

IMPORTANT: All mutations keep `eq(threads.userId, ctx.session.user.id)` -- only the thread creator can modify. The `getTitle` query uses workspaceId (not userId) because in team workspaces, a member should be able to see the title of another member's thread.

Update JSDoc on the router to reflect workspace scoping instead of "ownership verification via userId."
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Grep for `protectedProcedure` in `features/chats/api/router.ts` returns 0 matches (all replaced)
3. Grep for `workspaceProcedure` in `features/chats/api/router.ts` returns 7 matches (one per procedure)
4. Grep for `ctx.workspaceId` in `features/chats/api/router.ts` returns matches in all 7 procedures
  </verify>
  <done>
All 7 thread procedures use `workspaceProcedure`. List query filters by `workspaceId`. All mutations include both `workspaceId` and `userId` in WHERE clauses. No `protectedProcedure` remains in the file.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate sidekiq router to workspaceProcedure</name>
  <files>sidekiq-webapp/src/features/sidekiqs/api/router.ts</files>
  <action>
Change the import from `protectedProcedure` to `workspaceProcedure`:
```typescript
import {
  createTRPCRouter,
  workspaceProcedure,
} from "@sidekiq/shared/trpc/trpc";
```

Migrate all 7 procedures:

**1. `list` (query) -- Replace ownerId filter with workspaceId**
- Change `protectedProcedure` to `workspaceProcedure`
- Change `eq(sidekiqs.ownerId, ctx.session.user.id)` to `eq(sidekiqs.workspaceId, ctx.workspaceId)`
- This means team workspace members see all workspace sidekiqs, not just their own

**2. `getById` (query) -- Replace ownerId with workspaceId**
- Change `protectedProcedure` to `workspaceProcedure`
- In the `where` clause, replace `eq(sidekiqs.ownerId, ctx.session.user.id)` with `eq(sidekiqs.workspaceId, ctx.workspaceId)`
- This allows any workspace member to view any sidekiq in the workspace

**3. `create` (mutation) -- Add workspaceId, scope uniqueness to workspace**
- Change `protectedProcedure` to `workspaceProcedure`
- In the name uniqueness check, change `eq(sidekiqs.ownerId, ctx.session.user.id)` to `eq(sidekiqs.workspaceId, ctx.workspaceId)` -- uniqueness is now per-workspace, not per-user
- In the `insert().values()`, add `workspaceId: ctx.workspaceId` alongside the existing `ownerId: ctx.session.user.id`
- Keep `ownerId: ctx.session.user.id` -- the owner is still tracked for audit/display purposes

**4. `update` (mutation) -- Add workspaceId, keep ownerId, scope uniqueness to workspace**
- Change `protectedProcedure` to `workspaceProcedure`
- In the name uniqueness check, change `eq(sidekiqs.ownerId, ctx.session.user.id)` to `eq(sidekiqs.workspaceId, ctx.workspaceId)`
- In the `.where()` clause of the update, change to: `and(eq(sidekiqs.id, id), eq(sidekiqs.workspaceId, ctx.workspaceId), eq(sidekiqs.ownerId, ctx.session.user.id))`
- THREE conditions: id match, workspace match, AND owner match. Only the creator can update.

**5. `delete` (mutation) -- Add workspaceId, keep ownerId**
- Change `protectedProcedure` to `workspaceProcedure`
- In the initial `findFirst` query, replace `eq(sidekiqs.ownerId, ...)` with `and(eq(sidekiqs.workspaceId, ctx.workspaceId), eq(sidekiqs.ownerId, ctx.session.user.id))`
- In the final `delete().where()`, change to: `and(eq(sidekiqs.id, id), eq(sidekiqs.workspaceId, ctx.workspaceId), eq(sidekiqs.ownerId, ctx.session.user.id))`
- For the thread deletion/update within the delete procedure:
  - `deleteThreads` branch: add `eq(threads.workspaceId, ctx.workspaceId)` to the WHERE clause alongside existing `eq(threads.sidekiqId, id)` and `eq(threads.userId, ctx.session.user.id)`
  - `deletedSidekiqName` update branch: keep as-is (updates all threads referencing this sidekiq regardless of workspace -- this is correct since the sidekiq itself is already workspace-verified)

**6. `toggleFavorite` (mutation) -- Add workspaceId, keep ownerId**
- Change `protectedProcedure` to `workspaceProcedure`
- In the initial `findFirst`, change to: `and(eq(sidekiqs.id, input.id), eq(sidekiqs.workspaceId, ctx.workspaceId), eq(sidekiqs.ownerId, ctx.session.user.id))`
- In the `update().where()`, change to the same three-condition pattern

**7. `duplicate` (mutation) -- Add workspaceId, scope uniqueness to workspace**
- Change `protectedProcedure` to `workspaceProcedure`
- In the initial `findFirst` for the original sidekiq, change `eq(sidekiqs.ownerId, ...)` to `eq(sidekiqs.workspaceId, ctx.workspaceId)` (any workspace member can duplicate any workspace sidekiq)
- In the uniqueness loop, change `eq(sidekiqs.ownerId, ctx.session.user.id)` to `eq(sidekiqs.workspaceId, ctx.workspaceId)` (name uniqueness is per-workspace)
- In the `insert().values()`, add `workspaceId: ctx.workspaceId` alongside existing `ownerId: ctx.session.user.id`
- The duplicate belongs to the duplicating user (ownerId) in the same workspace

Update JSDoc on the router to reflect workspace scoping.
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Grep for `protectedProcedure` in `features/sidekiqs/api/router.ts` returns 0 matches (all replaced)
3. Grep for `workspaceProcedure` in `features/sidekiqs/api/router.ts` returns 7 matches
4. Grep for `ctx.workspaceId` in `features/sidekiqs/api/router.ts` returns matches in all 7 procedures
5. `pnpm build` in sidekiq-webapp succeeds
  </verify>
  <done>
All 7 sidekiq procedures use `workspaceProcedure`. List and getById filter by `workspaceId`. Mutations include both `workspaceId` and `ownerId`. Name uniqueness is workspace-scoped. New sidekiqs and duplicates include `workspaceId`. No `protectedProcedure` remains in the file.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero type errors in both router files
2. `pnpm build` -- full Next.js build passes
3. Zero `protectedProcedure` references remain in thread router and sidekiq router
4. All 14 procedures reference `workspaceProcedure`
5. All 14 procedures use `ctx.workspaceId` in their queries
6. Thread mutations retain `ctx.session.user.id` checks (ownership preserved)
7. Sidekiq mutations retain `ctx.session.user.id` checks (ownership preserved)
8. Sidekiq name uniqueness uses `workspaceId`, not `ownerId`
</verification>

<success_criteria>
- All 14 procedures across both routers use workspaceProcedure
- thread.list returns threads scoped to workspace (team members see all workspace threads)
- sidekiq.list returns sidekiqs scoped to workspace (team members see all workspace sidekiqs)
- Thread mutations enforce thread creator ownership (userId check remains)
- Sidekiq mutations enforce sidekiq creator ownership (ownerId check remains)
- New sidekiqs are created with workspaceId from ctx
- Sidekiq name uniqueness is per-workspace
- Full build passes
</success_criteria>

<output>
After completion, create `.planning/phases/11-workspace-authorization/11-02-SUMMARY.md`
</output>
