---
phase: 04-model-selection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/server/db/schema.ts
  - sidekiq-webapp/drizzle/schema.ts
  - sidekiq-webapp/src/lib/ai/models.ts
  - sidekiq-webapp/src/components/ui/command.tsx
  - sidekiq-webapp/src/components/ui/popover.tsx
  - sidekiq-webapp/src/components/ui/hover-card.tsx
autonomous: true

must_haves:
  truths:
    - "User preferences column exists in database"
    - "Model metadata includes description, features, and knowledge cutoff"
    - "shadcn Command, Popover, and HoverCard components are installed"
  artifacts:
    - path: "sidekiq-webapp/src/server/db/schema.ts"
      provides: "UserPreferences type and preferences JSONB column on user table"
      contains: "preferences.*jsonb"
    - path: "sidekiq-webapp/src/lib/ai/models.ts"
      provides: "Extended ModelConfig with description, features, knowledgeCutoff, and getProviders helper"
      contains: "description.*string"
    - path: "sidekiq-webapp/src/components/ui/command.tsx"
      provides: "shadcn Command component for picker UI"
      min_lines: 50
  key_links:
    - from: "sidekiq-webapp/src/server/db/schema.ts"
      to: "UserPreferences interface"
      via: "$type<UserPreferences>"
      pattern: "preferences.*UserPreferences"
    - from: "sidekiq-webapp/src/lib/ai/models.ts"
      to: "picker grouping"
      via: "getProviders function"
      pattern: "export function getProviders"
---

<objective>
Add database schema for user preferences and extend model configuration with rich metadata.

Purpose: Foundation for model picker to display model details and persist user favorites/default model. This is prerequisite infrastructure that the picker component and chat integration will build upon.

Output:
- User table has `preferences` JSONB column storing favorites and default model
- AVAILABLE_MODELS extended with description, features array, knowledgeCutoff
- getProviders() helper function for grouping models by provider in picker UI
- shadcn Command, Popover, HoverCard components installed for picker UI
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/agents/gsd-planner.md (for must_haves reference)
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-model-selection/04-CONTEXT.md
@.planning/phases/04-model-selection/04-RESEARCH.md

Key existing files:
@sidekiq-webapp/src/server/db/schema.ts (user table definition)
@sidekiq-webapp/src/lib/ai/models.ts (AVAILABLE_MODELS array)
@sidekiq-webapp/package.json (existing dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn components for model picker</name>
  <files>
    sidekiq-webapp/src/components/ui/command.tsx
    sidekiq-webapp/src/components/ui/popover.tsx
    sidekiq-webapp/src/components/ui/hover-card.tsx
    sidekiq-webapp/package.json
  </files>
  <action>
Run shadcn CLI to add Command, Popover, and HoverCard components:

```bash
cd sidekiq-webapp && pnpm dlx shadcn@latest add command popover hover-card
```

This installs:
- cmdk (underlying Command library)
- @radix-ui/react-popover
- @radix-ui/react-hover-card
- fuse.js (add manually if not included: `pnpm add fuse.js`)

Verify the components are created in `src/components/ui/`.
  </action>
  <verify>
- `sidekiq-webapp/src/components/ui/command.tsx` exists with Command exports
- `sidekiq-webapp/src/components/ui/popover.tsx` exists with Popover exports
- `sidekiq-webapp/src/components/ui/hover-card.tsx` exists with HoverCard exports
- `pnpm list cmdk fuse.js` shows both installed
  </verify>
  <done>shadcn components installed and fuse.js available for fuzzy search</done>
</task>

<task type="auto">
  <name>Task 2: Add user preferences JSONB column to schema</name>
  <files>
    sidekiq-webapp/src/server/db/schema.ts
    sidekiq-webapp/drizzle/schema.ts
  </files>
  <action>
Add UserPreferences interface and preferences column to user table:

1. Define the UserPreferences interface above the user table:
```typescript
/**
 * User preferences stored as JSONB.
 * Extensible structure for user-specific settings.
 */
export interface UserPreferences {
  /** User's default model for new threads */
  defaultModel?: string;
  /** Array of model IDs the user has favorited */
  favoriteModels?: string[];
  // Prepared for Phase 6/7: sidekiqDefaults?: Record<string, string>;
}
```

2. Add preferences column to user table (after `image` column):
```typescript
preferences: jsonb("preferences").$type<UserPreferences>().default({}),
```

3. Run `pnpm db:push` to apply schema changes (development mode push).

Note: The drizzle/schema.ts file is auto-generated and may need manual sync if it diverges from src/server/db/schema.ts. Check if they're the same file or if drizzle-kit generates from src.
  </action>
  <verify>
- `grep -n "UserPreferences" sidekiq-webapp/src/server/db/schema.ts` shows interface definition
- `grep -n "preferences.*jsonb" sidekiq-webapp/src/server/db/schema.ts` shows column
- `cd sidekiq-webapp && pnpm db:push` completes without errors
  </verify>
  <done>User table has preferences JSONB column with TypeScript type</done>
</task>

<task type="auto">
  <name>Task 3: Extend model configuration with rich metadata</name>
  <files>sidekiq-webapp/src/lib/ai/models.ts</files>
  <action>
Extend ModelConfig interface and AVAILABLE_MODELS with:

1. Update ModelConfig interface:
```typescript
/**
 * Feature tags for model capabilities.
 */
export type ModelFeature = "fast" | "thinking" | "coding" | "vision" | "long-context";

/**
 * Configuration for a single AI model.
 */
export interface ModelConfig {
  /** Model identifier in format: provider/model-name */
  id: string;
  /** Human-readable display name */
  name: string;
  /** Provider (openai, anthropic, google) */
  provider: Provider;
  /** Cost indicator ($/$$/$$$) */
  pricingTier: PricingTier;
  /** Speed/quality tradeoff indicator */
  speedTier: SpeedTier;
  /** Short description of the model's strengths */
  description: string;
  /** Feature capabilities */
  features: ModelFeature[];
  /** Knowledge cutoff date (e.g., "Apr 2024") */
  knowledgeCutoff: string;
}
```

2. Update AVAILABLE_MODELS array with metadata for each model:

OpenAI models:
- GPT-4o Mini: "Fast and cost-effective for everyday tasks", ["fast"], "Oct 2023"
- GPT-4o: "Balanced performance for complex reasoning", ["coding", "vision"], "Oct 2023"
- o1: "Advanced reasoning with chain-of-thought", ["thinking", "coding"], "Oct 2023"

Anthropic models:
- Claude 3.5 Haiku: "Lightning fast responses for quick tasks", ["fast"], "Apr 2024"
- Claude Sonnet 4: "Excellent balance of speed and intelligence", ["coding", "thinking"], "Apr 2025"
- Claude Opus 4: "Most capable model for complex analysis", ["thinking", "coding", "long-context"], "Apr 2025"

Google models:
- Gemini 2.0 Flash: "Ultra-fast multimodal responses", ["fast", "vision"], "Aug 2024"
- Gemini 2.5 Pro: "Advanced reasoning with huge context window", ["thinking", "long-context", "vision"], "Jan 2025"

3. Add getProviders helper function (REQUIRED - Plan 04-02 depends on this):
```typescript
/**
 * Get unique providers from available models.
 * Useful for grouping models by provider in picker UI.
 */
export function getProviders(): Provider[] {
  return [...new Set(AVAILABLE_MODELS.map(m => m.provider))];
}
```

This function is used by model-picker-content.tsx to group models by provider.
  </action>
  <verify>
- `grep -n "description.*string" sidekiq-webapp/src/lib/ai/models.ts` shows field in interface
- `grep -n "features.*ModelFeature" sidekiq-webapp/src/lib/ai/models.ts` shows features field
- `grep -n "knowledgeCutoff" sidekiq-webapp/src/lib/ai/models.ts` shows cutoff field
- `grep -n "export function getProviders" sidekiq-webapp/src/lib/ai/models.ts` shows helper function
- `cd sidekiq-webapp && pnpm typecheck` passes
  </verify>
  <done>All models have description, features array, knowledge cutoff date, and getProviders helper is exported</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd sidekiq-webapp && pnpm typecheck` - No type errors
2. `cd sidekiq-webapp && pnpm lint` - No lint errors
3. `pnpm list cmdk fuse.js @radix-ui/react-popover @radix-ui/react-hover-card` - All deps installed
4. Database has preferences column (check via drizzle studio or direct query)
</verification>

<success_criteria>
- UserPreferences interface defined with defaultModel and favoriteModels fields
- User table has preferences JSONB column
- ModelConfig includes description, features, and knowledgeCutoff
- All 8 models have rich metadata populated
- getProviders() function exported for picker grouping
- shadcn Command, Popover, HoverCard components installed
- fuse.js installed for fuzzy search
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-model-selection/04-01-SUMMARY.md`
</output>
