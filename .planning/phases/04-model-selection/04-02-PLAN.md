---
phase: 04-model-selection
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - sidekiq-webapp/src/components/model-picker/model-picker.tsx
  - sidekiq-webapp/src/components/model-picker/model-picker-trigger.tsx
  - sidekiq-webapp/src/components/model-picker/model-picker-content.tsx
  - sidekiq-webapp/src/components/model-picker/model-item.tsx
  - sidekiq-webapp/src/components/model-picker/model-hover-card.tsx
  - sidekiq-webapp/src/components/model-picker/index.ts
  - sidekiq-webapp/src/components/icons/provider-icons.tsx
autonomous: true

must_haves:
  truths:
    - "User sees a model picker with search input"
    - "User can search models with typo tolerance"
    - "Models are grouped by provider"
    - "Favorites section appears at top when user has favorites"
    - "Hovering a model shows detail card with description, features, cutoff"
  artifacts:
    - path: "sidekiq-webapp/src/components/model-picker/model-picker.tsx"
      provides: "Main ModelPicker component with state management"
      exports: ["ModelPicker"]
      min_lines: 40
    - path: "sidekiq-webapp/src/components/model-picker/model-picker-content.tsx"
      provides: "Popover content with Command menu, search, groups"
      contains: "Fuse"
    - path: "sidekiq-webapp/src/components/model-picker/model-hover-card.tsx"
      provides: "Model detail hover card"
      contains: "HoverCard"
    - path: "sidekiq-webapp/src/components/icons/provider-icons.tsx"
      provides: "Provider logo SVG components"
      exports: ["ProviderIcon"]
  key_links:
    - from: "model-picker-content.tsx"
      to: "fuse.js"
      via: "Fuse instance for search"
      pattern: "new Fuse"
    - from: "model-item.tsx"
      to: "model-hover-card.tsx"
      via: "HoverCard wrapper"
      pattern: "HoverCard\\.Root"
    - from: "model-item.tsx"
      to: "@sidekiq/components/ui/tooltip"
      via: "Tooltip import for favorite button"
      pattern: "import.*Tooltip.*from.*tooltip"
    - from: "model-picker.tsx"
      to: "@sidekiq/lib/ai/models"
      via: "AVAILABLE_MODELS import"
      pattern: "AVAILABLE_MODELS"
---

<objective>
Build the rich model picker component with fuzzy search, provider grouping, favorites section, and hover cards.

Purpose: Create the primary UI for model selection following t3.chat design patterns. This is the visual centerpiece of Phase 4 - users interact with this to choose their LLM.

Output:
- ModelPicker component with Popover + Command pattern
- Fuzzy search with Fuse.js (typo-tolerant)
- Models grouped by provider (OpenAI, Anthropic, Google)
- Favorites section pinned at top when user has favorites
- HoverCard showing model details on hover
- Provider icon SVGs for visual identification
</objective>

<execution_context>
@~/.claude/agents/gsd-executor.md
@~/.claude/agents/gsd-planner.md (for must_haves reference)
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-model-selection/04-CONTEXT.md
@.planning/phases/04-model-selection/04-RESEARCH.md
@.planning/phases/04-model-selection/04-01-SUMMARY.md

Key files from Plan 01:
@sidekiq-webapp/src/lib/ai/models.ts (extended ModelConfig)
@sidekiq-webapp/src/components/ui/command.tsx (shadcn Command)
@sidekiq-webapp/src/components/ui/popover.tsx (shadcn Popover)
@sidekiq-webapp/src/components/ui/hover-card.tsx (shadcn HoverCard)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider icon SVG components</name>
  <files>sidekiq-webapp/src/components/icons/provider-icons.tsx</files>
  <action>
Create provider icon components for the model picker. Use simple, recognizable logos.

```typescript
"use client";

import type { Provider } from "@sidekiq/lib/ai/models";
import { cn } from "@sidekiq/lib/utils";

interface ProviderIconProps {
  provider: Provider;
  className?: string;
}

/**
 * Provider logo icons for model picker.
 * Simple SVG components sized for inline display.
 */
export function ProviderIcon({ provider, className }: ProviderIconProps) {
  const baseClass = cn("h-4 w-4 shrink-0", className);

  switch (provider) {
    case "openai":
      return (
        <svg className={baseClass} viewBox="0 0 24 24" fill="currentColor">
          {/* OpenAI logo - simplified */}
          <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.8956zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
        </svg>
      );
    case "anthropic":
      return (
        <svg className={baseClass} viewBox="0 0 24 24" fill="currentColor">
          {/* Anthropic logo - simplified A shape */}
          <path d="M17.304 3.541h-3.672l6.696 16.918h3.672L17.304 3.541zm-10.608 0L0 20.459h3.744l1.38-3.636h7.128l1.392 3.636h3.744L10.692 3.541H6.696zm.456 10.8l2.544-6.7 2.544 6.7H7.152z" />
        </svg>
      );
    case "google":
      return (
        <svg className={baseClass} viewBox="0 0 24 24" fill="currentColor">
          {/* Google/Gemini logo - simplified star */}
          <path d="M12 0C5.372 0 0 5.372 0 12s5.372 12 12 12 12-5.372 12-12S18.628 0 12 0zm0 3.6c4.638 0 8.4 3.762 8.4 8.4 0 4.638-3.762 8.4-8.4 8.4-4.638 0-8.4-3.762-8.4-8.4 0-4.638 3.762-8.4 8.4-8.4zm0 2.4a6 6 0 1 0 0 12 6 6 0 0 0 0-12z" />
        </svg>
      );
    default:
      return null;
  }
}

/**
 * Get display name for a provider.
 */
export function getProviderDisplayName(provider: Provider): string {
  switch (provider) {
    case "openai":
      return "OpenAI";
    case "anthropic":
      return "Anthropic";
    case "google":
      return "Google";
    default:
      return provider;
  }
}
```

Create the icons directory if it doesn't exist.
  </action>
  <verify>
- File exists: `ls sidekiq-webapp/src/components/icons/provider-icons.tsx`
- Exports ProviderIcon: `grep -n "export function ProviderIcon" sidekiq-webapp/src/components/icons/provider-icons.tsx`
- TypeScript compiles: `cd sidekiq-webapp && pnpm typecheck`
  </verify>
  <done>Provider icon SVG components created for OpenAI, Anthropic, Google</done>
</task>

<task type="auto">
  <name>Task 2: Create core model picker components</name>
  <files>
    sidekiq-webapp/src/components/model-picker/model-picker.tsx
    sidekiq-webapp/src/components/model-picker/model-picker-trigger.tsx
    sidekiq-webapp/src/components/model-picker/model-picker-content.tsx
    sidekiq-webapp/src/components/model-picker/index.ts
  </files>
  <action>
Create the main model picker component suite (core files only).

**1. model-picker/index.ts** - Barrel export:
```typescript
export { ModelPicker } from "./model-picker";
export type { ModelPickerProps } from "./model-picker";
```

**2. model-picker/model-picker-trigger.tsx** - Compact button trigger:
```typescript
"use client";

import { ChevronDown } from "lucide-react";
import { forwardRef } from "react";

import { Button } from "@sidekiq/components/ui/button";
import { ProviderIcon } from "@sidekiq/components/icons/provider-icons";
import type { ModelConfig } from "@sidekiq/lib/ai/models";
import { cn } from "@sidekiq/lib/utils";

interface ModelPickerTriggerProps {
  selectedModel: ModelConfig | undefined;
  disabled?: boolean;
  className?: string;
}

export const ModelPickerTrigger = forwardRef<HTMLButtonElement, ModelPickerTriggerProps>(
  ({ selectedModel, disabled, className }, ref) => {
    return (
      <Button
        ref={ref}
        variant="outline"
        size="sm"
        disabled={disabled}
        className={cn(
          "h-8 gap-2 px-3",
          "bg-background/50 hover:bg-background/80",
          "border-border/50",
          className
        )}
      >
        {selectedModel && (
          <ProviderIcon provider={selectedModel.provider} className="h-3.5 w-3.5" />
        )}
        <span className="text-sm font-medium">
          {selectedModel?.name ?? "Select model"}
        </span>
        <ChevronDown className="h-3.5 w-3.5 opacity-50" />
      </Button>
    );
  }
);
ModelPickerTrigger.displayName = "ModelPickerTrigger";
```

**3. model-picker/model-picker-content.tsx** - Popover content with search:
```typescript
"use client";

import { useMemo, useState } from "react";
import Fuse from "fuse.js";
import {
  Command,
  CommandEmpty,
  CommandGroup,
  CommandInput,
  CommandList,
} from "@sidekiq/components/ui/command";
import { AVAILABLE_MODELS, getProviders, type ModelConfig } from "@sidekiq/lib/ai/models";
import { getProviderDisplayName } from "@sidekiq/components/icons/provider-icons";
import { ModelItem } from "./model-item";

interface ModelPickerContentProps {
  selectedModelId: string;
  favoriteModelIds: string[];
  defaultModelId: string | undefined;
  onSelect: (modelId: string) => void;
  onToggleFavorite: (modelId: string) => void;
}

export function ModelPickerContent({
  selectedModelId,
  favoriteModelIds,
  defaultModelId,
  onSelect,
  onToggleFavorite,
}: ModelPickerContentProps) {
  const [search, setSearch] = useState("");

  // Fuse.js instance for fuzzy search
  const fuse = useMemo(
    () =>
      new Fuse(AVAILABLE_MODELS, {
        keys: [
          { name: "name", weight: 2 },
          { name: "provider", weight: 1 },
          { name: "description", weight: 0.5 },
        ],
        threshold: 0.4, // Allow typos
        ignoreLocation: true,
      }),
    []
  );

  // Filter models based on search
  const filteredModels = useMemo(() => {
    if (!search.trim()) return AVAILABLE_MODELS;
    return fuse.search(search).map((result) => result.item);
  }, [fuse, search]);

  // Get favorite models
  const favoriteModels = useMemo(
    () => AVAILABLE_MODELS.filter((m) => favoriteModelIds.includes(m.id)),
    [favoriteModelIds]
  );

  // Group filtered models by provider
  const providers = getProviders();
  const modelsByProvider = useMemo(() => {
    const grouped: Record<string, ModelConfig[]> = {};
    for (const provider of providers) {
      const models = filteredModels.filter((m) => m.provider === provider);
      if (models.length > 0) {
        grouped[provider] = models;
      }
    }
    return grouped;
  }, [filteredModels, providers]);

  const renderModelItem = (model: ModelConfig) => (
    <ModelItem
      key={model.id}
      model={model}
      isSelected={selectedModelId === model.id}
      isFavorite={favoriteModelIds.includes(model.id)}
      isDefault={defaultModelId === model.id}
      onSelect={onSelect}
      onToggleFavorite={onToggleFavorite}
    />
  );

  return (
    <Command shouldFilter={false} className="rounded-lg">
      <CommandInput
        placeholder="Search models..."
        value={search}
        onValueChange={setSearch}
      />
      <CommandList className="max-h-[300px]">
        <CommandEmpty>No models found.</CommandEmpty>

        {/* Favorites section - only show if user has favorites and not searching */}
        {favoriteModels.length > 0 && !search.trim() && (
          <CommandGroup heading="Favorites">
            {favoriteModels.map(renderModelItem)}
          </CommandGroup>
        )}

        {/* Models grouped by provider */}
        {Object.entries(modelsByProvider).map(([provider, models]) => (
          <CommandGroup key={provider} heading={getProviderDisplayName(provider as any)}>
            {models.map(renderModelItem)}
          </CommandGroup>
        ))}
      </CommandList>
    </Command>
  );
}
```

**4. model-picker/model-picker.tsx** - Main component:
```typescript
"use client";

import { useState } from "react";
import { Popover, PopoverContent, PopoverTrigger } from "@sidekiq/components/ui/popover";
import { TooltipProvider } from "@sidekiq/components/ui/tooltip";
import { AVAILABLE_MODELS, getModelConfig } from "@sidekiq/lib/ai/models";
import { ModelPickerTrigger } from "./model-picker-trigger";
import { ModelPickerContent } from "./model-picker-content";

export interface ModelPickerProps {
  /** Currently selected model ID */
  value: string;
  /** Callback when model selection changes */
  onValueChange: (modelId: string) => void;
  /** User's favorite model IDs */
  favoriteModelIds?: string[];
  /** User's default model ID */
  defaultModelId?: string;
  /** Callback when user toggles a favorite */
  onToggleFavorite?: (modelId: string) => void;
  /** Whether the picker is disabled (e.g., during streaming) */
  disabled?: boolean;
  /** Additional class name for the trigger */
  className?: string;
}

/**
 * Rich model selection picker with fuzzy search, favorites, and provider grouping.
 *
 * Features:
 * - Fuzzy search with typo tolerance (Fuse.js)
 * - Favorites section pinned at top
 * - Models grouped by provider
 * - Hover card with model details
 * - Keyboard navigation (via cmdk)
 */
export function ModelPicker({
  value,
  onValueChange,
  favoriteModelIds = [],
  defaultModelId,
  onToggleFavorite,
  disabled = false,
  className,
}: ModelPickerProps) {
  const [open, setOpen] = useState(false);
  const selectedModel = getModelConfig(value);

  const handleSelect = (modelId: string) => {
    onValueChange(modelId);
    setOpen(false);
  };

  const handleToggleFavorite = (modelId: string) => {
    onToggleFavorite?.(modelId);
  };

  return (
    <TooltipProvider>
      <Popover open={open} onOpenChange={setOpen}>
        <PopoverTrigger asChild>
          <ModelPickerTrigger
            selectedModel={selectedModel}
            disabled={disabled}
            className={className}
          />
        </PopoverTrigger>
        <PopoverContent
          align="end"
          sideOffset={4}
          className="w-[320px] p-0 bg-popover border-border"
        >
          <ModelPickerContent
            selectedModelId={value}
            favoriteModelIds={favoriteModelIds}
            defaultModelId={defaultModelId}
            onSelect={handleSelect}
            onToggleFavorite={handleToggleFavorite}
          />
        </PopoverContent>
      </Popover>
    </TooltipProvider>
  );
}
```

Create the model-picker directory if it doesn't exist.
  </action>
  <verify>
- Core files exist: `ls sidekiq-webapp/src/components/model-picker/model-picker.tsx sidekiq-webapp/src/components/model-picker/model-picker-content.tsx`
- ModelPicker exported: `grep -n "export.*ModelPicker" sidekiq-webapp/src/components/model-picker/index.ts`
- Fuse.js used: `grep -n "new Fuse" sidekiq-webapp/src/components/model-picker/model-picker-content.tsx`
- TypeScript compiles: `cd sidekiq-webapp && pnpm typecheck`
  </verify>
  <done>Core model picker components created (picker, trigger, content, barrel export)</done>
</task>

<task type="auto">
  <name>Task 3: Create model item and hover card components</name>
  <files>
    sidekiq-webapp/src/components/model-picker/model-item.tsx
    sidekiq-webapp/src/components/model-picker/model-hover-card.tsx
  </files>
  <action>
Create the model item row and hover card detail components.

**1. model-picker/model-hover-card.tsx** - Detail card on hover:
```typescript
"use client";

import type { ReactNode } from "react";
import { Badge } from "@sidekiq/components/ui/badge";
import {
  HoverCard,
  HoverCardContent,
  HoverCardTrigger,
} from "@sidekiq/components/ui/hover-card";
import { ProviderIcon, getProviderDisplayName } from "@sidekiq/components/icons/provider-icons";
import type { ModelConfig, ModelFeature } from "@sidekiq/lib/ai/models";

interface ModelHoverCardProps {
  model: ModelConfig;
  children: ReactNode;
}

const featureLabels: Record<ModelFeature, string> = {
  fast: "Fast",
  thinking: "Deep Thinking",
  coding: "Coding",
  vision: "Vision",
  "long-context": "Long Context",
};

export function ModelHoverCard({ model, children }: ModelHoverCardProps) {
  return (
    <HoverCard openDelay={400} closeDelay={100}>
      <HoverCardTrigger asChild>{children}</HoverCardTrigger>
      <HoverCardContent side="right" sideOffset={8} className="w-72">
        <div className="space-y-3">
          <div className="flex items-start gap-3">
            <ProviderIcon provider={model.provider} className="mt-0.5 h-5 w-5" />
            <div className="space-y-1">
              <h4 className="text-sm font-semibold">{model.name}</h4>
              <p className="text-muted-foreground text-xs">
                {getProviderDisplayName(model.provider)}
              </p>
            </div>
          </div>
          <p className="text-muted-foreground text-sm">{model.description}</p>
          <div className="flex flex-wrap gap-1.5">
            {model.features.map((feature) => (
              <Badge key={feature} variant="secondary" className="text-xs">
                {featureLabels[feature]}
              </Badge>
            ))}
          </div>
          <p className="text-muted-foreground text-xs">
            Knowledge cutoff: {model.knowledgeCutoff}
          </p>
        </div>
      </HoverCardContent>
    </HoverCard>
  );
}
```

**2. model-picker/model-item.tsx** - Individual model row:

IMPORTANT: Must import Tooltip components for the favorite button tooltip.

```typescript
"use client";

import { Check, Star } from "lucide-react";
import { CommandItem } from "@sidekiq/components/ui/command";
import { ProviderIcon } from "@sidekiq/components/icons/provider-icons";
import type { ModelConfig, ModelFeature } from "@sidekiq/lib/ai/models";
import { ModelHoverCard } from "./model-hover-card";
import { cn } from "@sidekiq/lib/utils";
// CRITICAL: Import Tooltip components for favorite button
import { Tooltip, TooltipContent, TooltipTrigger } from "@sidekiq/components/ui/tooltip";

interface ModelItemProps {
  model: ModelConfig;
  isSelected: boolean;
  isFavorite: boolean;
  isDefault: boolean;
  onSelect: (modelId: string) => void;
  onToggleFavorite: (modelId: string) => void;
}

const featureIcons: Partial<Record<ModelFeature, string>> = {
  fast: "Zap",
  thinking: "Brain",
  coding: "Code",
};

export function ModelItem({
  model,
  isSelected,
  isFavorite,
  isDefault,
  onSelect,
  onToggleFavorite,
}: ModelItemProps) {
  return (
    <ModelHoverCard model={model}>
      <CommandItem
        value={model.id}
        onSelect={() => onSelect(model.id)}
        className="flex items-center gap-3 py-2.5"
      >
        <ProviderIcon provider={model.provider} className="h-4 w-4 shrink-0" />
        <div className="flex-1 min-w-0">
          <div className="flex items-center gap-2">
            <span className="font-medium truncate">{model.name}</span>
            {isDefault && (
              <span className="text-muted-foreground text-[10px] uppercase tracking-wide">
                default
              </span>
            )}
          </div>
          <p className="text-muted-foreground text-xs truncate">{model.description}</p>
        </div>
        <div className="flex items-center gap-1 shrink-0">
          <Tooltip>
            <TooltipTrigger asChild>
              <button
                type="button"
                onClick={(e) => {
                  e.stopPropagation();
                  onToggleFavorite(model.id);
                }}
                className={cn(
                  "p-1 rounded hover:bg-accent",
                  isFavorite ? "text-yellow-500" : "text-muted-foreground/50 hover:text-muted-foreground"
                )}
              >
                <Star className={cn("h-3.5 w-3.5", isFavorite && "fill-current")} />
              </button>
            </TooltipTrigger>
            <TooltipContent side="left">
              {isFavorite ? "Remove from favorites" : "Add to favorites"}
            </TooltipContent>
          </Tooltip>
          {isSelected && <Check className="h-4 w-4 text-primary" />}
        </div>
      </CommandItem>
    </ModelHoverCard>
  );
}
```
  </action>
  <verify>
- Files exist: `ls sidekiq-webapp/src/components/model-picker/model-item.tsx sidekiq-webapp/src/components/model-picker/model-hover-card.tsx`
- HoverCard used: `grep -n "HoverCard" sidekiq-webapp/src/components/model-picker/model-hover-card.tsx`
- Tooltip imported in model-item: `grep -n "import.*Tooltip.*from.*tooltip" sidekiq-webapp/src/components/model-picker/model-item.tsx`
- TypeScript compiles: `cd sidekiq-webapp && pnpm typecheck`
  </verify>
  <done>Model item and hover card components created with proper Tooltip imports</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd sidekiq-webapp && pnpm typecheck` - No type errors
2. `cd sidekiq-webapp && pnpm lint` - No lint errors
3. `cd sidekiq-webapp && pnpm build` - Build succeeds (components are tree-shakeable)
4. Model picker components export correctly from barrel file
</verification>

<success_criteria>
- ModelPicker component renders with Popover + Command pattern
- Fuzzy search finds models even with typos (e.g., "clade" finds "Claude")
- Models grouped by provider (OpenAI, Anthropic, Google sections)
- Favorites section appears when favoriteModelIds has items
- HoverCard shows on model hover with description, features, knowledge cutoff
- Star icon toggles favorite state
- Check icon shows for selected model
- "default" label shows next to user's default model
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-model-selection/04-02-SUMMARY.md`
</output>
