---
phase: 07-sidekiq-chat-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/app/(dashboard)/chat/page.tsx
  - sidekiq-webapp/src/components/chat/chat-interface.tsx
  - sidekiq-webapp/src/components/chat/empty-state.tsx
autonomous: true

must_haves:
  truths:
    - "Chat page accepts sidekiq query parameter and fetches Sidekiq data"
    - "ChatInterface receives Sidekiq context as prop"
    - "Empty state shows Sidekiq conversation starters when Sidekiq is active"
  artifacts:
    - path: "sidekiq-webapp/src/app/(dashboard)/chat/page.tsx"
      provides: "Server-side Sidekiq data fetching from URL param"
      contains: "searchParams"
    - path: "sidekiq-webapp/src/components/chat/chat-interface.tsx"
      provides: "Sidekiq prop handling and transport body extension"
      contains: "sidekiq?: {"
    - path: "sidekiq-webapp/src/components/chat/empty-state.tsx"
      provides: "Conditional conversation starters"
      contains: "conversationStarters"
  key_links:
    - from: "sidekiq-webapp/src/app/(dashboard)/chat/page.tsx"
      to: "sidekiq-webapp/src/components/chat/chat-interface.tsx"
      via: "sidekiq prop"
      pattern: "sidekiq=\\{sidekiq\\}"
---

<objective>
Chat page Sidekiq integration - URL parameter handling and empty state.

Purpose: Enable starting Sidekiq chats via /chat?sidekiq={id} URL, pass Sidekiq context to ChatInterface, and show Sidekiq conversation starters in empty state.
Output: Modified chat page with Sidekiq lookup, extended ChatInterface props, and conditional empty state prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidekiq-chat-integration/07-RESEARCH.md
@sidekiq-webapp/src/app/(dashboard)/chat/page.tsx
@sidekiq-webapp/src/components/chat/chat-interface.tsx
@sidekiq-webapp/src/components/chat/empty-state.tsx
@sidekiq-webapp/src/server/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend chat page to accept sidekiq query parameter</name>
  <files>sidekiq-webapp/src/app/(dashboard)/chat/page.tsx</files>
  <action>
Modify NewChatPage to accept and process sidekiq query parameter:

1. Add searchParams prop to page component (Next.js 15 async params):
   ```typescript
   interface NewChatPageProps {
     searchParams: Promise<{ sidekiq?: string }>;
   }
   ```

2. Import necessary modules:
   - db from "@sidekiq/server/db"
   - sidekiqs from "@sidekiq/server/db/schema"
   - eq from "drizzle-orm"

3. Extract sidekiqId from searchParams:
   ```typescript
   const { sidekiq: sidekiqId } = await searchParams;
   ```

4. Fetch Sidekiq data if sidekiqId is provided:
   ```typescript
   const sidekiq = sidekiqId
     ? await db.query.sidekiqs.findFirst({
         where: and(
           eq(sidekiqs.id, sidekiqId),
           eq(sidekiqs.ownerId, session.user.id) // Ownership check
         ),
         columns: {
           id: true,
           name: true,
           description: true,
           avatar: true,
           conversationStarters: true,
           defaultModel: true,
         },
       })
     : null;
   ```

5. Pass sidekiq to ChatInterface:
   ```typescript
   return <ChatInterface threadId={null} sidekiq={sidekiq} />;
   ```

NOTE: If sidekiqId is invalid or doesn't belong to user, sidekiq will be null and chat proceeds as normal (no error, just no Sidekiq context).
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify types are correct</verify>
  <done>Chat page fetches Sidekiq data from URL param and passes to ChatInterface</done>
</task>

<task type="auto">
  <name>Task 2: Extend ChatInterface to accept Sidekiq prop</name>
  <files>sidekiq-webapp/src/components/chat/chat-interface.tsx</files>
  <action>
Extend ChatInterface to handle Sidekiq context:

1. Import SidekiqAvatar type from schema:
   ```typescript
   import type { SidekiqAvatar } from "@sidekiq/server/db/schema";
   ```

2. Add sidekiq to ChatInterfaceProps:
   ```typescript
   interface ChatInterfaceProps {
     threadId: string | null;
     initialMessages?: UIMessage[];
     initialTitle?: string | null;
     initialModel?: string | null;
     /** Optional Sidekiq context for new chats started with a Sidekiq */
     sidekiq?: {
       id: string;
       name: string;
       description: string | null;
       avatar: SidekiqAvatar;
       conversationStarters: string[];
       defaultModel: string | null;
     } | null;
   }
   ```

3. Destructure sidekiq from props

4. Modify DefaultChatTransport body to include sidekiqId for new threads:
   ```typescript
   const transport = new DefaultChatTransport({
     api: "/api/chat",
     body: threadId
       ? { threadId }
       : sidekiq
         ? { sidekiqId: sidekiq.id }
         : {},
     fetch: customFetch,
   });
   ```

5. If sidekiq has defaultModel and no threadId (new chat), use it as initial model:
   - Modify useModelSelection to accept sidekiqDefaultModel prop
   - OR set selectedModel state initial value based on sidekiq.defaultModel

6. Pass sidekiq to EmptyState in MessageList (will be wired in Task 3):
   - Thread this through to where EmptyState is rendered
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify prop types</verify>
  <done>ChatInterface accepts sidekiq prop and includes sidekiqId in transport body</done>
</task>

<task type="auto">
  <name>Task 3: Modify EmptyState to show Sidekiq conversation starters</name>
  <files>sidekiq-webapp/src/components/chat/empty-state.tsx</files>
  <action>
Extend EmptyState to show Sidekiq conversation starters when provided:

1. Add optional conversationStarters prop:
   ```typescript
   interface EmptyStateProps {
     onPromptSelect: (prompt: string) => void;
     /** Custom conversation starters from Sidekiq (replaces default categories) */
     conversationStarters?: string[];
     /** Sidekiq name to display in welcome message */
     sidekiqName?: string;
   }
   ```

2. Conditionally render Sidekiq starters OR default categories:
   ```typescript
   if (conversationStarters && conversationStarters.length > 0) {
     // Render simple list of Sidekiq starters
     return (
       <div className="flex h-full flex-col items-center justify-center p-8">
         <div className="mb-8 text-center">
           <h2 className="text-foreground text-2xl font-semibold">
             Chat with {sidekiqName ?? 'Sidekiq'}
           </h2>
           <p className="text-muted-foreground mt-2">
             Choose a starter or type your own message
           </p>
         </div>
         <div className="grid w-full max-w-xl grid-cols-1 gap-3">
           {conversationStarters.map((starter, i) => (
             <button
               key={i}
               onClick={() => onPromptSelect(starter)}
               className={cn(
                 "w-full rounded-lg p-4 text-left text-sm",
                 "glass-subtle",
                 "text-foreground/80 hover:text-foreground",
                 "hover:bg-white/60 dark:hover:bg-zinc-800/60",
                 "transition-colors duration-200",
                 "focus-visible:ring-ring focus-visible:ring-2 focus-visible:outline-none",
               )}
             >
               {starter}
             </button>
           ))}
         </div>
       </div>
     );
   }
   // Otherwise render default PROMPT_CATEGORIES...
   ```

3. Wire the props from ChatInterface through MessageList to EmptyState:
   - MessageList needs to receive and forward these props
   - Check where EmptyState is rendered and pass the props
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Manually verify EmptyState renders custom starters when provided
  </verify>
  <done>EmptyState shows Sidekiq conversation starters when sidekiq context is provided</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm tsc --noEmit`
2. Navigation to /chat?sidekiq={validId} loads Sidekiq context
3. Empty state shows Sidekiq conversation starters
4. First message sends sidekiqId to API
</verification>

<success_criteria>
- /chat?sidekiq={id} URL loads Sidekiq data server-side
- ChatInterface receives and uses Sidekiq context
- EmptyState displays Sidekiq conversation starters when available
- sidekiqId is included in chat transport body for new threads
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidekiq-chat-integration/07-02-SUMMARY.md`
</output>
