---
phase: 07-sidekiq-chat-integration
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/server/db/schema.ts
  - sidekiq-webapp/src/server/api/routers/sidekiq.ts
  - sidekiq-webapp/src/components/thread/thread-item.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "When a Sidekiq is deleted, threads that used it retain the Sidekiq name"
    - "Thread item shows '?' avatar and '[Sidekiq deleted]' subtitle for deleted Sidekiq"
    - "Normal threads (never had Sidekiq) still display correctly without deleted indicator"
  artifacts:
    - path: "sidekiq-webapp/src/server/db/schema.ts"
      provides: "deletedSidekiqName column on threads table"
      contains: "deletedSidekiqName"
    - path: "sidekiq-webapp/src/server/api/routers/sidekiq.ts"
      provides: "Save Sidekiq name to threads before deletion"
      contains: "deletedSidekiqName"
    - path: "sidekiq-webapp/src/components/thread/thread-item.tsx"
      provides: "UI logic checking deletedSidekiqName field"
      contains: "deletedSidekiqName"
  key_links:
    - from: "sidekiq.ts delete mutation"
      to: "threads table"
      via: "UPDATE threads SET deletedSidekiqName"
      pattern: "deletedSidekiqName.*sidekiq\\.name"
    - from: "thread-item.tsx"
      to: "deletedSidekiqName field"
      via: "conditional rendering"
      pattern: "thread\\.deletedSidekiqName"
---

<objective>
Fix deleted Sidekiq display in thread list

**Problem:** When a Sidekiq is deleted, the FK constraint `ON DELETE SET NULL` clears `sidekiqId` from threads. The existing UI logic `thread.sidekiqId && !thread.sidekiq` never executes because `sidekiqId` becomes null.

**Solution:** Add `deletedSidekiqName` nullable field to threads. When a Sidekiq is deleted, store its name in all threads that reference it before deletion. Update UI to check this field.

Purpose: Provide graceful degradation for threads whose Sidekiq was deleted
Output: Working deleted Sidekiq indicator in thread list
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@sidekiq-webapp/src/server/db/schema.ts
@sidekiq-webapp/src/server/api/routers/sidekiq.ts
@sidekiq-webapp/src/components/thread/thread-item.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add deletedSidekiqName column to threads schema</name>
  <files>sidekiq-webapp/src/server/db/schema.ts</files>
  <action>
Add a nullable `deletedSidekiqName` varchar field to the threads table schema:

1. In the `threads` table definition (around line 239), add:
   ```typescript
   deletedSidekiqName: varchar("deleted_sidekiq_name", { length: 100 }),
   ```
   Add it after `sidekiqId` field for logical grouping.

2. This field stores the name of a deleted Sidekiq so the UI can display "[Sidekiq deleted]" with context.

3. Run `pnpm db:generate` to create the migration file, then `pnpm db:push` to apply it.

Note: The FK `onDelete: 'set null'` on `sidekiqId` remains unchanged - this is the safer approach that avoids risky migration.
  </action>
  <verify>
1. `pnpm db:generate` creates migration file without errors
2. `pnpm db:push` applies migration successfully (output shows "Changes applied")
  </verify>
  <done>deletedSidekiqName column exists in threads schema and database</done>
</task>

<task type="auto">
  <name>Task 2: Update sidekiq.delete mutation to preserve name</name>
  <files>sidekiq-webapp/src/server/api/routers/sidekiq.ts</files>
  <action>
Modify the `delete` mutation to store the Sidekiq name in associated threads before deletion:

1. Before the existing delete logic (around line 246), add:
   ```typescript
   // Fetch the sidekiq name before deletion
   const sidekiqToDelete = await ctx.db.query.sidekiqs.findFirst({
     where: and(
       eq(sidekiqs.id, id),
       eq(sidekiqs.ownerId, ctx.session.user.id),
     ),
     columns: { name: true },
   });

   if (!sidekiqToDelete) {
     throw new TRPCError({
       code: "NOT_FOUND",
       message: "Sidekiq not found",
     });
   }

   // Store the sidekiq name in threads before deletion (unless deleting threads)
   if (!deleteThreads) {
     await ctx.db
       .update(threads)
       .set({ deletedSidekiqName: sidekiqToDelete.name })
       .where(eq(threads.sidekiqId, id));
   }
   ```

2. Remove the redundant NOT_FOUND check AFTER the delete query (lines 268-273):
   ```typescript
   // DELETE these lines:
   if (!deleted) {
     throw new TRPCError({
       code: "NOT_FOUND",
       message: "Sidekiq not found",
     });
   }
   ```
   This check is now redundant because we validate ownership before the delete query.

3. The cascade delete threads path (`if (deleteThreads)`) remains unchanged since those threads are deleted anyway.
  </action>
  <verify>
1. TypeScript compiles without errors: `pnpm typecheck`
2. Manual test: Create a Sidekiq, start a thread with it, delete the Sidekiq (without deleting threads)
3. Query database: `SELECT deleted_sidekiq_name FROM thread WHERE deleted_sidekiq_name IS NOT NULL` shows the preserved name
  </verify>
  <done>Sidekiq deletion stores name in threads.deletedSidekiqName before removing the Sidekiq</done>
</task>

<task type="auto">
  <name>Task 3: Update thread-item.tsx UI logic</name>
  <files>sidekiq-webapp/src/components/thread/thread-item.tsx</files>
  <action>
Update the Thread interface and rendering logic to use `deletedSidekiqName`:

1. Update the Thread interface (around line 22) to add:
   ```typescript
   /** Preserved name if the Sidekiq was deleted */
   deletedSidekiqName?: string | null;
   ```

2. Update the avatar logic (lines 123-137) to check `deletedSidekiqName`:
   ```typescript
   {/* Sidekiq avatar or pin indicator */}
   {thread.sidekiq ? (
     <SidekiqAvatar
       name={thread.sidekiq.name}
       avatar={thread.sidekiq.avatar}
       size="sm"
       className="size-5 shrink-0"
     />
   ) : thread.deletedSidekiqName ? (
     // Sidekiq was deleted - show placeholder
     <div className="bg-muted text-muted-foreground flex size-5 shrink-0 items-center justify-center rounded-full text-[10px]">
       ?
     </div>
   ) : thread.isPinned ? (
     <Pin className="text-muted-foreground h-3 w-3 shrink-0" />
   ) : null}
   ```

3. Update the subtitle logic (lines 152-161) to use `deletedSidekiqName`:
   ```typescript
   {/* Sidekiq subtitle */}
   {thread.sidekiq ? (
     <span className="text-muted-foreground block truncate text-xs">
       with {thread.sidekiq.name}
     </span>
   ) : thread.deletedSidekiqName ? (
     <span className="text-muted-foreground/60 block truncate text-xs italic">
       [Sidekiq deleted]
     </span>
   ) : null}
   ```

4. Remove the old dead code checking `thread.sidekiqId && !thread.sidekiq` since we now use `deletedSidekiqName`.
  </action>
  <verify>
1. TypeScript compiles: `pnpm typecheck`
2. Manual test: Thread that had Sidekiq deleted shows "?" avatar and "[Sidekiq deleted]" subtitle
3. Manual test: Normal thread (never had Sidekiq) shows pin icon if pinned, no icon otherwise
4. Manual test: Thread with active Sidekiq shows Sidekiq avatar and "with [name]" subtitle
  </verify>
  <done>Thread item correctly displays deleted Sidekiq indicator based on deletedSidekiqName field</done>
</task>

</tasks>

<verification>
1. **Schema:** `deletedSidekiqName` column exists in threads table
2. **Backend:** Sidekiq deletion preserves name in threads before delete
3. **UI:** Thread list shows correct indicators for all three states:
   - Active Sidekiq: avatar + "with [name]"
   - Deleted Sidekiq: "?" + "[Sidekiq deleted]"
   - No Sidekiq: pin icon (if pinned) or nothing
4. **No regressions:** Normal chat functionality unaffected
</verification>

<success_criteria>
- Deleting a Sidekiq no longer causes threads to lose their Sidekiq context
- Thread list clearly indicates when a Sidekiq was deleted
- All three thread states display correctly
- TypeScript compiles without errors
- Database migration applied cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidekiq-chat-integration/07-07-SUMMARY.md`
</output>
