---
phase: 07-sidekiq-chat-integration
plan: 04
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - sidekiq-webapp/src/components/thread/thread-item.tsx
  - sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx
  - sidekiq-webapp/src/lib/date-grouping.ts
autonomous: true

must_haves:
  truths:
    - "Sidebar threads with Sidekiq show avatar icon"
    - "Sidebar threads with Sidekiq show subtitle 'with [Sidekiq name]'"
    - "Deleted Sidekiq threads show '[Sidekiq deleted]' indicator"
  artifacts:
    - path: "sidekiq-webapp/src/components/thread/thread-item.tsx"
      provides: "Thread item with Sidekiq visual indicators"
      contains: "sidekiq"
    - path: "sidekiq-webapp/src/lib/date-grouping.ts"
      provides: "Updated Thread type with Sidekiq relation"
      contains: "sidekiq:"
  key_links:
    - from: "sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx"
      to: "sidekiq-webapp/src/components/thread/thread-item.tsx"
      via: "thread.sidekiq prop"
      pattern: "thread\\.sidekiq"
---

<objective>
Sidebar visual indicators for Sidekiq threads.

Purpose: Show visual distinction for Sidekiq-based threads in the sidebar with avatar icons and "with [name]" subtitle (requirement SIDE-06).
Output: Modified ThreadItem with Sidekiq display, updated Thread type, and deleted Sidekiq handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidekiq-chat-integration/07-CONTEXT.md
@.planning/phases/07-sidekiq-chat-integration/07-01-SUMMARY.md
@sidekiq-webapp/src/components/thread/thread-item.tsx
@sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx
@sidekiq-webapp/src/lib/date-grouping.ts
@sidekiq-webapp/src/components/sidekiq/sidekiq-avatar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Thread type to include Sidekiq relation</name>
  <files>sidekiq-webapp/src/lib/date-grouping.ts</files>
  <action>
Update the Thread interface to include optional Sidekiq relation:

1. Import SidekiqAvatar type:
   ```typescript
   import type { SidekiqAvatar } from "@sidekiq/server/db/schema";
   ```

2. Extend Thread interface:
   ```typescript
   export interface Thread {
     id: string;
     title: string | null;
     isPinned: boolean;
     isArchived: boolean;
     lastActivityAt: Date;
     messageCount: number;
     sidekiqId: string | null;  // ADD
     /** Related Sidekiq data (null if regular thread or Sidekiq deleted) */
     sidekiq?: {
       id: string;
       name: string;
       avatar: SidekiqAvatar;
     } | null;  // ADD
   }
   ```

This matches the return type from thread.list query updated in 07-01.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify types align</verify>
  <done>Thread type includes sidekiqId and sidekiq relation fields</done>
</task>

<task type="auto">
  <name>Task 2: Add Sidekiq indicators to ThreadItem component</name>
  <files>sidekiq-webapp/src/components/thread/thread-item.tsx</files>
  <action>
Extend ThreadItem to show Sidekiq avatar and subtitle:

1. Import SidekiqAvatar component:
   ```typescript
   import { SidekiqAvatar } from "@sidekiq/components/sidekiq/sidekiq-avatar";
   import type { SidekiqAvatar as SidekiqAvatarType } from "@sidekiq/server/db/schema";
   ```

2. Update Thread interface in the file to match:
   ```typescript
   interface Thread {
     id: string;
     title: string | null;
     isPinned: boolean;
     isArchived: boolean;
     lastActivityAt: Date;
     messageCount: number;
     sidekiqId?: string | null;
     sidekiq?: {
       id: string;
       name: string;
       avatar: SidekiqAvatarType;
     } | null;
   }
   ```

3. Modify the render to show Sidekiq indicators:
   ```typescript
   {/* Sidekiq avatar (shown instead of pin for Sidekiq threads) */}
   {thread.sidekiq ? (
     <SidekiqAvatar
       name={thread.sidekiq.name}
       avatar={thread.sidekiq.avatar}
       size="sm"
       className="size-5 shrink-0"
     />
   ) : thread.sidekiqId && !thread.sidekiq ? (
     // Sidekiq was deleted - show placeholder
     <div className="bg-muted text-muted-foreground flex size-5 shrink-0 items-center justify-center rounded-full text-[10px]">
       ?
     </div>
   ) : thread.isPinned ? (
     <Pin className="text-muted-foreground h-3 w-3 shrink-0" />
   ) : null}
   ```

4. Add subtitle for Sidekiq name below the title:
   ```typescript
   <div className="min-w-0 flex-1">
     {isRenaming ? (
       <RenameThreadInput ... />
     ) : (
       <>
         <span className="block truncate text-sm">
           {thread.title ?? "New conversation"}
         </span>
         {/* Sidekiq subtitle */}
         {thread.sidekiq ? (
           <span className="text-muted-foreground block truncate text-xs">
             with {thread.sidekiq.name}
           </span>
         ) : thread.sidekiqId && !thread.sidekiq ? (
           <span className="text-muted-foreground/60 block truncate text-xs italic">
             [Sidekiq deleted]
           </span>
         ) : null}
       </>
     )}
   </div>
   ```

5. Adjust padding/layout if needed to accommodate the subtitle.
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Manually verify Sidekiq threads show avatar and subtitle in sidebar
3. Verify threads with deleted Sidekiq show placeholder
  </verify>
  <done>ThreadItem displays Sidekiq avatar, subtitle, and handles deleted Sidekiq gracefully</done>
</task>

<task type="auto">
  <name>Task 3: Update SidebarThreadList to pass Sidekiq data</name>
  <files>sidekiq-webapp/src/components/sidebar/sidebar-thread-list.tsx</files>
  <action>
Ensure sidebar thread list properly handles Sidekiq relation data:

1. The Thread type import from date-grouping.ts should now include sidekiq fields (from Task 1)

2. Verify VirtualItem type properly includes thread with sidekiq:
   ```typescript
   type VirtualItem =
     | { type: "header"; group: DateGroup }
     | { type: "thread"; thread: Thread; highlightedTitle?: ReactNode };
   ```

3. ThreadItem should receive the full thread object including sidekiq - verify no filtering happens that would strip the sidekiq field

4. Update any type casts or explicit typing that might exclude sidekiq fields

5. The threadsQuery.data from api.thread.list should now include sidekiq relation - verify types match

NOTE: Most of the work here is ensuring types align. The actual data flow (ThreadItem receiving thread object) should already work.
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Verify no TypeScript errors about sidekiq field
3. Sidebar displays Sidekiq indicators on threads
  </verify>
  <done>SidebarThreadList properly types and passes Sidekiq relation data to ThreadItem</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm tsc --noEmit`
2. Sidekiq threads in sidebar show avatar icon
3. Sidekiq threads show "with [name]" subtitle
4. Threads with deleted Sidekiq show "[Sidekiq deleted]" gracefully
5. Regular threads unchanged (no Sidekiq indicators)
</verification>

<success_criteria>
- Thread type updated to include Sidekiq relation
- ThreadItem displays Sidekiq avatar and name subtitle
- Deleted Sidekiq handled gracefully with placeholder indicator
- SIDE-06 requirement fulfilled: visual indicator for Sidekiq threads
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidekiq-chat-integration/07-04-SUMMARY.md`
</output>
