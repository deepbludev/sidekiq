---
phase: 07-sidekiq-chat-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - sidekiq-webapp/src/lib/validations/chat.ts
  - sidekiq-webapp/src/app/api/chat/route.ts
  - sidekiq-webapp/src/server/api/routers/thread.ts
autonomous: true

must_haves:
  truths:
    - "Sidekiq instructions are prepended as system message to AI requests"
    - "Thread.sidekiqId is populated when creating thread with Sidekiq"
    - "Thread list includes Sidekiq relation data for sidebar display"
  artifacts:
    - path: "sidekiq-webapp/src/lib/validations/chat.ts"
      provides: "sidekiqId validation in chat request schema"
      contains: "sidekiqId: z.string().optional()"
    - path: "sidekiq-webapp/src/app/api/chat/route.ts"
      provides: "Server-side system message injection"
      contains: "sidekiq?.instructions"
    - path: "sidekiq-webapp/src/server/api/routers/thread.ts"
      provides: "Thread list with sidekiq relation"
      contains: "with: { sidekiq:"
  key_links:
    - from: "sidekiq-webapp/src/app/api/chat/route.ts"
      to: "sidekiq-webapp/src/server/db/schema.ts"
      via: "Drizzle query for sidekiq instructions"
      pattern: "db\\.query\\.sidekiqs"
---

<objective>
Backend foundation for Sidekiq chat integration.

Purpose: Enable the chat API to accept sidekiqId, inject Sidekiq instructions as system messages, and include Sidekiq data in thread queries for sidebar display.
Output: Modified chat API route with system message injection, extended chat validation schema, and thread list with Sidekiq relation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidekiq-chat-integration/07-RESEARCH.md
@sidekiq-webapp/src/app/api/chat/route.ts
@sidekiq-webapp/src/lib/validations/chat.ts
@sidekiq-webapp/src/server/api/routers/thread.ts
@sidekiq-webapp/src/server/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend chat request schema with sidekiqId</name>
  <files>sidekiq-webapp/src/lib/validations/chat.ts</files>
  <action>
Add sidekiqId field to chatRequestSchema:
- Add `sidekiqId: z.string().optional()` after the model field
- Update the ChatRequest type export (inferred automatically from schema)
- Add JSDoc comment explaining sidekiqId is for new threads only (ignored for existing threads)

The sidekiqId is optional because:
1. Regular chats don't have a Sidekiq
2. Existing threads already have sidekiqId stored in database
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify schema compiles without errors</verify>
  <done>chatRequestSchema includes sidekiqId field with proper validation</done>
</task>

<task type="auto">
  <name>Task 2: Implement server-side system message injection in chat API</name>
  <files>sidekiq-webapp/src/app/api/chat/route.ts</files>
  <action>
Modify the POST handler to inject Sidekiq instructions as system message:

1. Import sidekiqs table from schema
2. Extract sidekiqId from parseResult.data
3. After thread creation/verification, look up Sidekiq instructions:
   - For NEW threads: Use sidekiqId from request body, store in thread
   - For EXISTING threads: Use thread.sidekiqId from database
4. Modify thread INSERT to include sidekiqId
5. Before calling streamText, build messages with system message:
   ```typescript
   let systemMessage: string | null = null;
   // Determine effective sidekiqId (from request for new, from thread for existing)
   const effectiveSidekiqId = isNewThread ? sidekiqId : thread.sidekiqId;
   if (effectiveSidekiqId) {
     const sidekiq = await db.query.sidekiqs.findFirst({
       where: eq(sidekiqs.id, effectiveSidekiqId),
       columns: { instructions: true },
     });
     systemMessage = sidekiq?.instructions ?? null;
   }

   const modelMessages = await convertToModelMessages(uiMessages);
   const messagesWithSystem = systemMessage
     ? [{ role: 'system' as const, content: systemMessage }, ...modelMessages]
     : modelMessages;
   ```
6. Pass messagesWithSystem to streamText instead of modelMessages
7. After creating new thread with Sidekiq, update Sidekiq stats:
   - Set lastUsedAt to current date
   - Increment threadCount using sql`${sidekiqs.threadCount} + 1`
8. Verify sidekiq ownership matches user (security check) before using sidekiqId

IMPORTANT: System message is NOT stored in messages table - it's only prepended at runtime. This ensures:
- Sidekiq instruction updates apply to all future messages
- Message history stays clean
- No duplicate data storage
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Run `pnpm test` to verify existing tests pass
3. Manually test with curl (if dev server running):
   - Create thread with sidekiqId should include system message
   - Existing Sidekiq thread should inject instructions on resume
  </verify>
  <done>
- Chat API accepts sidekiqId for new threads
- System message is prepended to AI requests when Sidekiq is active
- Sidekiq stats (lastUsedAt, threadCount) are updated on new thread creation
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend thread list query with Sidekiq relation</name>
  <files>sidekiq-webapp/src/server/api/routers/thread.ts</files>
  <action>
Modify thread.list query to include Sidekiq relation data:

1. Add sidekiqId to the columns being selected
2. Add `with: { sidekiq: { columns: { id: true, name: true, avatar: true } } }` to include related Sidekiq data
3. The relation is already defined in schema.ts (threadRelations)

The query should look like:
```typescript
const result = await ctx.db.query.threads.findMany({
  where: ...,
  orderBy: ...,
  columns: {
    id: true,
    title: true,
    isPinned: true,
    isArchived: true,
    lastActivityAt: true,
    messageCount: true,
    sidekiqId: true,  // ADD THIS
  },
  with: {
    sidekiq: {
      columns: {
        id: true,
        name: true,
        avatar: true,
      },
    },
  },
});
```

This enables the sidebar to:
- Show Sidekiq avatar on thread items
- Display "with [Sidekiq name]" subtitle
- Filter threads by Sidekiq
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Run `pnpm test` to verify tests pass
3. Check that the return type now includes sidekiq relation
  </verify>
  <done>Thread list query includes sidekiqId column and sidekiq relation with id, name, and avatar</done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm tsc --noEmit`
2. All tests pass: `pnpm test`
3. Chat API schema accepts sidekiqId
4. Thread list includes Sidekiq relation data
</verification>

<success_criteria>
- Chat request schema validates sidekiqId as optional string
- New threads created with Sidekiq have sidekiqId stored
- Sidekiq instructions are prepended as system message (server-side)
- Thread list includes Sidekiq relation for sidebar display
- Existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidekiq-chat-integration/07-01-SUMMARY.md`
</output>
