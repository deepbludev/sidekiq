---
phase: 07-sidekiq-chat-integration
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - sidekiq-webapp/src/components/sidekiq/sidekiq-indicator.tsx
  - sidekiq-webapp/src/components/chat/chat-header.tsx
  - sidekiq-webapp/src/components/chat/chat-input.tsx
  - sidekiq-webapp/src/components/chat/chat-interface.tsx
autonomous: true

must_haves:
  truths:
    - "Chat header shows Sidekiq avatar and name when active"
    - "Input area shows Sidekiq indicator badge when active"
    - "Clicking header indicator opens popover with Sidekiq details"
  artifacts:
    - path: "sidekiq-webapp/src/components/sidekiq/sidekiq-indicator.tsx"
      provides: "Reusable Sidekiq indicator component"
      exports: ["SidekiqIndicator"]
    - path: "sidekiq-webapp/src/components/chat/chat-header.tsx"
      provides: "Chat header with Sidekiq display"
      contains: "SidekiqIndicator"
    - path: "sidekiq-webapp/src/components/chat/chat-input.tsx"
      provides: "Input area with Sidekiq badge"
      contains: "sidekiq"
  key_links:
    - from: "sidekiq-webapp/src/components/chat/chat-interface.tsx"
      to: "sidekiq-webapp/src/components/chat/chat-header.tsx"
      via: "sidekiq prop"
      pattern: "sidekiq=\\{sidekiq\\}"
---

<objective>
Active Sidekiq UI indicators in chat header and input area.

Purpose: Clearly show users which Sidekiq is active in the conversation with indicators in both the header and near the input area.
Output: New SidekiqIndicator component, chat header with Sidekiq display, and input area badge.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-sidekiq-chat-integration/07-CONTEXT.md
@.planning/phases/07-sidekiq-chat-integration/07-02-SUMMARY.md
@sidekiq-webapp/src/components/sidekiq/sidekiq-avatar.tsx
@sidekiq-webapp/src/components/chat/chat-interface.tsx
@sidekiq-webapp/src/components/chat/chat-input.tsx
@sidekiq-webapp/src/components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reusable SidekiqIndicator component</name>
  <files>sidekiq-webapp/src/components/sidekiq/sidekiq-indicator.tsx</files>
  <action>
Create a shared component for displaying Sidekiq avatar + name:

```typescript
"use client";

import { SidekiqAvatar } from "./sidekiq-avatar";
import type { SidekiqAvatar as SidekiqAvatarType } from "@sidekiq/server/db/schema";
import { cn } from "@sidekiq/lib/utils";

interface SidekiqIndicatorProps {
  sidekiq: {
    id: string;
    name: string;
    avatar: SidekiqAvatarType;
    description?: string | null;
  };
  /** Show description below name */
  showDescription?: boolean;
  /** Avatar size */
  size?: "sm" | "md" | "lg";
  /** Additional classes */
  className?: string;
  /** Click handler (for making it interactive) */
  onClick?: () => void;
}

/**
 * Displays a Sidekiq's avatar and name.
 * Used in chat header, input area badge, and sidebar.
 *
 * @example
 * ```tsx
 * <SidekiqIndicator
 *   sidekiq={sidekiq}
 *   size="sm"
 *   onClick={() => setPopoverOpen(true)}
 * />
 * ```
 */
export function SidekiqIndicator({
  sidekiq,
  showDescription = false,
  size = "md",
  className,
  onClick,
}: SidekiqIndicatorProps) {
  const Wrapper = onClick ? "button" : "div";

  return (
    <Wrapper
      onClick={onClick}
      className={cn(
        "flex items-center gap-2",
        onClick && "hover:bg-accent/50 rounded-md px-2 py-1 transition-colors",
        className
      )}
    >
      <SidekiqAvatar name={sidekiq.name} avatar={sidekiq.avatar} size={size} />
      <div className="min-w-0 text-left">
        <span className="text-foreground block truncate text-sm font-medium">
          {sidekiq.name}
        </span>
        {showDescription && sidekiq.description && (
          <p className="text-muted-foreground truncate text-xs">
            {sidekiq.description}
          </p>
        )}
      </div>
    </Wrapper>
  );
}
```

Export from index file if there is one for sidekiq components.
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify component compiles</verify>
  <done>SidekiqIndicator component created with avatar, name, optional description display</done>
</task>

<task type="auto">
  <name>Task 2: Create ChatHeader component with Sidekiq display</name>
  <files>sidekiq-webapp/src/components/chat/chat-header.tsx</files>
  <action>
Create ChatHeader component that shows thread title or Sidekiq indicator:

```typescript
"use client";

import Link from "next/link";
import { ChevronRight } from "lucide-react";
import type { SidekiqAvatar } from "@sidekiq/server/db/schema";
import { SidekiqIndicator } from "@sidekiq/components/sidekiq/sidekiq-indicator";
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from "@sidekiq/components/ui/popover";
import { Button } from "@sidekiq/components/ui/button";

interface ChatHeaderProps {
  /** Thread title (null for new threads) */
  title?: string | null;
  /** Active Sidekiq (null for regular chats) */
  sidekiq?: {
    id: string;
    name: string;
    description: string | null;
    avatar: SidekiqAvatar;
  } | null;
}

/**
 * Chat header showing thread title and/or active Sidekiq.
 *
 * - Regular chat: Shows thread title or "New Chat"
 * - Sidekiq chat: Shows Sidekiq indicator with popover for details
 */
export function ChatHeader({ title, sidekiq }: ChatHeaderProps) {
  if (!sidekiq) {
    // Regular chat - just show title
    return (
      <div className="border-b px-4 py-3">
        <h1 className="text-foreground truncate text-sm font-medium">
          {title ?? "New Chat"}
        </h1>
      </div>
    );
  }

  // Sidekiq chat - show indicator with popover
  return (
    <div className="border-b px-4 py-3">
      <div className="flex items-center gap-2">
        <Popover>
          <PopoverTrigger asChild>
            <button className="hover:bg-accent/50 -mx-2 rounded-md px-2 py-1 transition-colors">
              <SidekiqIndicator sidekiq={sidekiq} size="sm" />
            </button>
          </PopoverTrigger>
          <PopoverContent align="start" className="w-72">
            <div className="space-y-3">
              <SidekiqIndicator sidekiq={sidekiq} size="md" showDescription />
              <div className="flex justify-end">
                <Button variant="outline" size="sm" asChild>
                  <Link href={`/sidekiqs/${sidekiq.id}/edit`}>
                    Edit Sidekiq
                    <ChevronRight className="ml-1 h-3 w-3" />
                  </Link>
                </Button>
              </div>
            </div>
          </PopoverContent>
        </Popover>
        {title && (
          <>
            <span className="text-muted-foreground">/</span>
            <span className="text-muted-foreground truncate text-sm">
              {title}
            </span>
          </>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>Run `pnpm tsc --noEmit` to verify types</verify>
  <done>ChatHeader component created with Sidekiq popover and edit link</done>
</task>

<task type="auto">
  <name>Task 3: Add Sidekiq badge to ChatInput and integrate header</name>
  <files>
sidekiq-webapp/src/components/chat/chat-input.tsx
sidekiq-webapp/src/components/chat/chat-interface.tsx
  </files>
  <action>
Part A: Extend ChatInput with optional Sidekiq badge:

1. Add sidekiq prop to ChatInputProps:
   ```typescript
   interface ChatInputProps {
     // ... existing props
     sidekiq?: {
       name: string;
       avatar: SidekiqAvatar;
     } | null;
   }
   ```

2. Render small badge above or beside the input when Sidekiq is active:
   ```typescript
   {sidekiq && (
     <div className="mb-2 flex items-center gap-1.5">
       <SidekiqAvatar name={sidekiq.name} avatar={sidekiq.avatar} size="sm" className="size-5" />
       <span className="text-muted-foreground text-xs">
         Chatting with <span className="text-foreground font-medium">{sidekiq.name}</span>
       </span>
     </div>
   )}
   ```

Part B: Integrate ChatHeader into ChatInterface:

1. Import ChatHeader
2. Add ChatHeader at the top of the chat interface (before message area):
   ```typescript
   return (
     <div className="relative flex h-full flex-col">
       <ChatHeader title={currentTitle} sidekiq={sidekiq} />
       {/* Message area */}
       <div ref={scrollContainerRef} ... >
         ...
       </div>
       ...
     </div>
   );
   ```

3. Pass sidekiq prop to ChatInput
  </action>
  <verify>
1. Run `pnpm tsc --noEmit` for type checking
2. Manually verify header shows Sidekiq when active
3. Verify input area shows Sidekiq badge
  </verify>
  <done>
- ChatInput shows Sidekiq badge when active
- ChatInterface includes ChatHeader with Sidekiq display
- Both indicators visible in Sidekiq chats
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `pnpm tsc --noEmit`
2. Chat header shows Sidekiq indicator when active
3. Clicking header indicator opens popover with details and edit link
4. Input area shows Sidekiq badge
5. Regular chats show only thread title (no Sidekiq UI)
</verification>

<success_criteria>
- SidekiqIndicator component is reusable across chat header, input, sidebar
- Chat header clearly shows which Sidekiq is active
- Popover provides quick access to Sidekiq details and edit page
- Input area badge confirms Sidekiq context to user
</success_criteria>

<output>
After completion, create `.planning/phases/07-sidekiq-chat-integration/07-03-SUMMARY.md`
</output>
